<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- OTPAuth library for TOTP (2FA) -->
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9.2.1/dist/otpauth.umd.min.js"></script>
    <!-- QRCode library for generating QR codes -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- Google Identity Services for OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --accent: #0ea5e9;
            --accent-dark: #0284c7;
            --background: #f1f5f9;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

            /* Additional variables for 2FA and Cloud Sync */
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8fafc;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;

            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-7: 1.75rem;
            --space-8: 2rem;

            /* Border radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: all 0.2s ease;

            /* Status colors */
            --success: #10b981;
            --success-dark: #059669;
            --success-bg: #dcfce7;
            --success-border: #86efac;

            --danger: #ef4444;
            --danger-dark: #dc2626;

            --warning: #f59e0b;
            --warning-dark: #d97706;
            --warning-bg: #fef3c7;
            --warning-border: #fcd34d;

            --info: #3b82f6;
            --info-bg: #dbeafe;
            --info-border: #93c5fd;

            --gray-100: #f3f4f6;
            --gray-500: #6b7280;

            /* Background variants */
            --bg-hover: rgba(0, 0, 0, 0.04);

            /* Fonts */
            --font-mono: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo-container {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .logo-placeholder {
            font-size: 2rem;
            color: var(--primary);
        }

        .school-info h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .school-info p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .datetime {
            text-align: right;
            padding-right: 1rem;
            border-right: 1px solid rgba(255,255,255,0.3);
        }

        .datetime .time {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .datetime .date {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* Quick Links Grid */
        .quick-links-section {
            margin-bottom: 2.5rem;
        }

        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.25rem;
        }

        .quick-link-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            text-decoration: none;
            color: var(--text-primary);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 2px solid transparent;
            min-height: 140px;
            justify-content: center;
        }

        .quick-link-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .quick-link-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .quick-link-card:nth-child(6n+1) .quick-link-icon { background: #dbeafe; color: #2563eb; }
        .quick-link-card:nth-child(6n+2) .quick-link-icon { background: #dcfce7; color: #16a34a; }
        .quick-link-card:nth-child(6n+3) .quick-link-icon { background: #fef3c7; color: #d97706; }
        .quick-link-card:nth-child(6n+4) .quick-link-icon { background: #fce7f3; color: #db2777; }
        .quick-link-card:nth-child(6n+5) .quick-link-icon { background: #e0e7ff; color: #4f46e5; }
        .quick-link-card:nth-child(6n+6) .quick-link-icon { background: #ccfbf1; color: #0d9488; }

        .quick-link-title {
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.3;
        }

        /* Main Links Section */
        .main-links-section {
            margin-bottom: 2.5rem;
        }

        .main-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .main-link-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            text-decoration: none;
            color: var(--text-primary);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            border-left: 4px solid var(--primary);
        }

        .main-link-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .main-link-card:nth-child(4n+1) { border-left-color: #2563eb; }
        .main-link-card:nth-child(4n+2) { border-left-color: #10b981; }
        .main-link-card:nth-child(4n+3) { border-left-color: #f59e0b; }
        .main-link-card:nth-child(4n+4) { border-left-color: #8b5cf6; }

        .main-link-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            flex-shrink: 0;
        }

        .main-link-card:nth-child(4n+1) .main-link-icon { background: #dbeafe; color: #2563eb; }
        .main-link-card:nth-child(4n+2) .main-link-icon { background: #dcfce7; color: #10b981; }
        .main-link-card:nth-child(4n+3) .main-link-icon { background: #fef3c7; color: #f59e0b; }
        .main-link-card:nth-child(4n+4) .main-link-icon { background: #ede9fe; color: #8b5cf6; }

        .main-link-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .main-link-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary);
            color: white;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
        }

        .settings-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .settings-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .settings-tab.active {
            background: var(--primary);
            color: white;
        }

        .settings-tab:hover:not(.active) {
            background: var(--background);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Logo Settings */
        .logo-settings {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .current-logo-preview {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--background);
            border-radius: 12px;
        }

        .preview-box {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            overflow: hidden;
        }

        .preview-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .logo-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-input-label:hover {
            background: var(--primary-dark);
        }

        .remove-logo-btn {
            padding: 0.75rem 1.25rem;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .remove-logo-btn:hover {
            background: #fecaca;
        }

        /* School Name Setting */
        .school-name-setting {
            padding: 1.5rem;
            background: var(--background);
            border-radius: 12px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Button Settings */
        .button-settings-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .button-setting-item {
            padding: 1.25rem;
            background: var(--background);
            border-radius: 12px;
            display: grid;
            grid-template-columns: auto 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .button-setting-item .item-number {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            align-self: center;
        }

        .button-setting-item input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .button-setting-item input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .button-setting-item label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.35rem;
            color: var(--text-secondary);
        }

        .delete-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.2s;
            align-self: center;
        }

        .delete-btn:hover {
            background: #fecaca;
        }

        .add-button-btn {
            padding: 1rem;
            background: white;
            border: 2px dashed var(--border);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .add-button-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Modal Footer */
        .modal-footer {
            padding: 1.25rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background: var(--background);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--background);
        }

        .btn-primary {
            background: var(--primary);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
            }

            .header-right {
                flex-direction: column;
            }

            .datetime {
                border-right: none;
                padding-right: 0;
                text-align: center;
            }

            .button-setting-item {
                grid-template-columns: 1fr;
            }

            .button-setting-item .item-number {
                align-self: start;
            }

            .quick-links-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .main-links-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Icon set */
        .icon {
            font-style: normal;
        }

        /* Login Page Styles */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1rem;
        }

        .login-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
        }

        .login-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .login-form-group {
            position: relative;
        }

        .login-form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .login-form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            padding-left: 2.75rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--background);
        }

        .login-form-group input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        .login-form-group .input-icon {
            position: absolute;
            left: 1rem;
            top: 2.5rem;
            font-size: 1.1rem;
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 0.5rem;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.875rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .login-error.show {
            display: flex;
        }

        .dashboard-container {
            display: none;
        }

        .dashboard-container.visible {
            display: block;
        }

        .login-page.hidden {
            display: none;
        }

        /* Logout button */
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(220, 38, 38, 0.8);
            transform: translateY(-1px);
        }

        /* User display in header */
        .user-display {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-right: 1rem;
            border-right: 1px solid rgba(255,255,255,0.3);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .user-info {
            text-align: left;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-role {
            font-size: 0.75rem;
            opacity: 0.85;
        }

        /* User Settings Styles */
        .user-setting-item {
            padding: 1.25rem;
            background: var(--background);
            border-radius: 12px;
            display: grid;
            grid-template-columns: auto 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .user-setting-item.admin-user {
            border: 2px solid var(--primary);
        }

        .user-setting-item .item-number {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            align-self: center;
        }

        .user-setting-item input,
        .user-setting-item select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .user-setting-item input:focus,
        .user-setting-item select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .user-setting-item label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.35rem;
            color: var(--text-secondary);
        }

        .admin-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Hide settings button for non-admins */
        .settings-btn.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .user-setting-item {
                grid-template-columns: 1fr;
            }

            .user-display {
                border-right: none;
                padding-right: 0;
            }
        }

        /* ============================================
           Two-Factor Authentication (2FA) Styles
           ============================================ */
        .twofa-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .twofa-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .twofa-modal-header {
            text-align: center;
            margin-bottom: var(--space-6);
        }

        .twofa-modal-header h2 {
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .twofa-modal-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .twofa-qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: var(--space-6) 0;
            padding: var(--space-6);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
        }

        .twofa-qr-container canvas,
        .twofa-qr-container img {
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
        }

        .twofa-secret-key {
            font-family: var(--font-mono);
            background: var(--bg-secondary);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            letter-spacing: 2px;
            color: var(--text-primary);
            border: 1px dashed var(--border-medium);
            word-break: break-all;
            text-align: center;
        }

        .twofa-secret-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .twofa-single-input {
            width: 100%;
            padding: var(--space-4);
            text-align: center;
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: 8px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: var(--transition-fast);
        }

        .twofa-single-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .twofa-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            margin-top: var(--space-6);
        }

        .twofa-actions button {
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .twofa-btn-primary {
            background: var(--success);
            color: white;
            border: none;
        }

        .twofa-btn-primary:hover {
            background: var(--success-dark);
        }

        .twofa-btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-medium);
        }

        .twofa-btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .twofa-btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .twofa-btn-danger:hover {
            background: var(--danger-dark);
        }

        .twofa-backup-codes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-2);
            margin: var(--space-4) 0;
            padding: var(--space-4);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .twofa-backup-code {
            font-family: var(--font-mono);
            padding: var(--space-2);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .twofa-backup-code.used {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .twofa-warning {
            background: var(--warning-bg);
            border: 1px solid var(--warning-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            font-size: 0.875rem;
            color: var(--warning-dark);
        }

        .twofa-success {
            background: var(--success-bg);
            border: 1px solid var(--success-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            font-size: 0.875rem;
            color: var(--success-dark);
        }

        .twofa-status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .twofa-status-badge.enabled {
            background: var(--success-bg);
            color: var(--success);
        }

        .twofa-status-badge.disabled {
            background: var(--gray-100);
            color: var(--gray-500);
        }

        .twofa-login-step {
            text-align: center;
        }

        .twofa-login-step .login-subtitle {
            margin-bottom: var(--space-4);
        }

        .twofa-use-backup {
            margin-top: var(--space-4);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .twofa-use-backup a {
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
        }

        .twofa-use-backup a:hover {
            color: var(--accent-dark);
        }

        .twofa-setup-btn {
            margin-top: var(--space-2);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
        }

        .btn-success:hover {
            background: var(--success-dark);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            border: none;
        }

        .btn-warning:hover {
            background: var(--warning-dark);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: var(--danger-dark);
        }

        /* Input group for 2FA */
        .input-group {
            margin-bottom: var(--space-4);
        }

        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: var(--space-2);
            color: var(--text-primary);
        }

        .login-input {
            width: 100%;
            padding: var(--space-3);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: var(--transition-fast);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* ============================================
           Cloud Sync / Google Drive Styles
           ============================================ */
        .cloud-sync-container {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding-right: var(--space-4);
            border-right: 1px solid rgba(255,255,255,0.3);
        }

        .cloud-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.85rem;
        }

        .cloud-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-500);
        }

        .cloud-status-dot.connected {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
        }

        .cloud-status-dot.syncing {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .cloud-sync-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            transition: var(--transition-fast);
        }

        .cloud-sync-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .cloud-sync-btn.connect-btn {
            background: rgba(34, 197, 94, 0.3);
        }

        .cloud-sync-btn.connect-btn:hover {
            background: rgba(34, 197, 94, 0.5);
        }

        .cloud-dropdown {
            position: relative;
        }

        .cloud-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            overflow: hidden;
        }

        .cloud-dropdown-content.show {
            display: block;
        }

        .cloud-dropdown-item {
            padding: var(--space-3) var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.9rem;
        }

        .cloud-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .cloud-dropdown-item.danger {
            color: var(--danger);
        }

        .cloud-dropdown-item.danger:hover {
            background: #fef2f2;
        }

        .cloud-dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: var(--space-2) 0;
        }

        .last-sync-info {
            padding: var(--space-2) var(--space-4);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .spinning {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal styles for Google Auth */
        .google-auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .google-auth-modal.show, .google-auth-modal[style*="display: flex"] {
            display: flex;
        }

        .google-auth-modal .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
        }

        .modal-header {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        /* 2FA Section in Users Tab */
        #current2FAStatus {
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: 1px solid var(--border);
        }

        @media (max-width: 768px) {
            .cloud-sync-container {
                padding-right: 0;
                border-right: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo">üè´</div>
                <h1>School Dashboard</h1>
                <p>Sign in to access the dashboard</p>
            </div>
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-error" id="loginError">
                    <span>‚ö†Ô∏è</span>
                    <span id="loginErrorText">Invalid username or password</span>
                </div>

                <!-- Step 1: Username/Password -->
                <div id="loginStep1">
                    <div class="login-form-group">
                        <label for="username">Username</label>
                        <span class="input-icon">üë§</span>
                        <input type="text" id="username" name="username" placeholder="Enter your username" required autocomplete="username">
                    </div>
                    <div class="login-form-group">
                        <label for="password">Password</label>
                        <span class="input-icon">üîí</span>
                        <input type="password" id="password" name="password" placeholder="Enter your password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="login-btn">Sign In</button>
                </div>

                <!-- Step 2: 2FA Verification -->
                <div id="loginStep2FA" style="display: none;" class="twofa-login-step">
                    <p class="login-subtitle">Enter the 6-digit code from your authenticator app</p>

                    <div class="input-group">
                        <input type="text" id="login2FACode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000" autocomplete="one-time-code">
                    </div>

                    <button type="button" class="login-btn" onclick="verify2FALogin()">Verify Code</button>

                    <div class="twofa-use-backup">
                        <a onclick="showBackupCodeInput()">Use a backup code instead</a>
                    </div>

                    <div id="backupCodeSection" style="display: none; margin-top: var(--space-4);">
                        <div class="input-group">
                            <label>Backup Code</label>
                            <input type="text" id="loginBackupCode" class="login-input" placeholder="Enter backup code" style="text-transform: uppercase; letter-spacing: 2px;">
                        </div>
                        <button type="button" class="login-btn" onclick="verifyBackupCodeLogin()" style="background: var(--warning);">Use Backup Code</button>
                    </div>

                    <button type="button" class="login-btn" onclick="cancelTwoFALogin()" style="background: transparent; color: var(--text-secondary); border: 1px solid var(--border-medium); margin-top: var(--space-3);">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo-container" id="logoContainer">
                <span class="logo-placeholder">üè´</span>
            </div>
            <div class="school-info">
                <h1 id="schoolName">School Dashboard</h1>
                <p id="schoolTagline">Welcome to our learning portal</p>
            </div>
        </div>
        <div class="header-right">
            <div class="datetime">
                <div class="time" id="currentTime">00:00</div>
                <div class="date" id="currentDate">Loading...</div>
            </div>

            <!-- Cloud Sync Controls -->
            <div class="cloud-sync-container" id="cloudSyncContainer">
                <div class="cloud-status" id="cloudStatus">
                    <span class="cloud-status-dot" id="cloudStatusDot"></span>
                    <span id="cloudStatusText">Not connected</span>
                </div>

                <div id="cloudNotConnected">
                    <button class="cloud-sync-btn connect-btn" onclick="connectToGoogleDrive()">
                        <span>‚òÅÔ∏è</span>
                        <span>Connect Drive</span>
                    </button>
                </div>

                <div id="cloudConnected" style="display: none;">
                    <div class="cloud-dropdown">
                        <button class="cloud-sync-btn" onclick="toggleCloudMenu()">
                            <span id="cloudMenuIcon">‚òÅÔ∏è</span>
                            <span>Cloud</span>
                            <span style="font-size: 0.6rem;">‚ñº</span>
                        </button>
                        <div class="cloud-dropdown-content" id="cloudDropdownMenu">
                            <div class="cloud-dropdown-item" onclick="saveToCloud()">
                                <span>üíæ</span>
                                <span>Save to Cloud</span>
                            </div>
                            <div class="cloud-dropdown-item" onclick="syncFromCloud()">
                                <span>üîÑ</span>
                                <span>Sync from Cloud</span>
                            </div>
                            <div class="cloud-dropdown-item" onclick="browseBackupFiles()">
                                <span>üìÅ</span>
                                <span>Browse All Backups</span>
                            </div>
                            <div class="cloud-dropdown-divider"></div>
                            <div class="last-sync-info" id="lastSyncInfo">
                                Last sync: Never
                            </div>
                            <div class="last-sync-info" id="lastSavedByInfo" style="color: #6b7280; font-size: 0.7rem;">
                                Last saved by: --
                            </div>
                            <div class="cloud-dropdown-divider"></div>
                            <div class="cloud-dropdown-item danger" onclick="disconnectFromGoogleDrive()">
                                <span>üîå</span>
                                <span>Disconnect</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="user-display">
                <div class="user-avatar">üë§</div>
                <div class="user-info">
                    <div class="user-name" id="loggedInUserName">User</div>
                    <div class="user-role" id="loggedInUserRole">Role</div>
                </div>
            </div>
            <button class="settings-btn" onclick="openSettings()">
                <span>‚öôÔ∏è</span> Settings
            </button>
            <button class="logout-btn" onclick="handleLogout()">
                <span>üö™</span> Logout
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Quick Links Section -->
        <section class="quick-links-section">
            <h2 class="section-title">Quick Links</h2>
            <div class="quick-links-grid" id="quickLinksGrid">
                <!-- Quick links will be populated here -->
            </div>
        </section>

        <!-- Main Links Section -->
        <section class="main-links-section">
            <h2 class="section-title">Main Resources</h2>
            <div class="main-links-grid" id="mainLinksGrid">
                <!-- Main links will be populated here -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>¬© <span id="year"></span> School Dashboard. All rights reserved.</p>
    </footer>
    </div><!-- End Dashboard Container -->

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Dashboard Settings</h2>
                <button class="modal-close" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="settings-tab active" onclick="switchTab('general')">General</button>
                    <button class="settings-tab" onclick="switchTab('quickLinks')">Quick Links</button>
                    <button class="settings-tab" onclick="switchTab('mainLinks')">Main Links</button>
                    <button class="settings-tab" onclick="switchTab('users')">Users</button>
                </div>

                <!-- General Tab -->
                <div class="tab-content active" id="generalTab">
                    <div class="logo-settings">
                        <h3 style="margin-bottom: 1rem; font-size: 1rem;">School Logo</h3>
                        <div class="current-logo-preview">
                            <div class="preview-box" id="logoPreview">
                                <span style="font-size: 2rem; color: #94a3b8;">üñºÔ∏è</span>
                            </div>
                            <div class="logo-actions">
                                <div class="file-input-wrapper">
                                    <label class="file-input-label">
                                        üìÅ Upload Logo
                                        <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(event)">
                                    </label>
                                </div>
                                <button class="remove-logo-btn" onclick="removeLogo()">üóëÔ∏è Remove Logo</button>
                            </div>
                        </div>

                        <div class="school-name-setting">
                            <h3 style="margin-bottom: 1rem; font-size: 1rem;">School Information</h3>
                            <div class="form-group">
                                <label>School Name</label>
                                <input type="text" id="schoolNameInput" placeholder="Enter school name">
                            </div>
                            <div class="form-group">
                                <label>Tagline / Subtitle</label>
                                <input type="text" id="schoolTaglineInput" placeholder="Enter tagline or subtitle">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Links Tab -->
                <div class="tab-content" id="quickLinksTab">
                    <div class="button-settings-list" id="quickLinksSettings">
                        <!-- Quick link settings will be populated here -->
                    </div>
                    <button class="add-button-btn" onclick="addQuickLink()">
                        <span>‚ûï</span> Add Quick Link
                    </button>
                </div>

                <!-- Main Links Tab -->
                <div class="tab-content" id="mainLinksTab">
                    <div class="button-settings-list" id="mainLinksSettings">
                        <!-- Main link settings will be populated here -->
                    </div>
                    <button class="add-button-btn" onclick="addMainLink()">
                        <span>‚ûï</span> Add Main Link
                    </button>
                </div>

                <!-- Users Tab -->
                <div class="tab-content" id="usersTab">
                    <div class="button-settings-list" id="usersSettings">
                        <!-- User settings will be populated here -->
                    </div>
                    <button class="add-button-btn" onclick="addUser()">
                        <span>‚ûï</span> Add User
                    </button>

                    <!-- 2FA Section for Current User -->
                    <div id="current2FAStatus">
                        <h3 style="margin-bottom: var(--space-4); font-size: 1rem;">üîê Two-Factor Authentication</h3>
                        <!-- 2FA status will be populated here by render2FAStatus() -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- 2FA Setup Modal -->
    <div id="twofaSetupModal" class="twofa-modal-overlay" style="display: none;">
        <div class="twofa-modal">
            <div class="twofa-modal-header">
                <h2>Set Up Two-Factor Authentication</h2>
                <p>Scan the QR code with Google Authenticator or any TOTP app</p>
            </div>

            <div class="twofa-qr-container">
                <div id="twofaQRCode"></div>
                <div class="twofa-secret-label">Or enter this code manually:</div>
                <div class="twofa-secret-key" id="twofaSecretKey"></div>
            </div>

            <div class="twofa-warning">
                <strong>Important:</strong> Save the secret key in a safe place. You'll need it if you lose access to your authenticator app.
            </div>

            <div class="input-group" style="margin-top: var(--space-4);">
                <label>Enter the 6-digit code to verify setup:</label>
                <input type="text" id="twofaSetupCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000">
            </div>

            <div class="twofa-actions">
                <button type="button" class="twofa-btn-secondary" onclick="closeTwoFASetup()">Cancel</button>
                <button type="button" class="twofa-btn-primary" onclick="confirmTwoFASetup()">Enable 2FA</button>
            </div>
        </div>
    </div>

    <!-- 2FA Backup Codes Modal -->
    <div id="twofaBackupModal" class="twofa-modal-overlay" style="display: none;">
        <div class="twofa-modal">
            <div class="twofa-modal-header">
                <h2>Backup Codes</h2>
                <p>Save these codes in a secure location. Each code can only be used once.</p>
            </div>

            <div class="twofa-warning">
                <strong>Warning:</strong> These codes will only be shown once. Make sure to save them now!
            </div>

            <div class="twofa-backup-codes" id="twofaBackupCodes">
                <!-- Backup codes will be populated here -->
            </div>

            <div class="twofa-actions">
                <button type="button" class="twofa-btn-secondary" onclick="copyBackupCodes()">Copy Codes</button>
                <button type="button" class="twofa-btn-primary" onclick="closeBackupCodesModal()">I've Saved These Codes</button>
            </div>
        </div>
    </div>

    <!-- 2FA Disable Confirmation Modal -->
    <div id="twofaDisableModal" class="twofa-modal-overlay" style="display: none;">
        <div class="twofa-modal">
            <div class="twofa-modal-header">
                <h2>Disable Two-Factor Authentication</h2>
                <p>Enter your current 2FA code to confirm</p>
            </div>

            <div class="twofa-warning">
                <strong>Warning:</strong> Disabling 2FA will make your account less secure.
            </div>

            <div class="input-group" style="margin-top: var(--space-4);">
                <label>Enter 6-digit code from your authenticator:</label>
                <input type="text" id="twofaDisableCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000">
            </div>

            <div class="twofa-actions">
                <button type="button" class="twofa-btn-secondary" onclick="closeTwoFADisable()">Cancel</button>
                <button type="button" class="twofa-btn-danger" onclick="confirmTwoFADisable()">Disable 2FA</button>
            </div>
        </div>
    </div>

    <script>
        // Default admin user
        const defaultUsers = [
            {
                username: 'Cestisadmin',
                password: 'cestisadmin123$',
                displayName: 'System Administrator',
                role: 'Administrator',
                isAdmin: true
            }
        ];

        // Load users from localStorage or use defaults
        let users = JSON.parse(localStorage.getItem('dashboardUsers')) || defaultUsers;

        // Current logged in user (full object reference)
        let currentUser = null;

        // Temporary storage for 2FA login
        let pendingTwoFAUser = null;

        // Check if user is logged in
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            const loginPage = document.getElementById('loginPage');
            const dashboardContainer = document.getElementById('dashboardContainer');
            const settingsBtn = document.querySelector('.settings-btn');

            if (isLoggedIn) {
                loginPage.classList.add('hidden');
                dashboardContainer.classList.add('visible');
                updateUserDisplay();

                // Set currentUser from session or find in users array
                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (loggedInUser) {
                    currentUser = users.find(u => u.username.toLowerCase() === loggedInUser.username.toLowerCase()) || loggedInUser;
                }

                // Show/hide settings based on user role
                if (loggedInUser && loggedInUser.role === 'Administrator') {
                    settingsBtn.classList.remove('hidden');
                } else {
                    settingsBtn.classList.add('hidden');
                }
            } else {
                loginPage.classList.remove('hidden');
                dashboardContainer.classList.remove('visible');
                currentUser = null;
            }
        }

        // Update user display in header
        function updateUserDisplay() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (loggedInUser) {
                document.getElementById('loggedInUserName').textContent = loggedInUser.displayName;
                document.getElementById('loggedInUserRole').textContent = loggedInUser.role;
            }
        }

        // Handle login form submission (case-insensitive username)
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');

            // Find user with case-insensitive username match
            const user = users.find(u =>
                u.username.toLowerCase() === username.toLowerCase() &&
                u.password === password
            );

            if (user) {
                loginError.classList.remove('show');

                // Check if 2FA is enabled for this user
                if (user.twoFactorEnabled && user.twoFactorSecret) {
                    // Show 2FA step
                    pendingTwoFAUser = user;
                    document.getElementById('loginStep1').style.display = 'none';
                    document.getElementById('loginStep2FA').style.display = 'block';
                    document.getElementById('login2FACode').focus();
                } else {
                    // No 2FA, complete login directly
                    completeLogin(user);
                }
            } else {
                loginError.classList.add('show');
                document.getElementById('loginErrorText').textContent = 'Invalid username or password. Please try again.';
            }
        }

        // Complete the login process
        function completeLogin(user) {
            currentUser = user;
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('loggedInUser', JSON.stringify({
                username: user.username,
                displayName: user.displayName,
                role: user.role,
                isAdmin: user.isAdmin,
                twoFactorEnabled: user.twoFactorEnabled || false
            }));
            sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(user));

            // Reset login form
            pendingTwoFAUser = null;
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2FA').style.display = 'none';
            document.getElementById('backupCodeSection').style.display = 'none';
            document.getElementById('login2FACode').value = '';
            document.getElementById('loginBackupCode').value = '';

            checkAuth();
            showNotification('Welcome, ' + user.displayName + '!');
        }

        // Show login error message
        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            document.getElementById('loginErrorText').textContent = message;
            loginError.classList.add('show');
        }

        // Handle logout
        function handleLogout() {
            sessionStorage.removeItem('isLoggedIn');
            sessionStorage.removeItem('loggedInUser');
            checkAuth();
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.remove('show');
        }

        // User Management Functions
        function renderUsersSettings() {
            const container = document.getElementById('usersSettings');
            container.innerHTML = users.map((user, index) => `
                <div class="user-setting-item ${user.isAdmin ? 'admin-user' : ''}">
                    <div class="item-number">${index + 1}</div>
                    <div>
                        <label>Username${user.isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}</label>
                        <input type="text" value="${user.username}" onchange="updateUser(${index}, 'username', this.value)" ${user.isAdmin ? 'readonly style="background:#e2e8f0;cursor:not-allowed;"' : ''}>
                    </div>
                    <div>
                        <label>Display Name</label>
                        <input type="text" value="${user.displayName}" onchange="updateUser(${index}, 'displayName', this.value)" ${user.isAdmin ? 'readonly style="background:#e2e8f0;cursor:not-allowed;"' : ''}>
                    </div>
                    <div>
                        <label>Password</label>
                        <input type="${user.isAdmin ? 'text' : 'password'}" value="${user.isAdmin ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : user.password}" onchange="updateUser(${index}, 'password', this.value)" ${user.isAdmin ? 'readonly style="background:#e2e8f0;cursor:not-allowed;"' : ''}>
                    </div>
                    <div>
                        <label>Role</label>
                        <select onchange="updateUser(${index}, 'role', this.value)" ${user.isAdmin ? 'disabled style="background:#e2e8f0;cursor:not-allowed;"' : ''}>
                            <option value="User" ${user.role === 'User' ? 'selected' : ''}>User (View Only)</option>
                            <option value="Administrator" ${user.role === 'Administrator' ? 'selected' : ''}>Administrator (Full Access)</option>
                        </select>
                    </div>
                    <button class="delete-btn" onclick="deleteUser(${index})" ${user.isAdmin ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateUser(index, field, value) {
            // Prevent changing any admin fields
            if (users[index].isAdmin) {
                return;
            }
            users[index][field] = value;
        }

        function addUser() {
            users.push({
                username: 'newuser',
                password: 'password123',
                displayName: 'New User',
                role: 'User',
                isAdmin: false
            });
            renderUsersSettings();
        }

        function deleteUser(index) {
            // Cannot delete admin user
            if (users[index].isAdmin) {
                alert('Cannot delete the administrator account.');
                return;
            }
            if (users.length > 1) {
                users.splice(index, 1);
                renderUsersSettings();
            } else {
                alert('You must have at least one user.');
            }
        }

        // Default data
        const defaultQuickLinks = [
            { name: 'Student Portal', url: '#', icon: 'üë®‚Äçüéì' },
            { name: 'Teacher Portal', url: '#', icon: 'üë©‚Äçüè´' },
            { name: 'Library', url: '#', icon: 'üìö' },
            { name: 'Calendar', url: '#', icon: 'üìÖ' },
            { name: 'Announcements', url: '#', icon: 'üì¢' },
            { name: 'Grades', url: '#', icon: 'üìä' },
            { name: 'Attendance', url: '#', icon: '‚úÖ' },
            { name: 'Email', url: '#', icon: 'üìß' }
        ];

        const defaultMainLinks = [
            { name: 'Learning Management System', url: '#', description: 'Access courses and assignments', icon: 'üéì' },
            { name: 'School Website', url: '#', description: 'Official school information', icon: 'üåê' },
            { name: 'Parent Portal', url: '#', description: 'For parents and guardians', icon: 'üë™' },
            { name: 'IT Support', url: '#', description: 'Technical assistance', icon: 'üîß' },
            { name: 'Cafeteria Menu', url: '#', description: 'Weekly meal schedule', icon: 'üçΩÔ∏è' },
            { name: 'Sports & Activities', url: '#', description: 'Extracurricular programs', icon: '‚öΩ' }
        ];

        // Load data from localStorage or use defaults
        let quickLinks = JSON.parse(localStorage.getItem('quickLinks')) || defaultQuickLinks;
        let mainLinks = JSON.parse(localStorage.getItem('mainLinks')) || defaultMainLinks;
        let schoolSettings = JSON.parse(localStorage.getItem('schoolSettings')) || {
            name: 'School Dashboard',
            tagline: 'Welcome to our learning portal',
            logo: null
        };

        // Icons for new links
        const quickIcons = ['üì±', 'üíª', 'üìù', 'üîî', 'üìã', 'üéØ', 'üí°', 'üîç', 'üìå', '‚≠ê'];
        const mainIcons = ['üìö', 'üéì', 'üåü', 'üî¨', 'üé®', 'üé≠', 'üéµ', 'üèÜ', 'üåç', 'üí¨'];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            renderQuickLinks();
            renderMainLinks();
            loadSchoolSettings();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            document.getElementById('year').textContent = new Date().getFullYear();

            // Initialize cloud sync
            initializeCloudSync();

            // Initialize Google Auth after a short delay to ensure GIS library is loaded
            setTimeout(() => {
                initGoogleAuth();
            }, 500);

            // 2FA input event listeners
            const twoFAInputs = ['login2FACode', 'twofaSetupCode', 'twofaDisableCode'];
            twoFAInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // Only allow numeric input
                    input.addEventListener('input', function(e) {
                        this.value = this.value.replace(/[^0-9]/g, '');
                    });

                    // Handle Enter key
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (inputId === 'login2FACode') verify2FALogin();
                            else if (inputId === 'twofaSetupCode') confirmTwoFASetup();
                            else if (inputId === 'twofaDisableCode') confirmTwoFADisable();
                        }
                    });
                }
            });

            // Backup code input - allow alphanumeric, convert to uppercase
            const backupCodeInput = document.getElementById('loginBackupCode');
            if (backupCodeInput) {
                backupCodeInput.addEventListener('input', function(e) {
                    this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                });
                backupCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        verifyBackupCodeLogin();
                    }
                });
            }
        });

        // Render Quick Links
        function renderQuickLinks() {
            const grid = document.getElementById('quickLinksGrid');
            grid.innerHTML = quickLinks.map((link, index) => {
                const hasValidUrl = link.url && link.url !== '#' && link.url.trim() !== '';
                const href = hasValidUrl ? link.url : 'javascript:void(0)';
                const target = hasValidUrl ? 'target="_blank"' : '';
                return `
                <a href="${href}" class="quick-link-card" ${target}>
                    <div class="quick-link-icon">${link.icon || 'üîó'}</div>
                    <div class="quick-link-title">${link.name}</div>
                </a>
            `;
            }).join('');
        }

        // Render Main Links
        function renderMainLinks() {
            const grid = document.getElementById('mainLinksGrid');
            grid.innerHTML = mainLinks.map((link, index) => {
                const hasValidUrl = link.url && link.url !== '#' && link.url.trim() !== '';
                const href = hasValidUrl ? link.url : 'javascript:void(0)';
                const target = hasValidUrl ? 'target="_blank"' : '';
                return `
                <a href="${href}" class="main-link-card" ${target}>
                    <div class="main-link-icon">${link.icon || 'üîó'}</div>
                    <div class="main-link-content">
                        <h3>${link.name}</h3>
                        <p>${link.description || 'Click to open'}</p>
                    </div>
                </a>
            `;
            }).join('');
        }

        // Load School Settings
        function loadSchoolSettings() {
            document.getElementById('schoolName').textContent = schoolSettings.name;
            document.getElementById('schoolTagline').textContent = schoolSettings.tagline;
            
            const logoContainer = document.getElementById('logoContainer');
            if (schoolSettings.logo) {
                logoContainer.innerHTML = `<img src="${schoolSettings.logo}" alt="School Logo">`;
            } else {
                logoContainer.innerHTML = '<span class="logo-placeholder">üè´</span>';
            }
        }

        // Update Date/Time
        function updateDateTime() {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', timeOptions);
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', dateOptions);
        }

        // Settings Modal
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('schoolNameInput').value = schoolSettings.name;
            document.getElementById('schoolTaglineInput').value = schoolSettings.tagline;

            // Update logo preview
            const preview = document.getElementById('logoPreview');
            if (schoolSettings.logo) {
                preview.innerHTML = `<img src="${schoolSettings.logo}" alt="Logo Preview">`;
            } else {
                preview.innerHTML = '<span style="font-size: 2rem; color: #94a3b8;">üñºÔ∏è</span>';
            }

            renderQuickLinksSettings();
            renderMainLinksSettings();
            renderUsersSettings();
            render2FAStatus();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Logo handling
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    schoolSettings.logo = e.target.result;
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Logo Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            schoolSettings.logo = null;
            document.getElementById('logoPreview').innerHTML = '<span style="font-size: 2rem; color: #94a3b8;">üñºÔ∏è</span>';
            document.getElementById('logoInput').value = '';
        }

        // Quick Links Settings
        function renderQuickLinksSettings() {
            const container = document.getElementById('quickLinksSettings');
            container.innerHTML = quickLinks.map((link, index) => `
                <div class="button-setting-item">
                    <div class="item-number">${index + 1}</div>
                    <div>
                        <label>Button Name</label>
                        <input type="text" value="${link.name}" onchange="updateQuickLink(${index}, 'name', this.value)">
                    </div>
                    <div>
                        <label>URL</label>
                        <input type="text" value="${link.url}" onchange="updateQuickLink(${index}, 'url', this.value)">
                    </div>
                    <button class="delete-btn" onclick="deleteQuickLink(${index})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateQuickLink(index, field, value) {
            quickLinks[index][field] = value;
        }

        function addQuickLink() {
            const randomIcon = quickIcons[Math.floor(Math.random() * quickIcons.length)];
            quickLinks.push({ name: 'New Link', url: '#', icon: randomIcon });
            renderQuickLinksSettings();
        }

        function deleteQuickLink(index) {
            if (quickLinks.length > 1) {
                quickLinks.splice(index, 1);
                renderQuickLinksSettings();
            } else {
                alert('You must have at least one quick link.');
            }
        }

        // Main Links Settings
        function renderMainLinksSettings() {
            const container = document.getElementById('mainLinksSettings');
            container.innerHTML = mainLinks.map((link, index) => `
                <div class="button-setting-item">
                    <div class="item-number">${index + 1}</div>
                    <div>
                        <label>Button Name</label>
                        <input type="text" value="${link.name}" onchange="updateMainLink(${index}, 'name', this.value)">
                    </div>
                    <div>
                        <label>URL</label>
                        <input type="text" value="${link.url}" onchange="updateMainLink(${index}, 'url', this.value)">
                    </div>
                    <button class="delete-btn" onclick="deleteMainLink(${index})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateMainLink(index, field, value) {
            mainLinks[index][field] = value;
        }

        function addMainLink() {
            const randomIcon = mainIcons[Math.floor(Math.random() * mainIcons.length)];
            mainLinks.push({ name: 'New Resource', url: '#', description: 'Click to open', icon: randomIcon });
            renderMainLinksSettings();
        }

        function deleteMainLink(index) {
            if (mainLinks.length > 1) {
                mainLinks.splice(index, 1);
                renderMainLinksSettings();
            } else {
                alert('You must have at least one main link.');
            }
        }

        // Save Settings
        function saveSettings() {
            // Update school settings
            schoolSettings.name = document.getElementById('schoolNameInput').value;
            schoolSettings.tagline = document.getElementById('schoolTaglineInput').value;
            
            // Save to localStorage
            localStorage.setItem('quickLinks', JSON.stringify(quickLinks));
            localStorage.setItem('mainLinks', JSON.stringify(mainLinks));
            localStorage.setItem('schoolSettings', JSON.stringify(schoolSettings));
            localStorage.setItem('dashboardUsers', JSON.stringify(users));
            
            // Update display
            loadSchoolSettings();
            renderQuickLinks();
            renderMainLinks();
            
            closeSettings();
            
            // Show confirmation
            showNotification('Settings saved successfully!');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: #10b981;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = '‚úÖ ' + message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Add animation keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Close modal on outside click
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });

        // Keyboard shortcut
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSettings();
                closeTwoFASetup();
                closeBackupCodesModal();
                closeTwoFADisable();
            }
        });

        // ============================================
        // Two-Factor Authentication (2FA) Functions
        // ============================================

        // Temporary storage for 2FA setup
        let pendingTwoFASecret = null;
        let pendingBackupCodes = null;

        // Generate a random base32 secret for TOTP
        function generateTOTPSecret() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 32; i++) {
                secret += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return secret;
        }

        // Generate TOTP code from secret (for verification)
        function generateTOTPCode(secret) {
            try {
                const totp = new OTPAuth.TOTP({
                    issuer: 'School Dashboard',
                    label: currentUser ? currentUser.username : 'User',
                    algorithm: 'SHA1',
                    digits: 6,
                    period: 30,
                    secret: secret
                });
                return totp.generate();
            } catch (e) {
                console.error('Error generating TOTP:', e);
                return null;
            }
        }

        // Verify TOTP code
        function verifyTOTPCode(secret, code) {
            try {
                const totp = new OTPAuth.TOTP({
                    issuer: 'School Dashboard',
                    label: 'User',
                    algorithm: 'SHA1',
                    digits: 6,
                    period: 30,
                    secret: secret
                });
                // Allow 1 period tolerance (30 seconds before/after)
                const delta = totp.validate({ token: code, window: 1 });
                return delta !== null;
            } catch (e) {
                console.error('Error verifying TOTP:', e);
                return false;
            }
        }

        // Generate TOTP URI for QR code
        function generateTOTPUri(secret, username) {
            const issuer = 'School%20Dashboard';
            const label = encodeURIComponent(username);
            return `otpauth://totp/${issuer}:${label}?secret=${secret}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;
        }

        // Generate backup codes
        function generateBackupCodes() {
            const codes = [];
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude similar characters
            for (let i = 0; i < 8; i++) {
                let code = '';
                for (let j = 0; j < 8; j++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                codes.push({ code: code, used: false });
            }
            return codes;
        }

        // Render current user's 2FA status
        function render2FAStatus() {
            const container = document.getElementById('current2FAStatus');
            if (!container || !currentUser) return;

            if (currentUser.twoFactorEnabled) {
                const unusedCodes = currentUser.backupCodes ?
                    currentUser.backupCodes.filter(bc => !bc.used).length : 0;

                container.innerHTML = `
                    <h3 style="margin-bottom: var(--space-4); font-size: 1rem;">üîê Two-Factor Authentication</h3>
                    <div class="twofa-success">
                        <strong>Two-Factor Authentication is ENABLED</strong>
                        <p style="margin-top: 0.5rem;">Your account is protected with Google Authenticator.</p>
                        <p style="margin-top: 0.25rem; font-size: 0.85rem;">Backup codes remaining: ${unusedCodes}/8</p>
                    </div>
                    <div style="display: flex; gap: var(--space-3); margin-top: var(--space-4); flex-wrap: wrap;">
                        <button class="btn btn-secondary twofa-setup-btn" onclick="showBackupCodes()">View Backup Codes</button>
                        <button class="btn btn-warning twofa-setup-btn" onclick="regenerateBackupCodes()">Regenerate Backup Codes</button>
                        <button class="btn btn-danger twofa-setup-btn" onclick="openTwoFADisable()">Disable 2FA</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <h3 style="margin-bottom: var(--space-4); font-size: 1rem;">üîê Two-Factor Authentication</h3>
                    <div style="background: var(--bg-tertiary); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                        <strong>Two-Factor Authentication is DISABLED</strong>
                        <p style="margin-top: 0.5rem; color: var(--text-secondary);">Add an extra layer of security to your account using Google Authenticator or any TOTP-compatible app.</p>
                    </div>
                    <button class="btn btn-success twofa-setup-btn" onclick="openTwoFASetup()">Enable 2FA</button>
                `;
            }
        }

        // Save users to localStorage
        function saveUsers() {
            localStorage.setItem('dashboardUsers', JSON.stringify(users));
        }

        // Open 2FA setup modal
        function openTwoFASetup() {
            // Generate new secret
            pendingTwoFASecret = generateTOTPSecret();

            // Display secret key
            document.getElementById('twofaSecretKey').textContent = pendingTwoFASecret.match(/.{1,4}/g).join(' ');

            // Generate QR code
            const qrContainer = document.getElementById('twofaQRCode');
            qrContainer.innerHTML = '';
            const uri = generateTOTPUri(pendingTwoFASecret, currentUser.username);

            new QRCode(qrContainer, {
                text: uri,
                width: 200,
                height: 200,
                colorDark: '#1e3a5f',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });

            // Clear verification input
            document.getElementById('twofaSetupCode').value = '';

            // Show modal
            document.getElementById('twofaSetupModal').style.display = 'flex';
        }

        // Close 2FA setup modal
        function closeTwoFASetup() {
            document.getElementById('twofaSetupModal').style.display = 'none';
            pendingTwoFASecret = null;
        }

        // Confirm 2FA setup
        function confirmTwoFASetup() {
            const code = document.getElementById('twofaSetupCode').value.trim();

            if (!code || code.length !== 6) {
                alert('Please enter the 6-digit code from your authenticator app');
                return;
            }

            if (!pendingTwoFASecret) {
                alert('Setup session expired. Please try again.');
                closeTwoFASetup();
                return;
            }

            // Verify the code
            if (verifyTOTPCode(pendingTwoFASecret, code)) {
                // Generate backup codes
                pendingBackupCodes = generateBackupCodes();

                // Update user
                const userIndex = users.findIndex(u => u.username.toLowerCase() === currentUser.username.toLowerCase());
                if (userIndex !== -1) {
                    users[userIndex].twoFactorEnabled = true;
                    users[userIndex].twoFactorSecret = pendingTwoFASecret;
                    users[userIndex].backupCodes = pendingBackupCodes;
                    saveUsers();
                    currentUser = users[userIndex];
                    sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
                }

                closeTwoFASetup();

                // Show backup codes
                showBackupCodesModal();

                render2FAStatus();
                renderUsersSettings();
            } else {
                alert('Invalid code. Please check your authenticator app and try again.');
                document.getElementById('twofaSetupCode').value = '';
                document.getElementById('twofaSetupCode').focus();
            }
        }

        // Show backup codes modal (after setup or on demand)
        function showBackupCodesModal() {
            const container = document.getElementById('twofaBackupCodes');
            const codes = pendingBackupCodes || (currentUser && currentUser.backupCodes) || [];

            container.innerHTML = codes.map(bc => `
                <div class="twofa-backup-code ${bc.used ? 'used' : ''}">${bc.code}</div>
            `).join('');

            document.getElementById('twofaBackupModal').style.display = 'flex';
        }

        // Show existing backup codes
        function showBackupCodes() {
            pendingBackupCodes = null;
            showBackupCodesModal();
        }

        // Close backup codes modal
        function closeBackupCodesModal() {
            document.getElementById('twofaBackupModal').style.display = 'none';
            pendingBackupCodes = null;
        }

        // Copy backup codes to clipboard
        function copyBackupCodes() {
            const codes = pendingBackupCodes || (currentUser && currentUser.backupCodes) || [];
            const codesText = codes.map((bc, i) => `${i + 1}. ${bc.code}${bc.used ? ' (USED)' : ''}`).join('\n');
            const fullText = `School Dashboard - Backup Codes for ${currentUser.username}\n` +
                           `Generated: ${new Date().toLocaleString()}\n\n` +
                           `${codesText}\n\n` +
                           `Keep these codes in a safe place. Each code can only be used once.`;

            navigator.clipboard.writeText(fullText).then(() => {
                alert('Backup codes copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy. Please manually select and copy the codes.');
            });
        }

        // Regenerate backup codes
        function regenerateBackupCodes() {
            if (!confirm('This will invalidate all existing backup codes. Continue?')) {
                return;
            }

            pendingBackupCodes = generateBackupCodes();

            const userIndex = users.findIndex(u => u.username.toLowerCase() === currentUser.username.toLowerCase());
            if (userIndex !== -1) {
                users[userIndex].backupCodes = pendingBackupCodes;
                saveUsers();
                currentUser = users[userIndex];
                sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
            }

            showBackupCodesModal();
            render2FAStatus();
        }

        // Open disable 2FA modal
        function openTwoFADisable() {
            document.getElementById('twofaDisableCode').value = '';
            document.getElementById('twofaDisableModal').style.display = 'flex';
        }

        // Close disable 2FA modal
        function closeTwoFADisable() {
            document.getElementById('twofaDisableModal').style.display = 'none';
        }

        // Confirm disable 2FA
        function confirmTwoFADisable() {
            const code = document.getElementById('twofaDisableCode').value.trim();

            if (!code || code.length !== 6) {
                alert('Please enter the 6-digit code from your authenticator app');
                return;
            }

            if (!currentUser || !currentUser.twoFactorSecret) {
                alert('2FA is not enabled for this account.');
                closeTwoFADisable();
                return;
            }

            // Verify the code
            if (verifyTOTPCode(currentUser.twoFactorSecret, code)) {
                const userIndex = users.findIndex(u => u.username.toLowerCase() === currentUser.username.toLowerCase());
                if (userIndex !== -1) {
                    users[userIndex].twoFactorEnabled = false;
                    users[userIndex].twoFactorSecret = null;
                    users[userIndex].backupCodes = null;
                    saveUsers();
                    currentUser = users[userIndex];
                    sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
                }

                closeTwoFADisable();
                alert('Two-Factor Authentication has been disabled.');
                render2FAStatus();
                renderUsersSettings();
            } else {
                alert('Invalid code. Please check your authenticator app and try again.');
                document.getElementById('twofaDisableCode').value = '';
                document.getElementById('twofaDisableCode').focus();
            }
        }

        // Verify 2FA code during login
        function verify2FALogin() {
            const code = document.getElementById('login2FACode').value.trim();

            if (!code || code.length !== 6) {
                showLoginError('Please enter a 6-digit code');
                return;
            }

            if (!pendingTwoFAUser) {
                showLoginError('Session expired. Please try again.');
                cancelTwoFALogin();
                return;
            }

            // Verify TOTP code
            if (verifyTOTPCode(pendingTwoFAUser.twoFactorSecret, code)) {
                completeLogin(pendingTwoFAUser);
            } else {
                showLoginError('Invalid code. Please try again.');
                document.getElementById('login2FACode').value = '';
                document.getElementById('login2FACode').focus();
            }
        }

        // Verify backup code during login
        function verifyBackupCodeLogin() {
            const backupCode = document.getElementById('loginBackupCode').value.trim().toUpperCase();

            if (!backupCode) {
                showLoginError('Please enter a backup code');
                return;
            }

            if (!pendingTwoFAUser) {
                showLoginError('Session expired. Please try again.');
                cancelTwoFALogin();
                return;
            }

            // Check if backup code is valid and not used
            const codeIndex = pendingTwoFAUser.backupCodes ?
                pendingTwoFAUser.backupCodes.findIndex(bc => bc.code === backupCode && !bc.used) : -1;

            if (codeIndex !== -1) {
                // Mark backup code as used
                const userIndex = users.findIndex(u => u.username.toLowerCase() === pendingTwoFAUser.username.toLowerCase());
                if (userIndex !== -1) {
                    users[userIndex].backupCodes[codeIndex].used = true;
                    saveUsers();
                    pendingTwoFAUser = users[userIndex];
                }
                completeLogin(pendingTwoFAUser);
            } else {
                showLoginError('Invalid or already used backup code');
                document.getElementById('loginBackupCode').value = '';
                document.getElementById('loginBackupCode').focus();
            }
        }

        // Show backup code input
        function showBackupCodeInput() {
            document.getElementById('backupCodeSection').style.display = 'block';
        }

        // Cancel 2FA login and go back
        function cancelTwoFALogin() {
            pendingTwoFAUser = null;
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2FA').style.display = 'none';
            document.getElementById('backupCodeSection').style.display = 'none';
            document.getElementById('login2FACode').value = '';
            document.getElementById('loginBackupCode').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.remove('show');
        }

        // ============================================
        // Google Drive Cloud Sync Integration
        // ============================================

        // Google Drive Configuration
        const GOOGLE_DRIVE_CONFIG = {
            // Google OAuth Client ID
            CLIENT_ID: '302497466088-0b619cqa9qno2c606k4rqp742lebc5o8.apps.googleusercontent.com',
            // Your Google Drive folder ID from the shared link
            FOLDER_ID: '11vWe_Nc40TtJ1Hi7PoE7EZ3JrpR-K0Vj',
            // File name for backup
            BACKUP_FILE_NAME: 'CESTIS_MAIN_DASHBOARD_BACKUP.json',
            // API scopes needed - using 'drive' scope to allow access to shared files from any account
            SCOPES: 'https://www.googleapis.com/auth/drive'
        };

        // Cloud sync state
        let googleAccessToken = null;
        let isCloudConnected = false;
        let lastSyncTime = null;
        let cloudFileId = null;
        let lastSavedBy = null;
        let cloudFileTimestamp = null;

        // Google Token Client for OAuth
        let googleTokenClient = null;

        // Initialize cloud sync from localStorage
        function initializeCloudSync() {
            const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
            const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
            const savedLastSync = localStorage.getItem('schoolDashboardLastSyncTime');
            const savedFileId = localStorage.getItem('schoolDashboardCloudFileId');

            if (savedLastSync) {
                lastSyncTime = new Date(savedLastSync);
                updateLastSyncDisplay();
            }

            if (savedFileId) {
                cloudFileId = savedFileId;
            }

            // Check if token is still valid
            if (savedToken && savedExpiry) {
                const expiry = new Date(savedExpiry);
                if (expiry > new Date()) {
                    googleAccessToken = savedToken;
                    isCloudConnected = true;
                    updateCloudUI(true);
                    return;
                }
            }

            updateCloudUI(false);
        }

        // Update cloud UI based on connection status
        function updateCloudUI(connected) {
            const notConnectedDiv = document.getElementById('cloudNotConnected');
            const connectedDiv = document.getElementById('cloudConnected');
            const statusDot = document.getElementById('cloudStatusDot');
            const statusText = document.getElementById('cloudStatusText');

            if (connected) {
                notConnectedDiv.style.display = 'none';
                connectedDiv.style.display = 'block';
                statusDot.className = 'cloud-status-dot connected';
                statusText.textContent = 'Connected';
            } else {
                notConnectedDiv.style.display = 'block';
                connectedDiv.style.display = 'none';
                statusDot.className = 'cloud-status-dot';
                statusText.textContent = 'Not connected';
            }
        }

        // Update syncing status
        function setCloudSyncing(syncing) {
            const statusDot = document.getElementById('cloudStatusDot');
            const statusText = document.getElementById('cloudStatusText');
            const menuIcon = document.getElementById('cloudMenuIcon');

            if (syncing) {
                statusDot.className = 'cloud-status-dot syncing';
                statusText.textContent = 'Syncing...';
                menuIcon.innerHTML = '<span class="spinning">üîÑ</span>';
            } else {
                statusDot.className = 'cloud-status-dot connected';
                statusText.textContent = 'Connected';
                menuIcon.textContent = '‚òÅÔ∏è';
            }
        }

        // Toggle cloud dropdown menu
        function toggleCloudMenu() {
            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.toggle('show');

            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeCloudMenuOnClickOutside);
            }, 0);
        }

        function closeCloudMenuOnClickOutside(e) {
            const menu = document.getElementById('cloudDropdownMenu');
            const dropdown = document.querySelector('.cloud-dropdown');

            if (!dropdown.contains(e.target)) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeCloudMenuOnClickOutside);
            }
        }

        // Initialize Google Identity Services
        function initGoogleAuth() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                googleTokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
                    scope: GOOGLE_DRIVE_CONFIG.SCOPES,
                    callback: handleGoogleAuthCallback,
                    error_callback: handleGoogleAuthError
                });
            }
        }

        // Connect to Google Drive using OAuth
        async function connectToGoogleDrive() {
            // Always show the modal first - let user choose method
            showGoogleAuthModal();
        }

        // Show authentication modal with two options
        function showGoogleAuthModal() {
            const modalHTML = `
                <div id="googleAuthModal" class="google-auth-modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 560px;">
                        <div class="modal-header">
                            <h2>‚òÅÔ∏è Connect to Google Drive</h2>
                            <button class="close-btn" onclick="closeGoogleAuthModal()">√ó</button>
                        </div>
                        <div style="padding: var(--space-6);">
                            <p style="margin-bottom: var(--space-5); color: var(--text-secondary);">
                                Connect to Google Drive to save and sync your dashboard data across devices. Choose your preferred connection method:
                            </p>

                            <!-- Option 1: Direct Google Sign-In (Recommended) -->
                            <div style="background: var(--success-bg); border: 2px solid var(--success); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-4);">
                                <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                                    <span style="font-size: 1.5rem;">üîê</span>
                                    <div>
                                        <strong style="color: var(--success); font-size: 1.1rem;">Direct Google Sign-In</strong>
                                        <span style="background: var(--success); color: white; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; margin-left: var(--space-2); font-weight: 600;">RECOMMENDED</span>
                                    </div>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-4);">
                                    A Google popup will appear for you to sign in with your Google account directly.
                                </p>
                                <button class="btn btn-success" onclick="triggerDirectGoogleSignIn()" style="width: 100%; padding: var(--space-3);">
                                    Sign in with Google
                                </button>
                            </div>

                            <!-- Option 2: Manual Token Method -->
                            <div id="manualTokenSection" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: var(--space-5);">
                                <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                                    <span style="font-size: 1.5rem;">üîß</span>
                                    <strong style="color: var(--text-primary); font-size: 1.1rem;">Manual Token Method</strong>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-4);">
                                    If the popup doesn't work, you can still use the OAuth Playground to get a token manually.
                                </p>
                                <button class="btn btn-secondary" onclick="showManualTokenForm()" id="showManualTokenBtn" style="width: 100%;">
                                    Use Manual Method
                                </button>

                                <!-- Manual token form (hidden by default) -->
                                <div id="manualTokenForm" style="display: none; margin-top: var(--space-4);">
                                    <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
                                        <strong style="color: var(--info);">How to get your access token:</strong>
                                        <ol style="margin-top: var(--space-2); margin-left: var(--space-4); color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">
                                            <li>Click the link below to open Google OAuth Playground</li>
                                            <li>In Step 1, find and select <strong>"Drive API v3"</strong> ‚Üí check <strong>"../auth/drive"</strong> (full access to shared files)</li>
                                            <li>Click <strong>"Authorize APIs"</strong> (blue button)</li>
                                            <li>Sign in with your Google account</li>
                                            <li>In Step 2, click <strong>"Exchange authorization code for tokens"</strong></li>
                                            <li>Copy the <strong>"Access token"</strong> value and paste below</li>
                                        </ol>
                                        <a href="https://developers.google.com/oauthplayground" target="_blank"
                                           style="display: inline-block; margin-top: var(--space-3); padding: var(--space-2) var(--space-4); background: var(--accent); color: white; border-radius: var(--radius-md); text-decoration: none; font-weight: 600; font-size: 0.875rem;">
                                            üîó Open OAuth Playground
                                        </a>
                                    </div>

                                    <div class="form-group" style="margin-bottom: var(--space-4);">
                                        <label style="font-weight: 600;">Access Token</label>
                                        <textarea id="googleAccessTokenInput" rows="4" style="width: 100%; padding: var(--space-3); border: 2px solid var(--border-light); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; resize: vertical; margin-top: var(--space-2);" placeholder="Paste your access token here..."></textarea>
                                    </div>

                                    <button class="btn btn-success" onclick="submitGoogleToken()" style="width: 100%;">
                                        ‚òÅÔ∏è Connect with Token
                                    </button>
                                </div>
                            </div>

                            <div style="margin-top: var(--space-4); text-align: center;">
                                <button class="btn btn-secondary" onclick="closeGoogleAuthModal()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Trigger the direct Google Sign-In popup
        function triggerDirectGoogleSignIn() {
            closeGoogleAuthModal();
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken();
            } else {
                initGoogleAuth();
                setTimeout(() => {
                    if (googleTokenClient) {
                        googleTokenClient.requestAccessToken();
                    } else {
                        alert('Google Sign-In popup is not available. Please use the manual token method.');
                        showGoogleAuthModal();
                        // Auto-expand the manual form
                        setTimeout(() => showManualTokenForm(), 100);
                    }
                }, 500);
            }
        }

        // Show the manual token form
        function showManualTokenForm() {
            const form = document.getElementById('manualTokenForm');
            const btn = document.getElementById('showManualTokenBtn');
            if (form && btn) {
                form.style.display = 'block';
                btn.style.display = 'none';
            }
        }

        function closeGoogleAuthModal() {
            const modal = document.getElementById('googleAuthModal');
            if (modal) modal.remove();
        }

        async function submitGoogleToken() {
            const tokenInput = document.getElementById('googleAccessTokenInput');
            const token = tokenInput.value.trim();

            if (!token) {
                alert('Please enter an access token');
                return;
            }

            // Verify the token works by making a test API call
            try {
                const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Invalid token');
                }

                const data = await response.json();

                // Token is valid, save it
                googleAccessToken = token;
                isCloudConnected = true;

                // Save token with 1 hour expiry (typical for OAuth tokens)
                const expiry = new Date();
                expiry.setHours(expiry.getHours() + 1);
                localStorage.setItem('schoolDashboardGoogleAccessToken', token);
                localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

                closeGoogleAuthModal();
                updateCloudUI(true);

                alert(`‚úÖ Connected to Google Drive as ${data.user.displayName || data.user.emailAddress}`);

                // Try to find existing backup file
                await findExistingBackupFile();

            } catch (error) {
                console.error('Token verification failed:', error);
                alert('‚ùå Invalid access token. Please make sure you copied the correct token.');
            }
        }

        async function handleGoogleAuthCallback(tokenResponse) {
            googleAccessToken = tokenResponse.access_token;
            isCloudConnected = true;

            const expiry = new Date();
            expiry.setSeconds(expiry.getSeconds() + (tokenResponse.expires_in || 3600));
            localStorage.setItem('schoolDashboardGoogleAccessToken', googleAccessToken);
            localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

            updateCloudUI(true);

            // Try to find existing backup file
            await findExistingBackupFile();

            alert('‚úÖ Connected to Google Drive successfully! You can now save and sync your data.');
        }

        function handleGoogleAuthError(error) {
            console.error('Google auth error:', error);
            if (error.type === 'popup_closed') {
                // User closed the popup, don't show error
                return;
            }
            alert('Failed to authenticate with Google. Please try the manual token method.');
            showGoogleAuthModal();
        }

        // Disconnect from Google Drive
        function disconnectFromGoogleDrive() {
            if (confirm('Are you sure you want to disconnect from Google Drive? Your local data will remain intact.')) {
                googleAccessToken = null;
                isCloudConnected = false;
                cloudFileId = null;

                localStorage.removeItem('schoolDashboardGoogleAccessToken');
                localStorage.removeItem('schoolDashboardGoogleTokenExpiry');
                localStorage.removeItem('schoolDashboardCloudFileId');

                updateCloudUI(false);
                toggleCloudMenu();

                alert('‚úÖ Disconnected from Google Drive');
            }
        }

        // Find existing backup file in the folder
        async function findExistingBackupFile() {
            try {
                const query = `name='${GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME}' and '${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime)`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    if (data.files && data.files.length > 0) {
                        cloudFileId = data.files[0].id;
                        localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
                        console.log('Found existing backup file:', cloudFileId);
                    }
                }
            } catch (error) {
                console.error('Error finding backup file:', error);
            }
        }

        // Check cloud file for changes before saving (multi-user conflict detection)
        async function checkCloudForChanges() {
            if (!cloudFileId || !googleAccessToken) return null;

            try {
                // Fetch the current cloud file to check who last saved and when
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const backupData = await response.json();
                    return {
                        savedBy: backupData.savedBy || 'Unknown',
                        timestamp: backupData.timestamp
                    };
                }
            } catch (error) {
                console.error('Error checking cloud for changes:', error);
            }
            return null;
        }

        // Save data to Google Drive
        async function saveToCloud() {
            if (!isCloudConnected || !googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.remove('show');

            // Check for changes by others before saving
            const cloudInfo = await checkCloudForChanges();

            let confirmMessage = '‚ö†Ô∏è MULTI-USER CLOUD SYNC\n\n';
            confirmMessage += 'You are about to save to a shared cloud backup.\n\n';

            if (cloudInfo && cloudInfo.savedBy) {
                const cloudTime = new Date(cloudInfo.timestamp);
                const timeSinceLastSave = getTimeAgo(cloudTime);

                // Check if someone else saved since our last sync
                const hasConflict = lastSyncTime && cloudTime > lastSyncTime;

                if (hasConflict && cloudInfo.savedBy !== (currentUser ? currentUser.username : '')) {
                    confirmMessage += `‚ö†Ô∏è WARNING: ${cloudInfo.savedBy} saved changes ${timeSinceLastSave}!\n`;
                    confirmMessage += `Your local data may not include their changes.\n\n`;
                    confirmMessage += `üí° Recommendation: Click Cancel, then "Sync from Cloud" first.\n\n`;
                } else {
                    confirmMessage += `Last saved by: ${cloudInfo.savedBy} (${timeSinceLastSave})\n\n`;
                }
            }

            confirmMessage += 'This will overwrite the cloud backup. Continue?';

            if (!confirm(confirmMessage)) {
                return;
            }

            setCloudSyncing(true);

            try {
                // Prepare data for backup
                const backupData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    savedBy: currentUser ? currentUser.username : 'Unknown',
                    data: {
                        users: users,
                        quickLinks: quickLinks,
                        mainLinks: mainLinks,
                        schoolSettings: schoolSettings
                    }
                };

                const jsonContent = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });

                let response;

                if (cloudFileId) {
                    // Update existing file
                    response = await fetch(
                        `https://www.googleapis.com/upload/drive/v3/files/${cloudFileId}?uploadType=media`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: blob
                        }
                    );
                } else {
                    // Create new file with metadata
                    const metadata = {
                        name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,
                        parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
                        mimeType: 'application/json'
                    };

                    const formData = new FormData();
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    formData.append('file', blob);

                    response = await fetch(
                        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`
                            },
                            body: formData
                        }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        cloudFileId = result.id;
                        localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
                    }
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Upload failed');
                }

                // Update last sync time
                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Update last saved by info
                lastSavedBy = currentUser ? currentUser.username : 'Unknown';
                cloudFileTimestamp = new Date().toISOString();
                updateLastSavedByDisplay();

                setCloudSyncing(false);
                alert(`‚úÖ Data saved to Google Drive successfully!\n\nSaved by: ${lastSavedBy}\n\nüí° Tip: Let other users know to sync from cloud to get your changes.`);

            } catch (error) {
                console.error('Error saving to cloud:', error);
                setCloudSyncing(false);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    alert('‚ùå Your session has expired. Please reconnect to Google Drive.');
                    disconnectFromGoogleDrive();
                } else {
                    alert(`‚ùå Failed to save to cloud: ${error.message}`);
                }
            }
        }

        // Sync (download) data from Google Drive
        async function syncFromCloud() {
            if (!isCloudConnected || !googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.remove('show');

            // First try to find the file if we don't have the ID
            if (!cloudFileId) {
                await findExistingBackupFile();
            }

            if (!cloudFileId) {
                alert('üìÅ No backup file found in Google Drive. Save your data first to create a backup.');
                return;
            }

            if (!confirm('‚ö†Ô∏è This will replace your local data with the cloud backup. Are you sure you want to continue?')) {
                return;
            }

            setCloudSyncing(true);

            try {
                // Download the file
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to download backup');
                }

                const backupData = await response.json();

                // Validate backup format
                if (!backupData.data || !backupData.version) {
                    throw new Error('Invalid backup file format');
                }

                // Restore data
                if (backupData.data.users) {
                    users = backupData.data.users;
                    saveUsers();
                }

                if (backupData.data.quickLinks) {
                    quickLinks = backupData.data.quickLinks;
                    localStorage.setItem('quickLinks', JSON.stringify(quickLinks));
                }

                if (backupData.data.mainLinks) {
                    mainLinks = backupData.data.mainLinks;
                    localStorage.setItem('mainLinks', JSON.stringify(mainLinks));
                }

                if (backupData.data.schoolSettings) {
                    schoolSettings = backupData.data.schoolSettings;
                    localStorage.setItem('schoolSettings', JSON.stringify(schoolSettings));
                }

                // Update last sync time
                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Refresh UI
                loadSchoolSettings();
                renderQuickLinks();
                renderMainLinks();

                setCloudSyncing(false);

                // Update last saved by info
                lastSavedBy = backupData.savedBy || 'Unknown';
                cloudFileTimestamp = backupData.timestamp;
                updateLastSavedByDisplay();

                const backupTime = new Date(backupData.timestamp).toLocaleString();
                const savedByInfo = backupData.savedBy ? `\nLast saved by: ${backupData.savedBy}` : '';
                alert(`‚úÖ Data synced from cloud successfully!\n\nBackup was created: ${backupTime}${savedByInfo}`);

            } catch (error) {
                console.error('Error syncing from cloud:', error);
                setCloudSyncing(false);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    alert('‚ùå Your session has expired. Please reconnect to Google Drive.');
                    disconnectFromGoogleDrive();
                } else {
                    alert(`‚ùå Failed to sync from cloud: ${error.message}`);
                }
            }
        }

        // Update last sync display
        function updateLastSyncDisplay() {
            const lastSyncInfo = document.getElementById('lastSyncInfo');
            if (lastSyncTime) {
                const timeAgo = getTimeAgo(lastSyncTime);
                lastSyncInfo.textContent = `Last sync: ${timeAgo}`;
            } else {
                lastSyncInfo.textContent = 'Last sync: Never';
            }
        }

        // Update last saved by display
        function updateLastSavedByDisplay() {
            const lastSavedByInfo = document.getElementById('lastSavedByInfo');
            if (lastSavedByInfo) {
                if (lastSavedBy && cloudFileTimestamp) {
                    const timeAgo = getTimeAgo(new Date(cloudFileTimestamp));
                    lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy} (${timeAgo})`;
                } else if (lastSavedBy) {
                    lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy}`;
                } else {
                    lastSavedByInfo.textContent = 'Last saved by: --';
                }
            }
        }

        // Get human-readable time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }

        // ============================================
        // FILE BROWSER & SELECTIVE SYNC FUNCTIONALITY
        // ============================================

        // Browse all backup files in the shared folder
        async function browseBackupFiles() {
            if (!isCloudConnected || !googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.remove('show');

            setCloudSyncing(true);

            try {
                const files = await listBackupFilesInFolder();
                setCloudSyncing(false);

                if (files.length === 0) {
                    alert('üìÅ No backup files found in the shared folder.\n\nMake sure the folder is shared with your account and contains JSON backup files.');
                    return;
                }

                showFileBrowserModal(files);
            } catch (error) {
                console.error('Error browsing backup files:', error);
                setCloudSyncing(false);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    alert('‚ùå Your session has expired. Please reconnect to Google Drive.');
                    disconnectFromGoogleDrive();
                } else {
                    alert(`‚ùå Failed to browse files: ${error.message}`);
                }
            }
        }

        // List all JSON backup files in the shared folder
        async function listBackupFilesInFolder() {
            // Search for all JSON files in the shared folder
            const query = `'${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and mimeType='application/json' and trashed=false`;

            const response = await fetch(
                `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime,size,owners,sharingUser)&orderBy=modifiedTime desc`,
                {
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    }
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Failed to list files');
            }

            const data = await response.json();

            // For each file, try to get additional metadata (savedBy info)
            const filesWithMetadata = await Promise.all(
                data.files.map(async (file) => {
                    try {
                        const contentResponse = await fetch(
                            `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,
                            {
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken}`
                                }
                            }
                        );

                        if (contentResponse.ok) {
                            const content = await contentResponse.json();
                            return {
                                ...file,
                                savedBy: content.savedBy || 'Unknown',
                                backupTimestamp: content.timestamp,
                                hasValidFormat: content.version && content.data
                            };
                        }
                    } catch (e) {
                        console.warn('Could not read metadata for file:', file.name);
                    }

                    return {
                        ...file,
                        savedBy: 'Unknown',
                        backupTimestamp: file.modifiedTime,
                        hasValidFormat: false
                    };
                })
            );

            return filesWithMetadata;
        }

        // Show file browser modal
        function showFileBrowserModal(files) {
            const existingModal = document.getElementById('fileBrowserModal');
            if (existingModal) {
                existingModal.remove();
            }

            const fileListHTML = files.map(file => {
                const modifiedDate = new Date(file.modifiedTime);
                const timeAgo = getTimeAgo(modifiedDate);
                const dateFormatted = modifiedDate.toLocaleDateString() + ' ' + modifiedDate.toLocaleTimeString();
                const validBadge = file.hasValidFormat
                    ? '<span style="background: var(--success); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;">Valid</span>'
                    : '<span style="background: var(--warning); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;">Unknown Format</span>';

                return `
                    <div class="backup-file-item" onclick="selectBackupFile('${file.id}', '${file.name.replace(/'/g, "\\'")}')">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5rem;">üìÑ</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary);">
                                    ${file.name}${validBadge}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                                    <span>üìÖ ${dateFormatted}</span>
                                    <span style="margin-left: 16px;">üë§ Saved by: ${file.savedBy}</span>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 2px;">
                                    Modified ${timeAgo}
                                </div>
                            </div>
                            <span style="color: var(--accent); font-size: 1.2rem;">‚Üí</span>
                        </div>
                    </div>
                `;
            }).join('');

            const modalHTML = `
                <div id="fileBrowserModal" class="google-auth-modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
                        <div class="modal-header">
                            <h2>üìÅ Browse Backup Files</h2>
                            <button class="close-btn" onclick="closeFileBrowserModal()">√ó</button>
                        </div>
                        <div style="padding: var(--space-4);">
                            <p style="margin-bottom: var(--space-4); color: var(--text-secondary);">
                                Select a backup file to sync from. Files are sorted by most recent first.
                            </p>
                            <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-4);">
                                <strong style="color: var(--info);">üí° Tip:</strong>
                                <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Files shared with your account from other users will appear here. You can sync data from any shared backup.
                                </span>
                            </div>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-light); border-radius: var(--radius-md);">
                                ${fileListHTML}
                            </div>
                            <div style="margin-top: var(--space-4); text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                                Found ${files.length} backup file${files.length !== 1 ? 's' : ''} in shared folder
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    .backup-file-item {
                        padding: var(--space-4);
                        border-bottom: 1px solid var(--border-light);
                        cursor: pointer;
                        transition: background-color 0.2s;
                    }
                    .backup-file-item:hover {
                        background-color: var(--bg-hover);
                    }
                    .backup-file-item:last-child {
                        border-bottom: none;
                    }
                </style>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close file browser modal
        function closeFileBrowserModal() {
            const modal = document.getElementById('fileBrowserModal');
            if (modal) {
                modal.remove();
            }
        }

        // Select a backup file and show selective sync options
        async function selectBackupFile(fileId, fileName) {
            closeFileBrowserModal();
            setCloudSyncing(true);

            try {
                // Download the file content
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to download backup file');
                }

                const backupData = await response.json();
                setCloudSyncing(false);

                // Validate backup format
                if (!backupData.data || !backupData.version) {
                    alert('‚ùå Invalid backup file format. This file does not contain valid dashboard backup data.');
                    return;
                }

                // Show selective sync modal
                showSelectiveSyncModal(backupData, fileId, fileName);

            } catch (error) {
                console.error('Error loading backup file:', error);
                setCloudSyncing(false);
                alert(`‚ùå Failed to load backup file: ${error.message}`);
            }
        }

        // Show selective sync modal
        function showSelectiveSyncModal(backupData, fileId, fileName) {
            const existingModal = document.getElementById('selectiveSyncModal');
            if (existingModal) {
                existingModal.remove();
            }

            const backupTime = new Date(backupData.timestamp).toLocaleString();
            const savedBy = backupData.savedBy || 'Unknown';

            // Count items in each category
            const userCount = backupData.data.users ? backupData.data.users.length : 0;
            const quickLinksCount = backupData.data.quickLinks ? backupData.data.quickLinks.length : 0;
            const mainLinksCount = backupData.data.mainLinks ? backupData.data.mainLinks.length : 0;
            const hasSettings = backupData.data.schoolSettings ? true : false;

            const modalHTML = `
                <div id="selectiveSyncModal" class="google-auth-modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 550px;">
                        <div class="modal-header">
                            <h2>üîÑ Selective Sync</h2>
                            <button class="close-btn" onclick="closeSelectiveSyncModal()">√ó</button>
                        </div>
                        <div style="padding: var(--space-5);">
                            <div style="background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-5);">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-2);">
                                    üìÑ ${fileName}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    <span>üìÖ ${backupTime}</span>
                                    <span style="margin-left: 16px;">üë§ Saved by: ${savedBy}</span>
                                </div>
                            </div>

                            <p style="margin-bottom: var(--space-4); color: var(--text-secondary);">
                                Choose which data you want to sync from this backup:
                            </p>

                            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                <label class="sync-option-item" style="${userCount === 0 ? 'opacity: 0.5;' : ''}">
                                    <input type="checkbox" id="syncUsers" ${userCount > 0 ? 'checked' : 'disabled'}>
                                    <span class="sync-option-label">
                                        <span style="font-size: 1.2rem;">üë•</span>
                                        <span>
                                            <strong>Users</strong>
                                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 8px;">(${userCount} user${userCount !== 1 ? 's' : ''})</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="sync-option-item" style="${quickLinksCount === 0 ? 'opacity: 0.5;' : ''}">
                                    <input type="checkbox" id="syncQuickLinks" ${quickLinksCount > 0 ? 'checked' : 'disabled'}>
                                    <span class="sync-option-label">
                                        <span style="font-size: 1.2rem;">‚ö°</span>
                                        <span>
                                            <strong>Quick Links</strong>
                                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 8px;">(${quickLinksCount} link${quickLinksCount !== 1 ? 's' : ''})</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="sync-option-item" style="${mainLinksCount === 0 ? 'opacity: 0.5;' : ''}">
                                    <input type="checkbox" id="syncMainLinks" ${mainLinksCount > 0 ? 'checked' : 'disabled'}>
                                    <span class="sync-option-label">
                                        <span style="font-size: 1.2rem;">üîó</span>
                                        <span>
                                            <strong>Main Links</strong>
                                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 8px;">(${mainLinksCount} link${mainLinksCount !== 1 ? 's' : ''})</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="sync-option-item" style="${!hasSettings ? 'opacity: 0.5;' : ''}">
                                    <input type="checkbox" id="syncSettings" ${hasSettings ? 'checked' : 'disabled'}>
                                    <span class="sync-option-label">
                                        <span style="font-size: 1.2rem;">‚öôÔ∏è</span>
                                        <span>
                                            <strong>School Settings</strong>
                                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 8px;">(name, logo, theme)</span>
                                        </span>
                                    </span>
                                </label>
                            </div>

                            <div style="background: var(--warning-bg); border: 1px solid var(--warning-border); border-radius: var(--radius-md); padding: var(--space-3); margin-top: var(--space-5); margin-bottom: var(--space-4);">
                                <strong style="color: var(--warning);">‚ö†Ô∏è Warning:</strong>
                                <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Selected data will <strong>replace</strong> your current local data.
                                </span>
                            </div>

                            <div style="display: flex; gap: var(--space-3);">
                                <button class="btn btn-secondary" onclick="closeSelectiveSyncModal()" style="flex: 1;">
                                    Cancel
                                </button>
                                <button class="btn btn-success" onclick="performSelectiveSync('${fileId}')" style="flex: 1;">
                                    üîÑ Sync Selected Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    .sync-option-item {
                        display: flex;
                        align-items: center;
                        gap: var(--space-3);
                        padding: var(--space-3);
                        background: var(--bg-secondary);
                        border: 1px solid var(--border-light);
                        border-radius: var(--radius-md);
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .sync-option-item:hover {
                        border-color: var(--accent);
                        background: var(--bg-hover);
                    }
                    .sync-option-item input[type="checkbox"] {
                        width: 20px;
                        height: 20px;
                        accent-color: var(--accent);
                    }
                    .sync-option-label {
                        display: flex;
                        align-items: center;
                        gap: var(--space-2);
                    }
                </style>
            `;

            // Store backup data for later use
            window.pendingBackupData = backupData;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close selective sync modal
        function closeSelectiveSyncModal() {
            const modal = document.getElementById('selectiveSyncModal');
            if (modal) {
                modal.remove();
            }
            window.pendingBackupData = null;
        }

        // Perform selective sync based on user selections
        async function performSelectiveSync(fileId) {
            const backupData = window.pendingBackupData;
            if (!backupData) {
                alert('‚ùå Backup data not found. Please try again.');
                closeSelectiveSyncModal();
                return;
            }

            const syncUsers = document.getElementById('syncUsers').checked;
            const syncQuickLinks = document.getElementById('syncQuickLinks').checked;
            const syncMainLinks = document.getElementById('syncMainLinks').checked;
            const syncSettings = document.getElementById('syncSettings').checked;

            if (!syncUsers && !syncQuickLinks && !syncMainLinks && !syncSettings) {
                alert('Please select at least one data type to sync.');
                return;
            }

            // Build confirmation message
            let selectedItems = [];
            if (syncUsers) selectedItems.push('Users');
            if (syncQuickLinks) selectedItems.push('Quick Links');
            if (syncMainLinks) selectedItems.push('Main Links');
            if (syncSettings) selectedItems.push('School Settings');

            if (!confirm(`‚ö†Ô∏è You are about to sync the following data:\n\n‚Ä¢ ${selectedItems.join('\n‚Ä¢ ')}\n\nThis will replace your current local data. Continue?`)) {
                return;
            }

            closeSelectiveSyncModal();
            setCloudSyncing(true);

            try {
                // Perform selective restore
                if (syncUsers && backupData.data.users) {
                    users = backupData.data.users;
                    saveUsers();
                }

                if (syncQuickLinks && backupData.data.quickLinks) {
                    quickLinks = backupData.data.quickLinks;
                    localStorage.setItem('quickLinks', JSON.stringify(quickLinks));
                }

                if (syncMainLinks && backupData.data.mainLinks) {
                    mainLinks = backupData.data.mainLinks;
                    localStorage.setItem('mainLinks', JSON.stringify(mainLinks));
                }

                if (syncSettings && backupData.data.schoolSettings) {
                    schoolSettings = backupData.data.schoolSettings;
                    localStorage.setItem('schoolSettings', JSON.stringify(schoolSettings));
                }

                // Update sync tracking
                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Update last saved by info
                lastSavedBy = backupData.savedBy || 'Unknown';
                cloudFileTimestamp = backupData.timestamp;
                updateLastSavedByDisplay();

                // Cache the file ID if this becomes our primary sync file
                cloudFileId = fileId;
                localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);

                // Refresh UI
                loadSchoolSettings();
                renderQuickLinks();
                renderMainLinks();

                setCloudSyncing(false);

                const syncedItems = selectedItems.join(', ');
                alert(`‚úÖ Selective sync completed!\n\nSynced: ${syncedItems}\n\nFrom backup saved by: ${lastSavedBy}`);

            } catch (error) {
                console.error('Error performing selective sync:', error);
                setCloudSyncing(false);
                alert(`‚ùå Failed to sync data: ${error.message}`);
            }
        }
    </script>
</body>
</html>
