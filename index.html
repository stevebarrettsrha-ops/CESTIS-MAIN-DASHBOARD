<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- OTPAuth library for TOTP (2FA) -->
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9.2.1/dist/otpauth.umd.min.js"></script>
    <!-- QRCode library for generating QR codes -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- Google Identity Services for OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- EmailJS SDK for sending OTP emails -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS with public key
        (function() {
            if (typeof emailjs !== 'undefined') {
                emailjs.init('z_6Ya8J_WGJjRIGuX');
            }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --accent: #0ea5e9;
            --accent-dark: #0284c7;
            --background: #f1f5f9;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

            /* Additional variables for 2FA and Cloud Sync */
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8fafc;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;

            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-7: 1.75rem;
            --space-8: 2rem;

            /* Border radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: all 0.2s ease;

            /* Status colors */
            --success: #10b981;
            --success-dark: #059669;
            --success-bg: #dcfce7;
            --success-border: #86efac;

            --danger: #ef4444;
            --danger-dark: #dc2626;

            --warning: #f59e0b;
            --warning-dark: #d97706;
            --warning-bg: #fef3c7;
            --warning-border: #fcd34d;

            --info: #3b82f6;
            --info-bg: #dbeafe;
            --info-border: #93c5fd;

            --gray-100: #f3f4f6;
            --gray-500: #6b7280;

            /* Background variants */
            --bg-hover: rgba(0, 0, 0, 0.04);

            /* Fonts */
            --font-mono: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            min-height: 100vh;
            color: var(--text-primary);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo-container {
            width: 192px;
            height: 192px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }

        .logo-container img {
            width: 192px;
            height: 192px;
            object-fit: contain;
        }

        .logo-placeholder {
            font-size: 4rem;
            color: var(--primary);
        }

        .school-info h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .school-info p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .datetime {
            text-align: right;
            padding-right: 1rem;
            border-right: 1px solid rgba(255,255,255,0.3);
        }

        .datetime .time {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .datetime .date {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* Quick Links Grid */
        .quick-links-section {
            margin-bottom: 2.5rem;
        }

        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.25rem;
        }

        .quick-link-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            text-decoration: none;
            color: var(--text-primary);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 2px solid transparent;
            min-height: 140px;
            justify-content: center;
        }

        .quick-link-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .quick-link-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .quick-link-card:nth-child(6n+1) .quick-link-icon { background: #dbeafe; color: #2563eb; }
        .quick-link-card:nth-child(6n+2) .quick-link-icon { background: #dcfce7; color: #16a34a; }
        .quick-link-card:nth-child(6n+3) .quick-link-icon { background: #fef3c7; color: #d97706; }
        .quick-link-card:nth-child(6n+4) .quick-link-icon { background: #fce7f3; color: #db2777; }
        .quick-link-card:nth-child(6n+5) .quick-link-icon { background: #e0e7ff; color: #4f46e5; }
        .quick-link-card:nth-child(6n+6) .quick-link-icon { background: #ccfbf1; color: #0d9488; }

        .quick-link-title {
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.3;
        }

        /* Main Links Section */
        .main-links-section {
            margin-bottom: 2.5rem;
        }

        .main-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .main-link-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            text-decoration: none;
            color: var(--text-primary);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            border-left: 4px solid var(--primary);
        }

        .main-link-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .main-link-card:nth-child(4n+1) { border-left-color: #2563eb; }
        .main-link-card:nth-child(4n+2) { border-left-color: #10b981; }
        .main-link-card:nth-child(4n+3) { border-left-color: #f59e0b; }
        .main-link-card:nth-child(4n+4) { border-left-color: #8b5cf6; }

        .main-link-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            flex-shrink: 0;
        }

        .main-link-card:nth-child(4n+1) .main-link-icon { background: #dbeafe; color: #2563eb; }
        .main-link-card:nth-child(4n+2) .main-link-icon { background: #dcfce7; color: #10b981; }
        .main-link-card:nth-child(4n+3) .main-link-icon { background: #fef3c7; color: #f59e0b; }
        .main-link-card:nth-child(4n+4) .main-link-icon { background: #ede9fe; color: #8b5cf6; }

        .main-link-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .main-link-content p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary);
            color: white;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
        }

        .settings-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .settings-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .settings-tab.active {
            background: var(--primary);
            color: white;
        }

        .settings-tab:hover:not(.active) {
            background: var(--background);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Logo Settings */
        .logo-settings {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .current-logo-preview {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--background);
            border-radius: 12px;
        }

        .preview-box {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            overflow: hidden;
        }

        .preview-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .logo-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-input-label:hover {
            background: var(--primary-dark);
        }

        .remove-logo-btn {
            padding: 0.75rem 1.25rem;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .remove-logo-btn:hover {
            background: #fecaca;
        }

        /* School Name Setting */
        .school-name-setting {
            padding: 1.5rem;
            background: var(--background);
            border-radius: 12px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Button Settings */
        .button-settings-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .button-setting-item {
            padding: 1.25rem;
            background: var(--background);
            border-radius: 12px;
            display: grid;
            grid-template-columns: auto 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .button-setting-item .item-number {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            align-self: center;
        }

        .button-setting-item input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .button-setting-item input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .button-setting-item label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.35rem;
            color: var(--text-secondary);
        }

        .delete-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.2s;
            align-self: center;
        }

        .delete-btn:hover {
            background: #fecaca;
        }

        .add-button-btn {
            padding: 1rem;
            background: white;
            border: 2px dashed var(--border);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .add-button-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Modal Footer */
        .modal-footer {
            padding: 1.25rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background: var(--background);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--background);
        }

        .btn-primary {
            background: var(--primary);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
            }

            .header-right {
                flex-direction: column;
            }

            .datetime {
                border-right: none;
                padding-right: 0;
                text-align: center;
            }

            .button-setting-item {
                grid-template-columns: 1fr;
            }

            .button-setting-item .item-number {
                align-self: start;
            }

            .quick-links-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .main-links-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Icon set */
        .icon {
            font-style: normal;
        }

        /* Login Page Styles */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1rem;
        }

        .login-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
        }

        .login-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .login-form-group {
            position: relative;
        }

        .login-form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .login-form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            padding-left: 2.75rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--background);
        }

        .login-form-group input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        .login-form-group .input-icon {
            position: absolute;
            left: 1rem;
            top: 2.5rem;
            font-size: 1.1rem;
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 0.5rem;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.875rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .login-error.show {
            display: flex;
        }

        .dashboard-container {
            display: none;
        }

        .dashboard-container.visible {
            display: block;
        }

        .login-page.hidden {
            display: none;
        }

        /* First-Time Sync Prompt Styles */
        .first-time-sync-prompt {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .first-time-sync-prompt.hidden {
            display: none;
        }

        .sync-prompt-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .first-time-sync-prompt h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .first-time-sync-prompt p {
            font-size: 0.85rem;
            color: #475569;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .sync-prompt-btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }

        .sync-prompt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(59, 130, 246, 0.4);
        }

        .sync-prompt-btn:active {
            transform: translateY(0);
        }

        .sync-prompt-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .sync-prompt-dismiss {
            margin-top: 0.75rem;
        }

        .sync-prompt-dismiss a {
            font-size: 0.8rem;
            color: #64748b;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .sync-prompt-dismiss a:hover {
            color: #3b82f6;
            text-decoration: underline;
        }

        .sync-status-message {
            margin-top: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .sync-status-message.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .sync-status-message.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .sync-status-icon {
            animation: pulse-icon 1.5s ease-in-out infinite;
        }

        .sync-status-message.success .sync-status-icon,
        .sync-status-message.error .sync-status-icon {
            animation: none;
        }

        @keyframes pulse-icon {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Forgot Password Styles */
        .forgot-password-link {
            text-align: center;
            margin-top: var(--space-4);
        }

        .forgot-password-link a {
            color: var(--accent);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .forgot-password-link a:hover {
            color: var(--accent-dark);
            text-decoration: underline;
        }

        .forgot-password-header {
            text-align: center;
            margin-bottom: var(--space-6);
        }

        .forgot-password-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .forgot-password-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .forgot-password-error,
        .otp-error,
        .new-password-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.875rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: var(--space-4);
        }

        .login-btn-secondary {
            background: transparent !important;
            color: var(--text-secondary) !important;
            border: 1px solid var(--border-medium) !important;
            margin-top: var(--space-3) !important;
        }

        .login-btn-secondary:hover {
            background: var(--bg-hover) !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .otp-resend {
            text-align: center;
            margin-top: var(--space-4);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .otp-resend a {
            color: var(--accent);
            cursor: pointer;
            text-decoration: none;
        }

        .otp-resend a:hover {
            color: var(--accent-dark);
            text-decoration: underline;
        }

        /* Logout button */
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(220, 38, 38, 0.8);
            transform: translateY(-1px);
        }

        /* User display in header */
        .user-display {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-right: 1rem;
            border-right: 1px solid rgba(255,255,255,0.3);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .user-info {
            text-align: left;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-role {
            font-size: 0.75rem;
            opacity: 0.85;
        }

        /* User Settings Styles */
        .user-setting-item {
            padding: 1.25rem;
            background: var(--background);
            border-radius: 12px;
            display: grid;
            grid-template-columns: auto 1fr 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .user-setting-item.admin-user {
            border: 2px solid var(--primary);
        }

        .user-setting-item .item-number {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            align-self: center;
        }

        .user-setting-item input,
        .user-setting-item select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .user-setting-item input:focus,
        .user-setting-item select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .user-setting-item label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.35rem;
            color: var(--text-secondary);
        }

        .admin-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Hide settings button for non-admins */
        .settings-btn.hidden {
            display: none;
        }

        /* ============================================
           Quick Links Approval Styles
           ============================================ */
        .approval-users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .approval-user-card {
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .approval-user-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .approval-user-card.selected {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .approval-user-avatar {
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 auto 0.75rem auto;
        }

        .approval-user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .approval-user-role {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .approval-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .approval-back-btn:hover {
            background: var(--border);
            color: var(--text);
        }

        .approval-user-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .approval-user-header-avatar {
            width: 44px;
            height: 44px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .approval-user-header-info h4 {
            margin: 0;
            font-size: 1rem;
            color: var(--text);
        }

        .approval-user-header-info span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .approval-links-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .approval-link-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.85rem 1rem;
            background: var(--background);
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .approval-link-item:hover {
            border-color: var(--primary);
        }

        .approval-link-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .approval-link-icon {
            font-size: 1.3rem;
        }

        .approval-link-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text);
        }

        .approval-link-url {
            font-size: 0.75rem;
            color: var(--text-secondary);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Toggle Switch */
        .approval-toggle {
            position: relative;
            width: 48px;
            height: 26px;
            flex-shrink: 0;
        }

        .approval-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .approval-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            border-radius: 26px;
            transition: 0.3s;
        }

        .approval-toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .approval-toggle input:checked + .approval-toggle-slider {
            background-color: #10b981;
        }

        .approval-toggle input:checked + .approval-toggle-slider:before {
            transform: translateX(22px);
        }

        .approval-status-label {
            font-size: 0.8rem;
            font-weight: 500;
            min-width: 75px;
            text-align: right;
            margin-right: 0.5rem;
        }

        .approval-status-label.approved {
            color: #10b981;
        }

        .approval-status-label.disapproved {
            color: #ef4444;
        }

        .approval-bulk-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .approval-bulk-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .approval-bulk-btn:hover {
            background: var(--background);
        }

        .approval-bulk-btn.approve-all {
            color: #10b981;
            border-color: #10b981;
        }

        .approval-bulk-btn.approve-all:hover {
            background: #ecfdf5;
        }

        .approval-bulk-btn.disapprove-all {
            color: #ef4444;
            border-color: #ef4444;
        }

        .approval-bulk-btn.disapprove-all:hover {
            background: #fef2f2;
        }

        .approval-no-users {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .approval-no-users span {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 0.75rem;
        }

        @media (max-width: 768px) {
            .approval-users-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .approval-link-url {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .user-setting-item {
                grid-template-columns: 1fr;
            }

            .user-display {
                border-right: none;
                padding-right: 0;
            }
        }

        /* ============================================
           Two-Factor Authentication (2FA) Styles
           ============================================ */
        .twofa-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .twofa-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .twofa-modal-header {
            text-align: center;
            margin-bottom: var(--space-6);
        }

        .twofa-modal-header h2 {
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .twofa-modal-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .twofa-qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: var(--space-6) 0;
            padding: var(--space-6);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
        }

        .twofa-qr-container canvas,
        .twofa-qr-container img {
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
        }

        .twofa-secret-key {
            font-family: var(--font-mono);
            background: var(--bg-secondary);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            letter-spacing: 2px;
            color: var(--text-primary);
            border: 1px dashed var(--border-medium);
            word-break: break-all;
            text-align: center;
        }

        .twofa-secret-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .twofa-single-input {
            width: 100%;
            padding: var(--space-4);
            text-align: center;
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: 8px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: var(--transition-fast);
        }

        .twofa-single-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
        }

        .twofa-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            margin-top: var(--space-6);
        }

        .twofa-actions button {
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .twofa-btn-primary {
            background: var(--success);
            color: white;
            border: none;
        }

        .twofa-btn-primary:hover {
            background: var(--success-dark);
        }

        .twofa-btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-medium);
        }

        .twofa-btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .twofa-btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .twofa-btn-danger:hover {
            background: var(--danger-dark);
        }

        .twofa-backup-codes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-2);
            margin: var(--space-4) 0;
            padding: var(--space-4);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .twofa-backup-code {
            font-family: var(--font-mono);
            padding: var(--space-2);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .twofa-backup-code.used {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .twofa-warning {
            background: var(--warning-bg);
            border: 1px solid var(--warning-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            font-size: 0.875rem;
            color: var(--warning-dark);
        }

        .twofa-success {
            background: var(--success-bg);
            border: 1px solid var(--success-border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin: var(--space-4) 0;
            font-size: 0.875rem;
            color: var(--success-dark);
        }

        .twofa-status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .twofa-status-badge.enabled {
            background: var(--success-bg);
            color: var(--success);
        }

        .twofa-status-badge.disabled {
            background: var(--gray-100);
            color: var(--gray-500);
        }

        .twofa-login-step {
            text-align: center;
        }

        .twofa-login-step .login-subtitle {
            margin-bottom: var(--space-4);
        }

        .twofa-use-backup {
            margin-top: var(--space-4);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .twofa-use-backup a {
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
        }

        .twofa-use-backup a:hover {
            color: var(--accent-dark);
        }

        .twofa-setup-btn {
            margin-top: var(--space-2);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
        }

        .btn-success:hover {
            background: var(--success-dark);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
            border: none;
        }

        .btn-warning:hover {
            background: var(--warning-dark);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: var(--danger-dark);
        }

        /* Input group for 2FA */
        .input-group {
            margin-bottom: var(--space-4);
        }

        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: var(--space-2);
            color: var(--text-primary);
        }

        .login-input {
            width: 100%;
            padding: var(--space-3);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: var(--transition-fast);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* ============================================
           Cloud Sync / Google Drive Styles
           ============================================ */
        .cloud-sync-container {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding-right: var(--space-4);
            border-right: 1px solid rgba(255,255,255,0.3);
        }

        .cloud-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.85rem;
        }

        .cloud-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-500);
        }

        .cloud-status-dot.connected {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
        }

        .cloud-status-dot.syncing {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .cloud-sync-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            transition: var(--transition-fast);
        }

        .cloud-sync-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .cloud-sync-btn.connect-btn {
            background: rgba(34, 197, 94, 0.3);
        }

        .cloud-sync-btn.connect-btn:hover {
            background: rgba(34, 197, 94, 0.5);
        }

        .cloud-dropdown {
            position: relative;
        }

        .cloud-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            overflow: hidden;
        }

        .cloud-dropdown-content.show {
            display: block;
        }

        .cloud-dropdown-item {
            padding: var(--space-3) var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.9rem;
        }

        .cloud-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .cloud-dropdown-item.danger {
            color: var(--danger);
        }

        .cloud-dropdown-item.danger:hover {
            background: #fef2f2;
        }

        .cloud-dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: var(--space-2) 0;
        }

        .last-sync-info {
            padding: var(--space-2) var(--space-4);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .spinning {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modal styles for Google Auth */
        .google-auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .google-auth-modal.show, .google-auth-modal[style*="display: flex"] {
            display: flex;
        }

        .google-auth-modal .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
        }

        .modal-header {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        /* 2FA Section in Users Tab */
        #current2FAStatus {
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: 1px solid var(--border);
        }

        @media (max-width: 768px) {
            .cloud-sync-container {
                padding-right: 0;
                border-right: none;
            }
        }

        /* ============================================
           Cloud Storage Tab Styles
           ============================================ */
        .storage-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .storage-stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
            transition: var(--transition-fast);
        }

        .storage-stat-card:hover {
            border-color: var(--accent);
            box-shadow: var(--shadow);
        }

        .storage-stat-icon {
            font-size: 2rem;
            margin-bottom: var(--space-2);
        }

        .storage-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .storage-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: var(--space-1);
        }

        .storage-quota-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--space-2);
        }

        .storage-quota-fill {
            height: 100%;
            border-radius: var(--radius-full);
            background: linear-gradient(90deg, var(--success) 0%, var(--accent) 50%, var(--warning) 80%, var(--danger) 100%);
            transition: width 0.5s ease;
        }

        .storage-section {
            margin-bottom: var(--space-6);
        }

        .storage-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--border);
        }

        .storage-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .auto-backup-toggle {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gray-500);
            border-radius: var(--radius-full);
            transition: var(--transition-fast);
        }

        .toggle-slider:before {
            content: '';
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: var(--transition-fast);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .auto-backup-info {
            flex: 1;
        }

        .auto-backup-info strong {
            display: block;
            margin-bottom: var(--space-1);
        }

        .auto-backup-info span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .interval-select {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .version-history-list {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
        }

        .version-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition-fast);
        }

        .version-item:last-child {
            border-bottom: none;
        }

        .version-item:hover {
            background: var(--bg-hover);
        }

        .version-item-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .version-item-info {
            flex: 1;
            min-width: 0;
        }

        .version-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .version-item-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .version-item-actions {
            display: flex;
            gap: var(--space-2);
            flex-shrink: 0;
        }

        .version-action-btn {
            padding: var(--space-1) var(--space-2);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .version-action-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .version-action-btn.danger:hover {
            background: #fef2f2;
            border-color: var(--danger);
            color: var(--danger);
        }

        .file-upload-zone {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            text-align: center;
            transition: var(--transition-fast);
            cursor: pointer;
            background: var(--bg-tertiary);
            margin-bottom: var(--space-4);
        }

        .file-upload-zone:hover, .file-upload-zone.dragover {
            border-color: var(--accent);
            background: var(--info-bg);
        }

        .file-upload-zone input[type="file"] {
            display: none;
        }

        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-3);
        }

        .file-upload-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .file-upload-text strong {
            color: var(--accent);
            cursor: pointer;
        }

        .file-upload-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: var(--space-2);
        }

        .uploaded-files-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
        }

        .uploaded-file-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition-fast);
        }

        .uploaded-file-item:last-child {
            border-bottom: none;
        }

        .uploaded-file-item:hover {
            background: var(--bg-hover);
        }

        .file-type-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .file-type-icon.doc { background: #dbeafe; }
        .file-type-icon.img { background: #dcfce7; }
        .file-type-icon.pdf { background: #fef2f2; }
        .file-type-icon.sheet { background: #fef3c7; }
        .file-type-icon.other { background: var(--gray-100); }

        .file-item-info {
            flex: 1;
            min-width: 0;
        }

        .file-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .file-item-actions {
            display: flex;
            gap: var(--space-2);
            flex-shrink: 0;
        }

        .storage-empty-state {
            text-align: center;
            padding: var(--space-8) var(--space-4);
            color: var(--text-secondary);
        }

        .storage-empty-state .empty-icon {
            font-size: 3rem;
            margin-bottom: var(--space-3);
        }

        .storage-empty-state p {
            font-size: 0.95rem;
        }

        .upload-progress-bar {
            width: 100%;
            height: 4px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            margin-top: var(--space-2);
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
            animation: progress-pulse 1.5s ease-in-out infinite;
        }

        @keyframes progress-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .storage-actions-bar {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
            margin-bottom: var(--space-4);
        }

        .storage-action-btn {
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            transition: var(--transition-fast);
        }

        .storage-action-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .storage-action-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .storage-action-btn.primary:hover {
            background: var(--primary-dark);
        }

        .storage-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .storage-not-connected {
            text-align: center;
            padding: var(--space-8) var(--space-4);
        }

        .storage-not-connected .connect-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
        }

        .storage-not-connected h3 {
            font-size: 1.2rem;
            margin-bottom: var(--space-3);
        }

        .storage-not-connected p {
            color: var(--text-secondary);
            margin-bottom: var(--space-5);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo"></div>
                <h1>School Dashboard</h1>
                <p>Sign in to access the dashboard</p>
            </div>

            <!-- First-Time User Sync Prompt -->
            <div class="first-time-sync-prompt" id="firstTimeSyncPrompt">
                <div class="sync-prompt-icon"></div>
                <h3>Cloud Sync Required</h3>
                <p>New device or first time? You must sync from Google Cloud to download your account data before you can log in.</p>
                <button type="button" class="sync-prompt-btn" onclick="initiateLoginPageSync()">
                    <span></span> Connect & Merge from Google
                </button>
                <div class="sync-prompt-dismiss">
                    <a onclick="dismissFirstTimePrompt()">I already have my data on this device</a>
                </div>
                <div class="sync-status-message" id="loginSyncStatus" style="display: none;">
                    <span class="sync-status-icon"></span>
                    <span class="sync-status-text" id="loginSyncStatusText">Connecting...</span>
                </div>
            </div>

            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-error" id="loginError">
                    <span></span>
                    <span id="loginErrorText">Invalid username or password</span>
                </div>

                <!-- Step 1: Username/Password -->
                <div id="loginStep1">
                    <div class="login-form-group">
                        <label for="username">Username</label>
                        <span class="input-icon"></span>
                        <input type="text" id="username" name="username" placeholder="Enter your username" required autocomplete="username">
                    </div>
                    <div class="login-form-group">
                        <label for="password">Password</label>
                        <span class="input-icon"></span>
                        <input type="password" id="password" name="password" placeholder="Enter your password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="login-btn">Sign In</button>
                    <div class="forgot-password-link" style="display: flex; justify-content: space-between; align-items: center;">
                        <a onclick="showForgotPassword()">Forgot Password?</a>
                        <a onclick="showFirstTimeSyncPrompt(); sessionStorage.removeItem('firstTimeSyncDismissed');" style="color: #3b82f6; cursor: pointer; font-size: 0.85rem;">Sync from Cloud</a>
                    </div>
                </div>

                <!-- Forgot Password Step: Enter Email -->
                <div id="loginStepForgotPassword" style="display: none;">
                    <div class="forgot-password-header">
                        <h3>Reset Your Password</h3>
                        <p>Enter your email address and we'll send you a one-time password (OTP) to reset your password.</p>
                    </div>
                    <div class="login-form-group">
                        <label for="forgotPasswordEmail">Email Address</label>
                        <span class="input-icon"></span>
                        <input type="email" id="forgotPasswordEmail" placeholder="Enter your email address" autocomplete="email">
                    </div>
                    <div class="forgot-password-error" id="forgotPasswordError" style="display: none;">
                        <span></span>
                        <span id="forgotPasswordErrorText">Error message</span>
                    </div>
                    <button type="button" class="login-btn" onclick="sendOTPEmail()">Send OTP</button>
                    <button type="button" class="login-btn login-btn-secondary" onclick="cancelForgotPassword()">Back to Login</button>
                </div>

                <!-- OTP Verification Step -->
                <div id="loginStepOTP" style="display: none;">
                    <div class="forgot-password-header">
                        <h3>Enter Verification Code</h3>
                        <p>We've sent a 6-digit code to your email. Enter it below to verify your identity.</p>
                    </div>
                    <div class="input-group">
                        <input type="text" id="otpCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000" autocomplete="one-time-code">
                    </div>
                    <div class="otp-error" id="otpError" style="display: none;">
                        <span></span>
                        <span id="otpErrorText">Error message</span>
                    </div>
                    <button type="button" class="login-btn" onclick="verifyOTP()">Verify Code</button>
                    <div class="otp-resend">
                        <span>Didn't receive the code? </span>
                        <a onclick="resendOTP()">Resend OTP</a>
                    </div>
                    <button type="button" class="login-btn login-btn-secondary" onclick="cancelForgotPassword()">Cancel</button>
                </div>

                <!-- New Password Step -->
                <div id="loginStepNewPassword" style="display: none;">
                    <div class="forgot-password-header">
                        <h3>Create New Password</h3>
                        <p>Enter your new password below.</p>
                    </div>
                    <div class="login-form-group">
                        <label for="newPassword">New Password</label>
                        <span class="input-icon"></span>
                        <input type="password" id="newPassword" placeholder="Enter new password">
                    </div>
                    <div class="login-form-group">
                        <label for="confirmNewPassword">Confirm Password</label>
                        <span class="input-icon"></span>
                        <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                    </div>
                    <div class="new-password-error" id="newPasswordError" style="display: none;">
                        <span></span>
                        <span id="newPasswordErrorText">Error message</span>
                    </div>
                    <button type="button" class="login-btn" onclick="resetPassword()">Reset Password</button>
                    <button type="button" class="login-btn login-btn-secondary" onclick="cancelForgotPassword()">Cancel</button>
                </div>

                <!-- Step 2: 2FA Verification -->
                <div id="loginStep2FA" style="display: none;" class="twofa-login-step">
                    <p class="login-subtitle">Enter the 6-digit code from your authenticator app</p>

                    <div class="input-group">
                        <input type="text" id="login2FACode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000" autocomplete="one-time-code">
                    </div>

                    <button type="button" class="login-btn" onclick="verify2FALogin()">Verify Code</button>

                    <div class="twofa-use-backup">
                        <a onclick="showBackupCodeInput()">Use a backup code instead</a>
                    </div>

                    <div id="backupCodeSection" style="display: none; margin-top: var(--space-4);">
                        <div class="input-group">
                            <label>Backup Code</label>
                            <input type="text" id="loginBackupCode" class="login-input" placeholder="Enter backup code" style="text-transform: uppercase; letter-spacing: 2px;">
                        </div>
                        <button type="button" class="login-btn" onclick="verifyBackupCodeLogin()" style="background: var(--warning);">Use Backup Code</button>
                    </div>

                    <button type="button" class="login-btn" onclick="cancelTwoFALogin()" style="background: transparent; color: var(--text-secondary); border: 1px solid var(--border-medium); margin-top: var(--space-3);">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container" id="dashboardContainer">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo-container" id="logoContainer">
                <span class="logo-placeholder"></span>
            </div>
            <div class="school-info">
                <h1 id="schoolName">School Dashboard</h1>
                <p id="schoolTagline">Welcome to our learning portal</p>
            </div>
        </div>
        <div class="header-right">
            <div class="datetime">
                <div class="time" id="currentTime">00:00</div>
                <div class="date" id="currentDate">Loading...</div>
            </div>

            <!-- Cloud Sync Controls -->
            <div class="cloud-sync-container" id="cloudSyncContainer">
                <div class="cloud-status" id="cloudStatus">
                    <span class="cloud-status-dot" id="cloudStatusDot"></span>
                    <span id="cloudStatusText">Not connected</span>
                </div>

                <div id="cloudNotConnected">
                    <button class="cloud-sync-btn connect-btn" onclick="connectToGoogleDrive()">
                        <span></span>
                        <span>Connect Drive</span>
                    </button>
                </div>

                <div id="cloudConnected" style="display: none;">
                    <div class="cloud-dropdown">
                        <button class="cloud-sync-btn" onclick="toggleCloudMenu()">
                            <span id="cloudMenuIcon"></span>
                            <span>Cloud</span>
                            <span style="font-size: 0.6rem;"></span>
                        </button>
                        <div class="cloud-dropdown-content" id="cloudDropdownMenu">
                            <div class="cloud-dropdown-item" onclick="mergeToCloud()">
                                <span></span>
                                <span>Merge to Cloud</span>
                            </div>
                            <div class="cloud-dropdown-item" onclick="mergeFromCloud()">
                                <span></span>
                                <span>Merge from Cloud</span>
                            </div>
                            <div class="cloud-dropdown-item" onclick="browseBackupFiles()">
                                <span></span>
                                <span>Browse All Backups</span>
                            </div>
                            <div class="cloud-dropdown-divider"></div>
                            <div class="last-sync-info" id="lastSyncInfo">
                                Last merge: Never
                            </div>
                            <div class="last-sync-info" id="lastSavedByInfo" style="color: #6b7280; font-size: 0.7rem;">
                                Last saved by: --
                            </div>
                            <div class="cloud-dropdown-divider"></div>
                            <div class="cloud-dropdown-item danger" onclick="disconnectFromGoogleDrive()">
                                <span></span>
                                <span>Disconnect</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="user-display">
                <div class="user-avatar"></div>
                <div class="user-info">
                    <div class="user-name" id="loggedInUserName">User</div>
                    <div class="user-role" id="loggedInUserRole">Role</div>
                </div>
            </div>
            <button class="settings-btn" onclick="openSettings()">
                <span></span> Settings
            </button>
            <button class="logout-btn" onclick="handleLogout()">
                <span></span> Logout
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Quick Links Section -->
        <section class="quick-links-section">
            <h2 class="section-title">Quick Links</h2>
            <div class="quick-links-grid" id="quickLinksGrid">
                <!-- Quick links will be populated here -->
            </div>
        </section>

        <!-- Main Links Section -->
        <section class="main-links-section">
            <h2 class="section-title">Main Resources</h2>
            <div class="main-links-grid" id="mainLinksGrid">
                <!-- Main links will be populated here -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p> <span id="year"></span> School Dashboard. All rights reserved.</p>
    </footer>
    </div><!-- End Dashboard Container -->

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2> Dashboard Settings</h2>
                <button class="modal-close" onclick="closeSettings()"></button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="settings-tab active" onclick="switchTab('general')">General</button>
                    <button class="settings-tab" onclick="switchTab('quickLinks')">Quick Links</button>
                    <button class="settings-tab" onclick="switchTab('mainLinks')">Main Links</button>
                    <button class="settings-tab" onclick="switchTab('users')">Users</button>
                    <button class="settings-tab" onclick="switchTab('quickLinksApproval')">Approvals</button>
                    <button class="settings-tab" id="cloudStorageTabBtn" onclick="switchTab('cloudStorage')">Cloud Storage</button>
                </div>

                <!-- General Tab -->
                <div class="tab-content active" id="generalTab">
                    <div class="logo-settings">
                        <h3 style="margin-bottom: 1rem; font-size: 1rem;">School Logo</h3>
                        <div class="current-logo-preview">
                            <div class="preview-box" id="logoPreview">
                                <span style="font-size: 2rem; color: #94a3b8;"></span>
                            </div>
                            <div class="logo-actions">
                                <div class="file-input-wrapper">
                                    <label class="file-input-label">
                                         Upload Logo
                                        <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(event)">
                                    </label>
                                </div>
                                <button class="remove-logo-btn" onclick="removeLogo()"> Remove Logo</button>
                            </div>
                        </div>

                        <div class="school-name-setting">
                            <h3 style="margin-bottom: 1rem; font-size: 1rem;">School Information</h3>
                            <div class="form-group">
                                <label>School Name</label>
                                <input type="text" id="schoolNameInput" placeholder="Enter school name">
                            </div>
                            <div class="form-group">
                                <label>Tagline / Subtitle</label>
                                <input type="text" id="schoolTaglineInput" placeholder="Enter tagline or subtitle">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Links Tab -->
                <div class="tab-content" id="quickLinksTab">
                    <div class="button-settings-list" id="quickLinksSettings">
                        <!-- Quick link settings will be populated here -->
                    </div>
                    <button class="add-button-btn" onclick="addQuickLink()">
                        <span></span> Add Quick Link
                    </button>
                </div>

                <!-- Main Links Tab -->
                <div class="tab-content" id="mainLinksTab">
                    <div class="button-settings-list" id="mainLinksSettings">
                        <!-- Main link settings will be populated here -->
                    </div>
                    <button class="add-button-btn" onclick="addMainLink()">
                        <span></span> Add Main Link
                    </button>
                </div>

                <!-- Users Tab -->
                <div class="tab-content" id="usersTab">
                    <div class="button-settings-list" id="usersSettings">
                        <!-- User settings will be populated here -->
                    </div>
                    <button class="add-button-btn" onclick="addUser()">
                        <span></span> Add User
                    </button>

                    <!-- 2FA Section for Current User -->
                    <div id="current2FAStatus">
                        <h3 style="margin-bottom: var(--space-4); font-size: 1rem;"> Two-Factor Authentication</h3>
                        <!-- 2FA status will be populated here by render2FAStatus() -->
                    </div>
                </div>

                <!-- Quick Links Approval Tab -->
                <div class="tab-content" id="quickLinksApprovalTab">
                    <div id="quickLinksApprovalContent">
                        <!-- Approval content will be populated by renderQuickLinksApprovalTab() -->
                    </div>
                </div>

                <!-- Cloud Storage Tab -->
                <div class="tab-content" id="cloudStorageTab">
                    <!-- Not Connected State -->
                    <div id="storageNotConnected" class="storage-not-connected">
                        <div class="connect-icon"></div>
                        <h3>Connect to Google Drive</h3>
                        <p>Connect your Google Drive to manage cloud storage, upload files, enable auto-backup, and browse version history.</p>
                        <button class="storage-action-btn primary" onclick="connectToGoogleDrive()">
                            <span></span> Connect Google Drive
                        </button>
                    </div>

                    <!-- Connected State -->
                    <div id="storageConnected" style="display: none;">

                        <!-- Storage Dashboard -->
                        <div class="storage-section">
                            <div class="storage-section-header">
                                <span class="storage-section-title"> Storage Overview</span>
                                <button class="storage-action-btn" onclick="refreshStorageDashboard()">
                                    <span></span> Refresh
                                </button>
                            </div>
                            <div class="storage-dashboard" id="storageDashboardCards">
                                <div class="storage-stat-card">
                                    <div class="storage-stat-icon"></div>
                                    <div class="storage-stat-value" id="storageFileCount">--</div>
                                    <div class="storage-stat-label">Files in Folder</div>
                                </div>
                                <div class="storage-stat-card">
                                    <div class="storage-stat-icon"></div>
                                    <div class="storage-stat-value" id="storageTotalSize">--</div>
                                    <div class="storage-stat-label">Total Size</div>
                                </div>
                                <div class="storage-stat-card">
                                    <div class="storage-stat-icon"></div>
                                    <div class="storage-stat-value" id="storageLastBackup">--</div>
                                    <div class="storage-stat-label">Last Backup</div>
                                </div>
                                <div class="storage-stat-card">
                                    <div class="storage-stat-icon"></div>
                                    <div class="storage-stat-value" id="storageDriveQuota">--</div>
                                    <div class="storage-stat-label">Drive Usage</div>
                                    <div class="storage-quota-bar">
                                        <div class="storage-quota-fill" id="storageQuotaFill" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Auto-Backup Settings -->
                        <div class="storage-section">
                            <div class="storage-section-header">
                                <span class="storage-section-title"> Auto-Backup</span>
                            </div>
                            <div class="auto-backup-toggle">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoBackupEnabled" onchange="toggleAutoBackup()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <div class="auto-backup-info">
                                    <strong>Automatic Backup</strong>
                                    <span>Automatically save your dashboard data to Google Drive at regular intervals</span>
                                </div>
                                <select class="interval-select" id="autoBackupInterval" onchange="updateAutoBackupInterval()">
                                    <option value="5">Every 5 min</option>
                                    <option value="15" selected>Every 15 min</option>
                                    <option value="30">Every 30 min</option>
                                    <option value="60">Every 1 hour</option>
                                </select>
                            </div>
                            <div id="autoBackupStatus" style="font-size: 0.85rem; color: var(--text-secondary); padding: 0 var(--space-2);">
                                Auto-backup is disabled
                            </div>
                        </div>

                        <!-- Backup Version History -->
                        <div class="storage-section">
                            <div class="storage-section-header">
                                <span class="storage-section-title"> Backup Version History</span>
                                <div class="storage-actions-bar" style="margin-bottom: 0;">
                                    <button class="storage-action-btn primary" onclick="createVersionedBackup()">
                                        <span></span> Create Snapshot
                                    </button>
                                    <button class="storage-action-btn" onclick="loadVersionHistory()">
                                        <span></span> Refresh
                                    </button>
                                </div>
                            </div>
                            <div id="versionHistoryList" class="version-history-list">
                                <div class="storage-empty-state">
                                    <div class="empty-icon"></div>
                                    <p>Loading version history...</p>
                                </div>
                            </div>
                        </div>

                        <!-- File Upload -->
                        <div class="storage-section">
                            <div class="storage-section-header">
                                <span class="storage-section-title"> Upload Documents</span>
                            </div>
                            <div class="file-upload-zone" id="fileUploadZone" onclick="document.getElementById('driveFileInput').click()">
                                <input type="file" id="driveFileInput" multiple onchange="handleDriveFileUpload(event)">
                                <div class="file-upload-icon"></div>
                                <div class="file-upload-text">
                                    <strong>Click to upload</strong> or drag and drop files here
                                </div>
                                <div class="file-upload-hint">
                                    PDF, DOC, XLS, Images, and more  Max 10MB per file
                                </div>
                            </div>
                            <div id="uploadProgressArea" style="display: none;">
                                <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3);">
                                    <span class="spinning"></span>
                                    <span id="uploadProgressText">Uploading...</span>
                                </div>
                                <div class="upload-progress-bar">
                                    <div class="upload-progress-fill" id="uploadProgressFill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Uploaded Files Manager -->
                        <div class="storage-section">
                            <div class="storage-section-header">
                                <span class="storage-section-title"> Files in Drive Folder</span>
                                <button class="storage-action-btn" onclick="loadUploadedFiles()">
                                    <span></span> Refresh
                                </button>
                            </div>
                            <div id="uploadedFilesList" class="uploaded-files-list">
                                <div class="storage-empty-state">
                                    <div class="empty-icon"></div>
                                    <p>Loading files...</p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()"> Save Changes</button>
            </div>
        </div>
    </div>

    <!-- 2FA Setup Modal -->
    <div id="twofaSetupModal" class="twofa-modal-overlay" style="display: none;">
        <div class="twofa-modal">
            <div class="twofa-modal-header">
                <h2>Set Up Two-Factor Authentication</h2>
                <p>Scan the QR code with Google Authenticator or any TOTP app</p>
            </div>

            <div class="twofa-qr-container">
                <div id="twofaQRCode"></div>
                <div class="twofa-secret-label">Or enter this code manually:</div>
                <div class="twofa-secret-key" id="twofaSecretKey"></div>
            </div>

            <div class="twofa-warning">
                <strong>Important:</strong> Save the secret key in a safe place. You'll need it if you lose access to your authenticator app.
            </div>

            <div class="input-group" style="margin-top: var(--space-4);">
                <label>Enter the 6-digit code to verify setup:</label>
                <input type="text" id="twofaSetupCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000">
            </div>

            <div class="twofa-actions">
                <button type="button" class="twofa-btn-secondary" onclick="closeTwoFASetup()">Cancel</button>
                <button type="button" class="twofa-btn-primary" onclick="confirmTwoFASetup()">Enable 2FA</button>
            </div>
        </div>
    </div>

    <!-- 2FA Backup Codes Modal -->
    <div id="twofaBackupModal" class="twofa-modal-overlay" style="display: none;">
        <div class="twofa-modal">
            <div class="twofa-modal-header">
                <h2>Backup Codes</h2>
                <p>Save these codes in a secure location. Each code can only be used once.</p>
            </div>

            <div class="twofa-warning">
                <strong>Warning:</strong> These codes will only be shown once. Make sure to save them now!
            </div>

            <div class="twofa-backup-codes" id="twofaBackupCodes">
                <!-- Backup codes will be populated here -->
            </div>

            <div class="twofa-actions">
                <button type="button" class="twofa-btn-secondary" onclick="copyBackupCodes()">Copy Codes</button>
                <button type="button" class="twofa-btn-primary" onclick="closeBackupCodesModal()">I've Saved These Codes</button>
            </div>
        </div>
    </div>

    <!-- 2FA Disable Confirmation Modal -->
    <div id="twofaDisableModal" class="twofa-modal-overlay" style="display: none;">
        <div class="twofa-modal">
            <div class="twofa-modal-header">
                <h2>Disable Two-Factor Authentication</h2>
                <p>Enter your current 2FA code to confirm</p>
            </div>

            <div class="twofa-warning">
                <strong>Warning:</strong> Disabling 2FA will make your account less secure.
            </div>

            <div class="input-group" style="margin-top: var(--space-4);">
                <label>Enter 6-digit code from your authenticator:</label>
                <input type="text" id="twofaDisableCode" class="twofa-single-input" maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000">
            </div>

            <div class="twofa-actions">
                <button type="button" class="twofa-btn-secondary" onclick="closeTwoFADisable()">Cancel</button>
                <button type="button" class="twofa-btn-danger" onclick="confirmTwoFADisable()">Disable 2FA</button>
            </div>
        </div>
    </div>

    <script>
        // Utility function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Default admin user
        const defaultUsers = [
            {
                username: 'Cestisadmin',
                password: 'cestisadmin123$',
                displayName: 'System Administrator',
                email: 'admin@cestis.com',
                role: 'Administrator',
                isAdmin: true
            }
        ];

        // Load users from localStorage or use defaults
        let users = JSON.parse(localStorage.getItem('dashboardUsers')) || defaultUsers;

        // Debug: Log loaded users on page load
        console.log('Loaded users from localStorage:', users.map(u => ({ username: u.username, password: u.password, isAdmin: u.isAdmin })));

        // Current logged in user (full object reference)
        let currentUser = null;

        // Temporary storage for 2FA login
        let pendingTwoFAUser = null;

        // EmailJS Configuration for OTP emails
        window.EMAILJS_PUBLIC_KEY = 'z_6Ya8J_WGJjRIGuX';
        window.EMAILJS_SERVICE_ID = 'service_v49btoq';
        window.EMAILJS_TEMPLATE_ID = 'template_80h43gm';

        // Password Reset OTP variables
        let currentOTP = null;
        let otpExpiry = null;
        let pendingResetUser = null;

        // Check if user is logged in
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            const loginPage = document.getElementById('loginPage');
            const dashboardContainer = document.getElementById('dashboardContainer');
            const settingsBtn = document.querySelector('.settings-btn');

            if (isLoggedIn) {
                loginPage.classList.add('hidden');
                dashboardContainer.classList.add('visible');
                updateUserDisplay();

                // Set currentUser from session or find in users array
                const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
                if (loggedInUser) {
                    currentUser = users.find(u => u.username.toLowerCase() === loggedInUser.username.toLowerCase()) || loggedInUser;
                }

                // Show/hide settings based on user role
                const cloudSyncContainer = document.getElementById('cloudSyncContainer');
                if (loggedInUser && loggedInUser.role === 'Administrator') {
                    settingsBtn.classList.remove('hidden');
                    if (cloudSyncContainer) cloudSyncContainer.style.display = '';
                } else {
                    settingsBtn.classList.add('hidden');
                    if (cloudSyncContainer) cloudSyncContainer.style.display = 'none';
                }
            } else {
                loginPage.classList.remove('hidden');
                dashboardContainer.classList.remove('visible');
                currentUser = null;
            }
        }

        // Update user display in header
        function updateUserDisplay() {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (loggedInUser) {
                document.getElementById('loggedInUserName').textContent = loggedInUser.displayName;
                document.getElementById('loggedInUserRole').textContent = loggedInUser.role;
            }
        }

        // Handle login form submission (case-insensitive username)
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');

            // Debug: Log login attempt and users array
            console.log('Login attempt:', { username, password });
            console.log('Available users:', users.map(u => ({ username: u.username, password: u.password, isAdmin: u.isAdmin })));

            // Find user with case-insensitive username match
            const user = users.find(u =>
                u.username.toLowerCase() === username.toLowerCase() &&
                u.password === password
            );

            // Check if username exists locally (even with wrong password)
            const usernameExists = users.find(u =>
                u.username.toLowerCase() === username.toLowerCase()
            );

            console.log('Found user:', user ? 'Yes' : 'No');
            console.log('Username exists locally:', usernameExists ? 'Yes' : 'No');

            if (user) {
                loginError.classList.remove('show');

                // Check if 2FA is enabled for this user
                if (user.twoFactorEnabled && user.twoFactorSecret) {
                    // Show 2FA step
                    pendingTwoFAUser = user;
                    document.getElementById('loginStep1').style.display = 'none';
                    document.getElementById('loginStep2FA').style.display = 'block';
                    document.getElementById('login2FACode').focus();
                } else {
                    // No 2FA, complete login directly
                    completeLogin(user);
                }
            } else if (!usernameExists) {
                // Username not found locally - likely needs cloud sync
                loginError.classList.add('show');

                const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
                const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
                const hasValidToken = savedToken && savedExpiry && new Date(savedExpiry) > new Date();

                if (hasValidToken) {
                    // Connected to cloud but user data not synced yet
                    document.getElementById('loginErrorText').textContent =
                        'Account not found locally. Syncing from cloud to get your account data...';
                    // Auto-trigger sync and retry login
                    autoSyncAndRetryLogin(username, password);
                } else {
                    // Not connected to cloud - show guidance
                    document.getElementById('loginErrorText').textContent =
                        'Account not found. Please use "Connect & Sync with Google" above to download your account data from the cloud.';
                    // Re-show the first-time sync prompt
                    showFirstTimeSyncPrompt();
                    sessionStorage.removeItem('firstTimeSyncDismissed');
                }
            } else {
                // Username exists but wrong password
                loginError.classList.add('show');
                document.getElementById('loginErrorText').textContent = 'Invalid password. Please try again.';
            }
        }

        // Auto-sync from cloud and retry login when user not found locally
        async function autoSyncAndRetryLogin(username, password) {
            const loginError = document.getElementById('loginError');
            try {
                // Initialize cloud state if needed
                const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
                if (savedToken) {
                    googleAccessToken = savedToken;
                    isCloudConnected = true;
                }

                if (!cloudFileId) {
                    const savedFileId = localStorage.getItem('schoolDashboardCloudFileId');
                    if (savedFileId) {
                        cloudFileId = savedFileId;
                    } else {
                        await findExistingBackupFile();
                    }
                }

                if (!cloudFileId) {
                    document.getElementById('loginErrorText').textContent =
                        'No cloud backup found. Please contact your administrator.';
                    return;
                }

                // Download and sync user data from cloud
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to download from cloud');
                }

                const backup = await response.json();

                if (!backup.data || !backup.version) {
                    throw new Error('Invalid backup format');
                }

                // Merge cloud data into local (protects existing local data)
                applyMergeFromCloud(backup);
                console.log('Auto-sync: Users merged from cloud:', users.length, 'users');

                // Update sync tracking
                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                lastSavedBy = backup.savedBy || 'Unknown';

                // Now retry login with synced data
                const user = users.find(u =>
                    u.username.toLowerCase() === username.toLowerCase() &&
                    u.password === password
                );

                if (user) {
                    loginError.classList.remove('show');
                    // Check if 2FA is enabled for this user
                    if (user.twoFactorEnabled && user.twoFactorSecret) {
                        pendingTwoFAUser = user;
                        document.getElementById('loginStep1').style.display = 'none';
                        document.getElementById('loginStep2FA').style.display = 'block';
                        document.getElementById('login2FACode').focus();
                    } else {
                        completeLogin(user);
                    }
                } else {
                    // Check if username exists after sync
                    const usernameExistsAfterSync = users.find(u =>
                        u.username.toLowerCase() === username.toLowerCase()
                    );
                    if (usernameExistsAfterSync) {
                        document.getElementById('loginErrorText').textContent =
                            'Cloud data synced, but the password is incorrect. Please try again.';
                    } else {
                        document.getElementById('loginErrorText').textContent =
                            'Account not found even after syncing from cloud. Please contact your administrator.';
                    }
                }
            } catch (error) {
                console.error('Auto-sync and retry login error:', error);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    document.getElementById('loginErrorText').textContent =
                        'Cloud session expired. Please use "Connect & Sync with Google" above to reconnect.';
                    localStorage.removeItem('schoolDashboardGoogleAccessToken');
                    localStorage.removeItem('schoolDashboardGoogleTokenExpiry');
                    showFirstTimeSyncPrompt();
                    sessionStorage.removeItem('firstTimeSyncDismissed');
                } else {
                    document.getElementById('loginErrorText').textContent =
                        'Could not sync from cloud: ' + error.message + '. Please try the sync button above.';
                    showFirstTimeSyncPrompt();
                    sessionStorage.removeItem('firstTimeSyncDismissed');
                }
            }
        }

        // Complete the login process
        function completeLogin(user) {
            currentUser = user;
            sessionStorage.setItem('isLoggedIn', 'true');
            sessionStorage.setItem('loggedInUser', JSON.stringify({
                username: user.username,
                displayName: user.displayName,
                role: user.role,
                isAdmin: user.isAdmin,
                twoFactorEnabled: user.twoFactorEnabled || false
            }));
            sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(user));

            // Reset login form
            pendingTwoFAUser = null;
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2FA').style.display = 'none';
            document.getElementById('backupCodeSection').style.display = 'none';
            document.getElementById('login2FACode').value = '';
            document.getElementById('loginBackupCode').value = '';

            checkAuth();
            showNotification('Welcome, ' + user.displayName + '!');

            // Check if Google Drive is connected and prompt for sync
            promptSyncOnLogin();
        }

        // Prompt user to sync from cloud on login
        function promptSyncOnLogin() {
            // Check if we have a valid Google Drive token
            const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
            const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');

            // Show prompt modal after a brief delay to let dashboard load
            setTimeout(() => {
                if (!savedToken || !savedExpiry) {
                    // Not connected to Google Drive - prompt to connect
                    showConnectCloudOnLoginModal();
                    return;
                }

                // Check if token is still valid
                const expiry = new Date(savedExpiry);
                if (expiry <= new Date()) {
                    // Token expired - prompt to reconnect
                    showConnectCloudOnLoginModal();
                    return;
                }

                // Connected with valid token - show sync prompt
                showSyncOnLoginModal();
            }, 500);
        }

        // Show connect to cloud modal on login (mandatory for all users)
        function showConnectCloudOnLoginModal() {
            const existingModal = document.getElementById('connectCloudOnLoginModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modalHTML = `
                <div id="connectCloudOnLoginModal" class="google-auth-modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-header">
                            <h2> Connect to Cloud Storage (Required)</h2>
                        </div>
                        <div style="padding: var(--space-5);">
                            <div style="text-align: center; margin-bottom: var(--space-5);">
                                <span style="font-size: 3rem;"></span>
                            </div>

                            <p style="text-align: center; color: var(--text-secondary); margin-bottom: var(--space-5);">
                                You must connect to Google Drive and merge from the cloud before accessing the dashboard. This ensures you have the latest data.
                            </p>

                            <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-5);">
                                <strong style="color: var(--info);"> Required:</strong><span style="color: var(--text-secondary); font-size: 0.9rem;"> Cloud merge is mandatory before you can use the dashboard.</span>
                            </div>

                            <div style="display: flex; gap: var(--space-3);">
                                <button class="btn btn-primary" onclick="closeConnectCloudOnLoginModal(true)" style="flex: 1;">
                                     Connect Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close connect cloud on login modal
        function closeConnectCloudOnLoginModal(shouldConnect) {
            // All users must connect - cannot skip
            if (!shouldConnect) {
                return;
            }

            const modal = document.getElementById('connectCloudOnLoginModal');
            if (modal) {
                modal.remove();
            }

            connectToGoogleDrive();
        }

        // Show sync on login modal (mandatory for all users)
        function showSyncOnLoginModal() {
            const existingModal = document.getElementById('syncOnLoginModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modalHTML = `
                <div id="syncOnLoginModal" class="google-auth-modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-header">
                            <h2> Merge from Cloud (Required)</h2>
                        </div>
                        <div style="padding: var(--space-5);">
                            <div style="text-align: center; margin-bottom: var(--space-5);">
                                <span style="font-size: 3rem;"></span>
                            </div>

                            <p style="text-align: center; color: var(--text-secondary); margin-bottom: var(--space-5);">
                                You must merge from the cloud before accessing the dashboard. This ensures you have the latest data.
                            </p>

                            <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-5);">
                                <strong style="color: var(--info);"> Required:</strong><span style="color: var(--text-secondary); font-size: 0.9rem;"> Cloud merge is mandatory before you can use the dashboard. Your local data will be preserved.</span>
                            </div>

                            <div style="display: flex; gap: var(--space-3);">
                                <button class="btn btn-primary" id="syncOnLoginMergeBtn" onclick="closeSyncOnLoginModal(true)" style="flex: 1;">
                                     Merge Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close sync on login modal
        async function closeSyncOnLoginModal(shouldSync) {
            // All users must sync - cannot skip
            if (!shouldSync) {
                return;
            }

            // Disable button to prevent double-clicks during sync
            const mergeBtn = document.getElementById('syncOnLoginMergeBtn');
            if (mergeBtn) {
                mergeBtn.disabled = true;
                mergeBtn.textContent = ' Merging...';
            }

            const success = await performAutoSyncOnLogin();

            if (success) {
                // Sync completed - remove modal and allow dashboard access
                const modal = document.getElementById('syncOnLoginModal');
                if (modal) {
                    modal.remove();
                }
                sessionStorage.setItem('cloudSyncCompleted', 'true');
            } else {
                // Sync failed - re-enable button so user can retry
                if (mergeBtn) {
                    mergeBtn.disabled = false;
                    mergeBtn.textContent = ' Retry Merge';
                }
            }
        }

        // Perform automatic sync on login - returns true on success, false on failure
        async function performAutoSyncOnLogin() {
            // Initialize token if not already done
            const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
            if (savedToken) {
                googleAccessToken = savedToken;
                isCloudConnected = true;
            }

            if (!isCloudConnected || !googleAccessToken) {
                showNotification('Could not connect to Google Drive. Please try again.', 'error');
                return false;
            }

            setCloudSyncing(true);
            updateCloudUI(true);

            try {
                // First try to find the backup file
                if (!cloudFileId) {
                    const savedFileId = localStorage.getItem('schoolDashboardCloudFileId');
                    if (savedFileId) {
                        cloudFileId = savedFileId;
                    } else {
                        await findExistingBackupFile();
                    }
                }

                if (!cloudFileId) {
                    setCloudSyncing(false);
                    // No backup exists in cloud yet - allow through (first-time setup)
                    showNotification('No cloud backup found  starting fresh. Remember to sync to cloud later.', 'warning');
                    sessionStorage.setItem('cloudSyncCompleted', 'true');
                    return true;
                }

                // Download the file
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to download backup');
                }

                const backupData = await response.json();

                // Validate backup format
                if (!backupData.data || !backupData.version) {
                    throw new Error('Invalid backup file format');
                }

                // Merge cloud data into local (protects local data)
                applyMergeFromCloud(backupData);

                // Update sync tracking
                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Update last saved by info
                lastSavedBy = backupData.savedBy || 'Unknown';
                cloudFileTimestamp = backupData.timestamp;
                updateLastSavedByDisplay();

                // Refresh UI
                loadSchoolSettings();
                renderQuickLinks();
                renderMainLinks();

                setCloudSyncing(false);

                const savedByInfo = backupData.savedBy ? ` (saved by ${backupData.savedBy})` : '';
                showNotification(`Merged from cloud${savedByInfo}`, 'success');
                return true;

            } catch (error) {
                console.error('Error merging on login:', error);
                setCloudSyncing(false);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    showNotification('Google Drive session expired. Please reconnect.', 'error');
                    // Clear invalid token
                    localStorage.removeItem('schoolDashboardGoogleAccessToken');
                    localStorage.removeItem('schoolDashboardGoogleTokenExpiry');
                    updateCloudUI(false);
                    // Show connect modal again since token is expired
                    setTimeout(() => showConnectCloudOnLoginModal(), 500);
                } else {
                    showNotification(`Merge failed: ${error.message}. Please retry.`, 'error');
                }
                return false;
            }
        }

        // Show login error message
        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            document.getElementById('loginErrorText').textContent = message;
            loginError.classList.add('show');
        }

        // Handle logout
        function handleLogout() {
            sessionStorage.removeItem('isLoggedIn');
            sessionStorage.removeItem('loggedInUser');
            sessionStorage.removeItem('firstTimeSyncDismissed'); // Reset sync prompt for next login
            sessionStorage.removeItem('cloudSyncCompleted'); // Require cloud sync again on next login
            checkAuth();
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.remove('show');
            checkFirstTimeSyncPrompt(); // Show sync prompt again on logout
        }

        // User Management Functions
        function renderUsersSettings() {
            const container = document.getElementById('usersSettings');
            container.innerHTML = users.map((user, index) => `
                <div class="user-setting-item ${user.isAdmin ? 'admin-user' : ''}">
                    <div class="item-number">${index + 1}</div>
                    <div>
                        <label>Username${user.isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}</label>
                        <input type="text" value="${escapeHtml(user.username)}" onchange="updateUser(${index}, 'username', this.value)" ${user.isAdmin ? 'readonly style="background:#e2e8f0;cursor:not-allowed;"' : ''}>
                    </div>
                    <div>
                        <label>Display Name</label>
                        <input type="text" value="${escapeHtml(user.displayName)}" onchange="updateUser(${index}, 'displayName', this.value)" ${user.isAdmin ? 'readonly style="background:#e2e8f0;cursor:not-allowed;"' : ''}>
                    </div>
                    <div>
                        <label>Email</label>
                        <input type="email" value="${escapeHtml(user.email || '')}" onchange="updateUser(${index}, 'email', this.value)" placeholder="user@example.com">
                    </div>
                    <div>
                        <label>Password</label>
                        <input type="text" value="${user.isAdmin ? '' : escapeHtml(user.password)}" onchange="updateUser(${index}, 'password', this.value)" ${user.isAdmin ? 'readonly style="background:#e2e8f0;cursor:not-allowed;"' : ''}>
                    </div>
                    <div>
                        <label>Role</label>
                        <select onchange="updateUser(${index}, 'role', this.value)" ${user.isAdmin ? 'disabled style="background:#e2e8f0;cursor:not-allowed;"' : ''}>
                            <option value="User" ${user.role === 'User' ? 'selected' : ''}>User (View Only)</option>
                            <option value="Administrator" ${user.role === 'Administrator' ? 'selected' : ''}>Administrator (Full Access)</option>
                        </select>
                    </div>
                    <button class="delete-btn" onclick="deleteUser(${index})" ${user.isAdmin ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}></button>
                </div>
            `).join('');
        }

        function updateUser(index, field, value) {
            // Prevent changing any admin fields
            if (users[index].isAdmin) {
                return;
            }
            console.log('Updating user:', { index, field, value, before: users[index][field] });
            users[index][field] = value;
            users[index].lastModified = Date.now();
            console.log('After update:', { username: users[index].username, password: users[index].password });
        }

        function addUser() {
            users.push({
                username: 'newuser',
                password: 'password123',
                displayName: 'New User',
                email: '',
                role: 'User',
                isAdmin: false,
                lastModified: Date.now()
            });
            renderUsersSettings();
        }

        function deleteUser(index) {
            // Cannot delete admin user
            if (users[index].isAdmin) {
                alert('Cannot delete the administrator account.');
                return;
            }
            if (users.length > 1) {
                users.splice(index, 1);
                renderUsersSettings();
            } else {
                alert('You must have at least one user.');
            }
        }

        // Quick Links Approval Functions
        let selectedApprovalUser = null;

        function renderQuickLinksApprovalTab() {
            const container = document.getElementById('quickLinksApprovalContent');
            const nonAdminUsers = users.filter(u => !u.isAdmin);

            if (selectedApprovalUser) {
                // Show the approval detail view for the selected user
                const user = users.find(u => u.username === selectedApprovalUser);
                if (!user) {
                    selectedApprovalUser = null;
                    renderQuickLinksApprovalTab();
                    return;
                }
                const initials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                const userQuickApprovals = quickLinkApprovals[user.username] || {};
                const userMainApprovals = mainLinkApprovals[user.username] || {};

                container.innerHTML = `
                    <button class="approval-back-btn" onclick="selectedApprovalUser=null;renderQuickLinksApprovalTab();">
                         Back to Users
                    </button>
                    <div class="approval-user-header">
                        <div class="approval-user-header-avatar">${initials}</div>
                        <div class="approval-user-header-info">
                            <h4>${escapeHtml(user.displayName)}</h4>
                            <span>${escapeHtml(user.role)} &middot; ${escapeHtml(user.username)}</span>
                        </div>
                    </div>
                    <div class="approval-bulk-actions">
                        <button class="approval-bulk-btn approve-all" onclick="bulkApproval('${escapeHtml(user.username)}', true)">Approve All</button>
                        <button class="approval-bulk-btn disapprove-all" onclick="bulkApproval('${escapeHtml(user.username)}', false)">Disapprove All</button>
                    </div>

                    <h4 style="margin: 1.25rem 0 0.75rem 0; font-size: 0.95rem; color: var(--text);">Quick Links</h4>
                    <div class="approval-links-list">
                        ${quickLinks.map((link, index) => {
                            const isApproved = userQuickApprovals[link.name] !== false;
                            return `
                            <div class="approval-link-item">
                                <div class="approval-link-info">
                                    <span class="approval-link-icon">${link.icon || ''}</span>
                                    <div>
                                        <div class="approval-link-name">${escapeHtml(link.name)}</div>
                                        <div class="approval-link-url">${escapeHtml(link.url)}</div>
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;">
                                    <span class="approval-status-label ${isApproved ? 'approved' : 'disapproved'}" id="approvalLabel_${index}">
                                        ${isApproved ? 'Approved' : 'Disapproved'}
                                    </span>
                                    <label class="approval-toggle">
                                        <input type="checkbox" ${isApproved ? 'checked' : ''} onchange="toggleQuickLinkApproval('${escapeHtml(user.username)}', ${index}, this.checked)">
                                        <span class="approval-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>

                    <h4 style="margin: 1.5rem 0 0.75rem 0; font-size: 0.95rem; color: var(--text);">Main Resources</h4>
                    <div class="approval-links-list">
                        ${mainLinks.map((link, index) => {
                            const isApproved = userMainApprovals[link.name] !== false;
                            return `
                            <div class="approval-link-item">
                                <div class="approval-link-info">
                                    <span class="approval-link-icon">${link.icon || ''}</span>
                                    <div>
                                        <div class="approval-link-name">${escapeHtml(link.name)}</div>
                                        <div class="approval-link-url">${escapeHtml(link.url)}</div>
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;">
                                    <span class="approval-status-label ${isApproved ? 'approved' : 'disapproved'}" id="mainApprovalLabel_${index}">
                                        ${isApproved ? 'Approved' : 'Disapproved'}
                                    </span>
                                    <label class="approval-toggle">
                                        <input type="checkbox" ${isApproved ? 'checked' : ''} onchange="toggleMainLinkApproval('${escapeHtml(user.username)}', ${index}, this.checked)">
                                        <span class="approval-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                `;
            } else {
                // Show user cards grid
                if (nonAdminUsers.length === 0) {
                    container.innerHTML = `
                        <div class="approval-no-users">
                            <span></span>
                            <p>No users created yet.</p>
                            <p style="font-size: 0.85rem;">Add users in the "Users" tab to manage their access.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                        Select a user to manage which quick links and main resources they can access on the dashboard.
                    </p>
                    <div class="approval-users-grid">
                        ${nonAdminUsers.map(user => {
                            const initials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                            const userQuickApprovals = quickLinkApprovals[user.username] || {};
                            const userMainApprovals = mainLinkApprovals[user.username] || {};
                            const quickApprovedCount = quickLinks.filter(link => userQuickApprovals[link.name] !== false).length;
                            const mainApprovedCount = mainLinks.filter(link => userMainApprovals[link.name] !== false).length;
                            const totalApproved = quickApprovedCount + mainApprovedCount;
                            const totalLinks = quickLinks.length + mainLinks.length;
                            return `
                            <div class="approval-user-card" onclick="selectUserForApproval('${escapeHtml(user.username)}')">
                                <div class="approval-user-avatar">${initials}</div>
                                <div class="approval-user-name">${escapeHtml(user.displayName)}</div>
                                <div class="approval-user-role">${escapeHtml(user.role)}</div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                                    ${totalApproved}/${totalLinks} links approved
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                `;
            }
        }

        function selectUserForApproval(username) {
            selectedApprovalUser = username;
            renderQuickLinksApprovalTab();
        }

        function toggleQuickLinkApproval(username, linkIndex, isApproved) {
            const linkName = quickLinks[linkIndex].name;

            if (!quickLinkApprovals[username]) {
                quickLinkApprovals[username] = {};
            }
            quickLinkApprovals[username][linkName] = isApproved;

            // Update the label text and class
            const label = document.getElementById('approvalLabel_' + linkIndex);
            if (label) {
                label.textContent = isApproved ? 'Approved' : 'Disapproved';
                label.className = 'approval-status-label ' + (isApproved ? 'approved' : 'disapproved');
            }
        }

        function toggleMainLinkApproval(username, linkIndex, isApproved) {
            const linkName = mainLinks[linkIndex].name;

            if (!mainLinkApprovals[username]) {
                mainLinkApprovals[username] = {};
            }
            mainLinkApprovals[username][linkName] = isApproved;

            // Update the label text and class
            const label = document.getElementById('mainApprovalLabel_' + linkIndex);
            if (label) {
                label.textContent = isApproved ? 'Approved' : 'Disapproved';
                label.className = 'approval-status-label ' + (isApproved ? 'approved' : 'disapproved');
            }
        }

        function bulkApproval(username, approve) {
            if (!quickLinkApprovals[username]) {
                quickLinkApprovals[username] = {};
            }
            quickLinks.forEach(link => {
                quickLinkApprovals[username][link.name] = approve;
            });
            if (!mainLinkApprovals[username]) {
                mainLinkApprovals[username] = {};
            }
            mainLinks.forEach(link => {
                mainLinkApprovals[username][link.name] = approve;
            });
            renderQuickLinksApprovalTab();
        }

        function isQuickLinkApprovedForUser(linkName, user) {
            // Admin always sees all links
            if (!user || user.isAdmin || user.role === 'Administrator') {
                return true;
            }
            const userApprovals = quickLinkApprovals[user.username];
            if (!userApprovals) {
                return true; // No approvals set = all approved by default
            }
            return userApprovals[linkName] !== false;
        }

        function isMainLinkApprovedForUser(linkName, user) {
            // Admin always sees all links
            if (!user || user.isAdmin || user.role === 'Administrator') {
                return true;
            }
            const userApprovals = mainLinkApprovals[user.username];
            if (!userApprovals) {
                return true; // No approvals set = all approved by default
            }
            return userApprovals[linkName] !== false;
        }

        // Default data
        const defaultQuickLinks = [
            { name: 'Student Portal', url: '#', icon: '' },
            { name: 'Teacher Portal', url: '#', icon: '' },
            { name: 'Library', url: '#', icon: '' },
            { name: 'Calendar', url: '#', icon: '' },
            { name: 'Announcements', url: '#', icon: '' },
            { name: 'Grades', url: '#', icon: '' },
            { name: 'Attendance', url: '#', icon: '' },
            { name: 'Email', url: '#', icon: '' }
        ];

        const defaultMainLinks = [
            { name: 'Learning Management System', url: '#', description: 'Access courses and assignments', icon: '' },
            { name: 'School Website', url: '#', description: 'Official school information', icon: '' },
            { name: 'Parent Portal', url: '#', description: 'For parents and guardians', icon: '' },
            { name: 'IT Support', url: '#', description: 'Technical assistance', icon: '' },
            { name: 'Cafeteria Menu', url: '#', description: 'Weekly meal schedule', icon: '' },
            { name: 'Sports & Activities', url: '#', description: 'Extracurricular programs', icon: '' }
        ];

        // Load data from localStorage or use defaults
        let quickLinks = JSON.parse(localStorage.getItem('quickLinks')) || defaultQuickLinks;
        let mainLinks = JSON.parse(localStorage.getItem('mainLinks')) || defaultMainLinks;
        let schoolSettings = JSON.parse(localStorage.getItem('schoolSettings')) || {
            name: 'School Dashboard',
            tagline: 'Welcome to our learning portal',
            logo: null
        };

        // Quick Link Approvals: { "username": { "linkName": true/false } }
        // If a user has no entry, all links are approved by default
        // Admin users always see all links regardless of approvals
        let quickLinkApprovals = JSON.parse(localStorage.getItem('quickLinkApprovals')) || {};

        // Main Link Approvals: { "username": { "linkName": true/false } }
        // Same logic as quick link approvals but for main resources
        let mainLinkApprovals = JSON.parse(localStorage.getItem('mainLinkApprovals')) || {};

        // Track deleted link keys so merges don't resurrect them
        let deletedQuickLinkKeys = JSON.parse(localStorage.getItem('deletedQuickLinkKeys')) || [];
        let deletedMainLinkKeys = JSON.parse(localStorage.getItem('deletedMainLinkKeys')) || [];

        // Icons for new links
        const quickIcons = ['', '', '', '', '', '', '', '', '', ''];
        const mainIcons = ['', '', '', '', '', '', '', '', '', ''];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            checkFirstTimeSyncPrompt(); // Check if first-time sync prompt should be shown
            renderQuickLinks();
            renderMainLinks();
            loadSchoolSettings();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            document.getElementById('year').textContent = new Date().getFullYear();

            // Initialize cloud sync
            initializeCloudSync();

            // Initialize Cloud Storage tab (auto-backup, etc.)
            initCloudStorageTab();

            // Initialize Google Auth after a short delay to ensure GIS library is loaded
            setTimeout(() => {
                initGoogleAuth();
            }, 500);

            // 2FA input event listeners
            const twoFAInputs = ['login2FACode', 'twofaSetupCode', 'twofaDisableCode'];
            twoFAInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // Only allow numeric input
                    input.addEventListener('input', function(e) {
                        this.value = this.value.replace(/[^0-9]/g, '');
                    });

                    // Handle Enter key
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (inputId === 'login2FACode') verify2FALogin();
                            else if (inputId === 'twofaSetupCode') confirmTwoFASetup();
                            else if (inputId === 'twofaDisableCode') confirmTwoFADisable();
                        }
                    });
                }
            });

            // Backup code input - allow alphanumeric, convert to uppercase
            const backupCodeInput = document.getElementById('loginBackupCode');
            if (backupCodeInput) {
                backupCodeInput.addEventListener('input', function(e) {
                    this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                });
                backupCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        verifyBackupCodeLogin();
                    }
                });
            }
        });

        // Render Quick Links
        function renderQuickLinks() {
            const grid = document.getElementById('quickLinksGrid');
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));

            // Filter quick links based on approvals for non-admin users
            const visibleLinks = quickLinks.filter(link => isQuickLinkApprovedForUser(link.name, loggedInUser));

            grid.innerHTML = visibleLinks.map((link, index) => {
                const hasValidUrl = link.url && link.url !== '#' && link.url.trim() !== '';
                const href = hasValidUrl ? link.url : 'javascript:void(0)';
                const target = hasValidUrl ? 'target="_blank"' : '';
                return `
                <a href="${href}" class="quick-link-card" ${target}>
                    <div class="quick-link-icon">${link.icon || ''}</div>
                    <div class="quick-link-title">${link.name}</div>
                </a>
            `;
            }).join('');
        }

        // Render Main Links
        function renderMainLinks() {
            const grid = document.getElementById('mainLinksGrid');
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));

            // Filter main links based on approvals for non-admin users
            const visibleLinks = mainLinks.filter(link => isMainLinkApprovedForUser(link.name, loggedInUser));

            grid.innerHTML = visibleLinks.map((link, index) => {
                const hasValidUrl = link.url && link.url !== '#' && link.url.trim() !== '';
                const href = hasValidUrl ? link.url : 'javascript:void(0)';
                const target = hasValidUrl ? 'target="_blank"' : '';
                return `
                <a href="${href}" class="main-link-card" ${target}>
                    <div class="main-link-icon">${link.icon || ''}</div>
                    <div class="main-link-content">
                        <h3>${link.name}</h3>
                        <p>${link.description || 'Click to open'}</p>
                    </div>
                </a>
            `;
            }).join('');
        }

        // Load School Settings
        function loadSchoolSettings() {
            document.getElementById('schoolName').textContent = schoolSettings.name;
            document.getElementById('schoolTagline').textContent = schoolSettings.tagline;
            
            const logoContainer = document.getElementById('logoContainer');
            if (schoolSettings.logo) {
                logoContainer.innerHTML = `<img src="${schoolSettings.logo}" alt="School Logo">`;
            } else {
                logoContainer.innerHTML = '<span class="logo-placeholder"></span>';
            }
        }

        // Update Date/Time
        function updateDateTime() {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', timeOptions);
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', dateOptions);
        }

        // Settings Modal
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('schoolNameInput').value = schoolSettings.name;
            document.getElementById('schoolTaglineInput').value = schoolSettings.tagline;

            // Update logo preview
            const preview = document.getElementById('logoPreview');
            if (schoolSettings.logo) {
                preview.innerHTML = `<img src="${schoolSettings.logo}" alt="Logo Preview">`;
            } else {
                preview.innerHTML = '<span style="font-size: 2rem; color: #94a3b8;"></span>';
            }

            renderQuickLinksSettings();
            renderMainLinksSettings();
            renderUsersSettings();
            render2FAStatus();
            selectedApprovalUser = null;
            renderQuickLinksApprovalTab();

            // Only show Cloud Storage tab for admin users
            const cloudStorageTabBtn = document.getElementById('cloudStorageTabBtn');
            const isAdmin = currentUser && (currentUser.isAdmin === true || currentUser.role === 'Administrator');
            if (cloudStorageTabBtn) {
                cloudStorageTabBtn.style.display = isAdmin ? '' : 'none';
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Refresh content when specific tabs are activated
            if (tabName === 'cloudStorage') {
                onCloudStorageTabActivated();
            } else if (tabName === 'quickLinksApproval') {
                renderQuickLinksApprovalTab();
            } else if (tabName === 'users') {
                renderUsersSettings();
                render2FAStatus();
            }
        }

        // Logo handling
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    schoolSettings.logo = e.target.result;
                    schoolSettings.lastModified = Date.now();
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" alt="Logo Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            schoolSettings.logo = null;
            schoolSettings.lastModified = Date.now();
            document.getElementById('logoPreview').innerHTML = '<span style="font-size: 2rem; color: #94a3b8;"></span>';
            document.getElementById('logoInput').value = '';
        }

        // Quick Links Settings
        function renderQuickLinksSettings() {
            const container = document.getElementById('quickLinksSettings');
            container.innerHTML = quickLinks.map((link, index) => `
                <div class="button-setting-item">
                    <div class="item-number">${index + 1}</div>
                    <div>
                        <label>Button Name</label>
                        <input type="text" value="${link.name}" onchange="updateQuickLink(${index}, 'name', this.value)">
                    </div>
                    <div>
                        <label>URL</label>
                        <input type="text" value="${link.url}" onchange="updateQuickLink(${index}, 'url', this.value)">
                    </div>
                    <button class="delete-btn" onclick="deleteQuickLink(${index})"></button>
                </div>
            `).join('');
        }

        function updateQuickLink(index, field, value) {
            quickLinks[index][field] = value;
            quickLinks[index].lastModified = Date.now();
        }

        function addQuickLink() {
            const randomIcon = quickIcons[Math.floor(Math.random() * quickIcons.length)];
            quickLinks.push({ name: 'New Link', url: '#', icon: randomIcon, lastModified: Date.now() });
            renderQuickLinksSettings();
        }

        function deleteQuickLink(index) {
            if (quickLinks.length > 1) {
                const deleted = quickLinks[index];
                const key = linkKey(deleted);
                if (!deletedQuickLinkKeys.includes(key)) {
                    deletedQuickLinkKeys.push(key);
                    localStorage.setItem('deletedQuickLinkKeys', JSON.stringify(deletedQuickLinkKeys));
                }
                quickLinks.splice(index, 1);
                renderQuickLinksSettings();
            } else {
                alert('You must have at least one quick link.');
            }
        }

        // Main Links Settings
        function renderMainLinksSettings() {
            const container = document.getElementById('mainLinksSettings');
            container.innerHTML = mainLinks.map((link, index) => `
                <div class="button-setting-item">
                    <div class="item-number">${index + 1}</div>
                    <div>
                        <label>Button Name</label>
                        <input type="text" value="${link.name}" onchange="updateMainLink(${index}, 'name', this.value)">
                    </div>
                    <div>
                        <label>URL</label>
                        <input type="text" value="${link.url}" onchange="updateMainLink(${index}, 'url', this.value)">
                    </div>
                    <button class="delete-btn" onclick="deleteMainLink(${index})"></button>
                </div>
            `).join('');
        }

        function updateMainLink(index, field, value) {
            mainLinks[index][field] = value;
            mainLinks[index].lastModified = Date.now();
        }

        function addMainLink() {
            const randomIcon = mainIcons[Math.floor(Math.random() * mainIcons.length)];
            mainLinks.push({ name: 'New Resource', url: '#', description: 'Click to open', icon: randomIcon, lastModified: Date.now() });
            renderMainLinksSettings();
        }

        function deleteMainLink(index) {
            if (mainLinks.length > 1) {
                const deleted = mainLinks[index];
                const key = linkKey(deleted);
                if (!deletedMainLinkKeys.includes(key)) {
                    deletedMainLinkKeys.push(key);
                    localStorage.setItem('deletedMainLinkKeys', JSON.stringify(deletedMainLinkKeys));
                }
                mainLinks.splice(index, 1);
                renderMainLinksSettings();
            } else {
                alert('You must have at least one main link.');
            }
        }

        // Save Settings
        function saveSettings() {
            // Update school settings
            schoolSettings.name = document.getElementById('schoolNameInput').value;
            schoolSettings.tagline = document.getElementById('schoolTaglineInput').value;
            schoolSettings.lastModified = Date.now();

            // Debug: Log users being saved
            console.log('Saving users to localStorage:', users.map(u => ({ username: u.username, password: u.password, isAdmin: u.isAdmin })));

            // Save to localStorage
            localStorage.setItem('quickLinks', JSON.stringify(quickLinks));
            localStorage.setItem('mainLinks', JSON.stringify(mainLinks));
            localStorage.setItem('schoolSettings', JSON.stringify(schoolSettings));
            localStorage.setItem('dashboardUsers', JSON.stringify(users));
            localStorage.setItem('quickLinkApprovals', JSON.stringify(quickLinkApprovals));
            localStorage.setItem('mainLinkApprovals', JSON.stringify(mainLinkApprovals));
            localStorage.setItem('deletedQuickLinkKeys', JSON.stringify(deletedQuickLinkKeys));
            localStorage.setItem('deletedMainLinkKeys', JSON.stringify(deletedMainLinkKeys));

            // Update display
            loadSchoolSettings();
            renderQuickLinks();
            renderMainLinks();
            
            closeSettings();
            
            // Show confirmation
            showNotification('Settings saved successfully!');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');

            // Define colors and icons for different types
            const typeConfig = {
                success: { bg: '#10b981', icon: '' },
                error: { bg: '#ef4444', icon: '' },
                warning: { bg: '#f59e0b', icon: '' },
                info: { bg: '#3b82f6', icon: '' }
            };

            const config = typeConfig[type] || typeConfig.success;

            notification.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: ${config.bg};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = config.icon + ' ' + message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // Add animation keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Close modal on outside click
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });

        // Keyboard shortcut
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSettings();
                closeTwoFASetup();
                closeBackupCodesModal();
                closeTwoFADisable();
            }
        });

        // ============================================
        // Two-Factor Authentication (2FA) Functions
        // ============================================

        // Temporary storage for 2FA setup
        let pendingTwoFASecret = null;
        let pendingBackupCodes = null;

        // Generate a random base32 secret for TOTP
        function generateTOTPSecret() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 32; i++) {
                secret += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return secret;
        }

        // Generate TOTP code from secret (for verification)
        function generateTOTPCode(secret) {
            try {
                const totp = new OTPAuth.TOTP({
                    issuer: 'School Dashboard',
                    label: currentUser ? currentUser.username : 'User',
                    algorithm: 'SHA1',
                    digits: 6,
                    period: 30,
                    secret: secret
                });
                return totp.generate();
            } catch (e) {
                console.error('Error generating TOTP:', e);
                return null;
            }
        }

        // Verify TOTP code
        function verifyTOTPCode(secret, code) {
            try {
                const totp = new OTPAuth.TOTP({
                    issuer: 'School Dashboard',
                    label: 'User',
                    algorithm: 'SHA1',
                    digits: 6,
                    period: 30,
                    secret: secret
                });
                // Allow 1 period tolerance (30 seconds before/after)
                const delta = totp.validate({ token: code, window: 1 });
                return delta !== null;
            } catch (e) {
                console.error('Error verifying TOTP:', e);
                return false;
            }
        }

        // Generate TOTP URI for QR code
        function generateTOTPUri(secret, username) {
            const issuer = 'School%20Dashboard';
            const label = encodeURIComponent(username);
            return `otpauth://totp/${issuer}:${label}?secret=${secret}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;
        }

        // Generate backup codes
        function generateBackupCodes() {
            const codes = [];
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude similar characters
            for (let i = 0; i < 8; i++) {
                let code = '';
                for (let j = 0; j < 8; j++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                codes.push({ code: code, used: false });
            }
            return codes;
        }

        // Render current user's 2FA status
        function render2FAStatus() {
            const container = document.getElementById('current2FAStatus');
            if (!container || !currentUser) return;

            if (currentUser.twoFactorEnabled) {
                const unusedCodes = currentUser.backupCodes ?
                    currentUser.backupCodes.filter(bc => !bc.used).length : 0;

                container.innerHTML = `
                    <h3 style="margin-bottom: var(--space-4); font-size: 1rem;"> Two-Factor Authentication</h3>
                    <div class="twofa-success">
                        <strong>Two-Factor Authentication is ENABLED</strong>
                        <p style="margin-top: 0.5rem;">Your account is protected with Google Authenticator.</p>
                        <p style="margin-top: 0.25rem; font-size: 0.85rem;">Backup codes remaining: ${unusedCodes}/8</p>
                    </div>
                    <div style="display: flex; gap: var(--space-3); margin-top: var(--space-4); flex-wrap: wrap;">
                        <button class="btn btn-secondary twofa-setup-btn" onclick="showBackupCodes()">View Backup Codes</button>
                        <button class="btn btn-warning twofa-setup-btn" onclick="regenerateBackupCodes()">Regenerate Backup Codes</button>
                        <button class="btn btn-danger twofa-setup-btn" onclick="openTwoFADisable()">Disable 2FA</button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <h3 style="margin-bottom: var(--space-4); font-size: 1rem;"> Two-Factor Authentication</h3>
                    <div style="background: var(--bg-tertiary); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                        <strong>Two-Factor Authentication is DISABLED</strong>
                        <p style="margin-top: 0.5rem; color: var(--text-secondary);">Add an extra layer of security to your account using Google Authenticator or any TOTP-compatible app.</p>
                    </div>
                    <button class="btn btn-success twofa-setup-btn" onclick="openTwoFASetup()">Enable 2FA</button>
                `;
            }
        }

        // Save users to localStorage
        function saveUsers() {
            localStorage.setItem('dashboardUsers', JSON.stringify(users));
        }

        // Open 2FA setup modal
        function openTwoFASetup() {
            // Generate new secret
            pendingTwoFASecret = generateTOTPSecret();

            // Display secret key
            document.getElementById('twofaSecretKey').textContent = pendingTwoFASecret.match(/.{1,4}/g).join(' ');

            // Generate QR code
            const qrContainer = document.getElementById('twofaQRCode');
            qrContainer.innerHTML = '';
            const uri = generateTOTPUri(pendingTwoFASecret, currentUser.username);

            new QRCode(qrContainer, {
                text: uri,
                width: 200,
                height: 200,
                colorDark: '#1e3a5f',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });

            // Clear verification input
            document.getElementById('twofaSetupCode').value = '';

            // Show modal
            document.getElementById('twofaSetupModal').style.display = 'flex';
        }

        // Close 2FA setup modal
        function closeTwoFASetup() {
            document.getElementById('twofaSetupModal').style.display = 'none';
            pendingTwoFASecret = null;
        }

        // Confirm 2FA setup
        function confirmTwoFASetup() {
            const code = document.getElementById('twofaSetupCode').value.trim();

            if (!code || code.length !== 6) {
                alert('Please enter the 6-digit code from your authenticator app');
                return;
            }

            if (!pendingTwoFASecret) {
                alert('Setup session expired. Please try again.');
                closeTwoFASetup();
                return;
            }

            // Verify the code
            if (verifyTOTPCode(pendingTwoFASecret, code)) {
                // Generate backup codes
                pendingBackupCodes = generateBackupCodes();

                // Update user
                const userIndex = users.findIndex(u => u.username.toLowerCase() === currentUser.username.toLowerCase());
                if (userIndex !== -1) {
                    users[userIndex].twoFactorEnabled = true;
                    users[userIndex].twoFactorSecret = pendingTwoFASecret;
                    users[userIndex].backupCodes = pendingBackupCodes;
                    saveUsers();
                    currentUser = users[userIndex];
                    sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
                }

                closeTwoFASetup();

                // Show backup codes
                showBackupCodesModal();

                render2FAStatus();
                renderUsersSettings();
            } else {
                alert('Invalid code. Please check your authenticator app and try again.');
                document.getElementById('twofaSetupCode').value = '';
                document.getElementById('twofaSetupCode').focus();
            }
        }

        // Show backup codes modal (after setup or on demand)
        function showBackupCodesModal() {
            const container = document.getElementById('twofaBackupCodes');
            const codes = pendingBackupCodes || (currentUser && currentUser.backupCodes) || [];

            container.innerHTML = codes.map(bc => `
                <div class="twofa-backup-code ${bc.used ? 'used' : ''}">${bc.code}</div>
            `).join('');

            document.getElementById('twofaBackupModal').style.display = 'flex';
        }

        // Show existing backup codes
        function showBackupCodes() {
            pendingBackupCodes = null;
            showBackupCodesModal();
        }

        // Close backup codes modal
        function closeBackupCodesModal() {
            document.getElementById('twofaBackupModal').style.display = 'none';
            pendingBackupCodes = null;
        }

        // Copy backup codes to clipboard
        function copyBackupCodes() {
            const codes = pendingBackupCodes || (currentUser && currentUser.backupCodes) || [];
            const codesText = codes.map((bc, i) => `${i + 1}. ${bc.code}${bc.used ? ' (USED)' : ''}`).join('\n');
            const fullText = `School Dashboard - Backup Codes for ${currentUser.username}\n` +
                           `Generated: ${new Date().toLocaleString()}\n\n` +
                           `${codesText}\n\n` +
                           `Keep these codes in a safe place. Each code can only be used once.`;

            navigator.clipboard.writeText(fullText).then(() => {
                alert('Backup codes copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy. Please manually select and copy the codes.');
            });
        }

        // Regenerate backup codes
        function regenerateBackupCodes() {
            if (!confirm('This will invalidate all existing backup codes. Continue?')) {
                return;
            }

            pendingBackupCodes = generateBackupCodes();

            const userIndex = users.findIndex(u => u.username.toLowerCase() === currentUser.username.toLowerCase());
            if (userIndex !== -1) {
                users[userIndex].backupCodes = pendingBackupCodes;
                saveUsers();
                currentUser = users[userIndex];
                sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
            }

            showBackupCodesModal();
            render2FAStatus();
        }

        // Open disable 2FA modal
        function openTwoFADisable() {
            document.getElementById('twofaDisableCode').value = '';
            document.getElementById('twofaDisableModal').style.display = 'flex';
        }

        // Close disable 2FA modal
        function closeTwoFADisable() {
            document.getElementById('twofaDisableModal').style.display = 'none';
        }

        // Confirm disable 2FA
        function confirmTwoFADisable() {
            const code = document.getElementById('twofaDisableCode').value.trim();

            if (!code || code.length !== 6) {
                alert('Please enter the 6-digit code from your authenticator app');
                return;
            }

            if (!currentUser || !currentUser.twoFactorSecret) {
                alert('2FA is not enabled for this account.');
                closeTwoFADisable();
                return;
            }

            // Verify the code
            if (verifyTOTPCode(currentUser.twoFactorSecret, code)) {
                const userIndex = users.findIndex(u => u.username.toLowerCase() === currentUser.username.toLowerCase());
                if (userIndex !== -1) {
                    users[userIndex].twoFactorEnabled = false;
                    users[userIndex].twoFactorSecret = null;
                    users[userIndex].backupCodes = null;
                    saveUsers();
                    currentUser = users[userIndex];
                    sessionStorage.setItem('cestisAttendanceCurrentUser', JSON.stringify(currentUser));
                }

                closeTwoFADisable();
                alert('Two-Factor Authentication has been disabled.');
                render2FAStatus();
                renderUsersSettings();
            } else {
                alert('Invalid code. Please check your authenticator app and try again.');
                document.getElementById('twofaDisableCode').value = '';
                document.getElementById('twofaDisableCode').focus();
            }
        }

        // ============================================
        // Password Reset / OTP Email Functions
        // ============================================

        // Generate a 6-digit OTP
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Show forgot password step
        function showForgotPassword() {
            document.getElementById('loginStep1').style.display = 'none';
            document.getElementById('loginStepForgotPassword').style.display = 'block';
            document.getElementById('forgotPasswordEmail').value = '';
            document.getElementById('forgotPasswordError').style.display = 'none';
            document.getElementById('forgotPasswordEmail').focus();
        }

        // Cancel forgot password and return to login
        function cancelForgotPassword() {
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStepForgotPassword').style.display = 'none';
            document.getElementById('loginStepOTP').style.display = 'none';
            document.getElementById('loginStepNewPassword').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.remove('show');
            currentOTP = null;
            otpExpiry = null;
            pendingResetUser = null;
        }

        // Show forgot password error
        function showForgotPasswordError(message) {
            const errorDiv = document.getElementById('forgotPasswordError');
            document.getElementById('forgotPasswordErrorText').textContent = message;
            errorDiv.style.display = 'flex';
        }

        // Show OTP error
        function showOTPError(message) {
            const errorDiv = document.getElementById('otpError');
            document.getElementById('otpErrorText').textContent = message;
            errorDiv.style.display = 'flex';
        }

        // Show new password error
        function showNewPasswordError(message) {
            const errorDiv = document.getElementById('newPasswordError');
            document.getElementById('newPasswordErrorText').textContent = message;
            errorDiv.style.display = 'flex';
        }

        // Send OTP to email
        function sendOTPEmail() {
            const email = document.getElementById('forgotPasswordEmail').value.trim();

            if (!email) {
                showForgotPasswordError('Please enter your email address');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showForgotPasswordError('Please enter a valid email address');
                return;
            }

            // Find user by email
            const user = users.find(u => u.email && u.email.toLowerCase() === email.toLowerCase());

            if (!user) {
                showForgotPasswordError('No account found with this email address');
                return;
            }

            // Generate OTP
            currentOTP = generateOTP();
            otpExpiry = Date.now() + (10 * 60 * 1000); // OTP valid for 10 minutes
            pendingResetUser = user;

            // Send email using EmailJS (if configured) or show demo message
            sendOTPViaEmail(user.email, currentOTP, user.fullName || user.displayName);
        }

        // Send OTP via EmailJS or show demo message
        function sendOTPViaEmail(email, otp, userName) {
            // Check if EmailJS is fully configured (public key, service ID, and template ID)
            const emailJSConfigured = typeof emailjs !== 'undefined' &&
                window.EMAILJS_PUBLIC_KEY &&
                window.EMAILJS_SERVICE_ID &&
                window.EMAILJS_TEMPLATE_ID;

            console.log('EmailJS check:', {
                emailjsDefined: typeof emailjs !== 'undefined',
                publicKey: !!window.EMAILJS_PUBLIC_KEY,
                serviceId: !!window.EMAILJS_SERVICE_ID,
                templateId: !!window.EMAILJS_TEMPLATE_ID,
                configured: emailJSConfigured
            });

            if (emailJSConfigured) {
                // Send via EmailJS - variable names must match template: {{email}}, {{passcode}}, {{time}}
                emailjs.send(window.EMAILJS_SERVICE_ID, window.EMAILJS_TEMPLATE_ID, {
                    email: email,
                    passcode: otp,
                    time: '10 minutes'
                }).then(function(response) {
                    console.log('Email sent successfully:', response);
                    showOTPStep();
                    alert('OTP sent to your email address');
                }, function(error) {
                    console.error('Email failed:', error);
                    // Show error but still allow user to continue with demo OTP
                    alert('Email sending failed: ' + (error.text || error.message || 'Unknown error') + '\n\nFalling back to demo mode.');
                    showDemoOTP(otp);
                });
            } else {
                // Demo mode - show OTP in alert (EmailJS not configured)
                console.log('EmailJS not configured, using demo mode');
                showDemoOTP(otp);
            }
        }

        // Show OTP in demo mode
        function showDemoOTP(otp) {
            showOTPStep();
            alert('DEMO MODE\n\nYour One-Time Password is:\n\n' + otp + '\n\n(In production, this would be sent to your email)\n\nThis code expires in 10 minutes.');
        }

        // Show OTP entry step
        function showOTPStep() {
            document.getElementById('loginStepForgotPassword').style.display = 'none';
            document.getElementById('loginStepOTP').style.display = 'block';
            document.getElementById('otpCode').value = '';
            document.getElementById('otpError').style.display = 'none';
            document.getElementById('otpCode').focus();
        }

        // Resend OTP
        function resendOTP() {
            if (!pendingResetUser) {
                cancelForgotPassword();
                return;
            }

            // Generate new OTP
            currentOTP = generateOTP();
            otpExpiry = Date.now() + (10 * 60 * 1000);

            // Send email
            sendOTPViaEmail(pendingResetUser.email, currentOTP, pendingResetUser.fullName || pendingResetUser.displayName);
        }

        // Verify OTP
        function verifyOTP() {
            const enteredOTP = document.getElementById('otpCode').value.trim();

            if (!enteredOTP) {
                showOTPError('Please enter the OTP code');
                return;
            }

            if (enteredOTP.length !== 6) {
                showOTPError('OTP must be 6 digits');
                return;
            }

            // Check if OTP has expired
            if (Date.now() > otpExpiry) {
                showOTPError('OTP has expired. Please request a new one.');
                return;
            }

            // Verify OTP
            if (enteredOTP === currentOTP) {
                // OTP verified, show new password step
                showNewPasswordStep();
            } else {
                showOTPError('Invalid OTP. Please check and try again.');
                document.getElementById('otpCode').value = '';
                document.getElementById('otpCode').focus();
            }
        }

        // Show new password step
        function showNewPasswordStep() {
            document.getElementById('loginStepOTP').style.display = 'none';
            document.getElementById('loginStepNewPassword').style.display = 'block';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('newPasswordError').style.display = 'none';
            document.getElementById('newPassword').focus();
        }

        // Reset password
        function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (!newPassword) {
                showNewPasswordError('Please enter a new password');
                return;
            }

            if (newPassword.length < 6) {
                showNewPasswordError('Password must be at least 6 characters long');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNewPasswordError('Passwords do not match');
                return;
            }

            if (!pendingResetUser) {
                showNewPasswordError('Session expired. Please try again.');
                cancelForgotPassword();
                return;
            }

            // Update the user's password
            const userIndex = users.findIndex(u => u.username.toLowerCase() === pendingResetUser.username.toLowerCase());
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                saveUsers();

                // Clear reset state
                currentOTP = null;
                otpExpiry = null;
                pendingResetUser = null;

                // Show success and return to login
                alert('Password reset successful! You can now log in with your new password.');
                cancelForgotPassword();
            } else {
                showNewPasswordError('User not found. Please try again.');
            }
        }

        // Verify 2FA code during login
        function verify2FALogin() {
            const code = document.getElementById('login2FACode').value.trim();

            if (!code || code.length !== 6) {
                showLoginError('Please enter a 6-digit code');
                return;
            }

            if (!pendingTwoFAUser) {
                showLoginError('Session expired. Please try again.');
                cancelTwoFALogin();
                return;
            }

            // Verify TOTP code
            if (verifyTOTPCode(pendingTwoFAUser.twoFactorSecret, code)) {
                completeLogin(pendingTwoFAUser);
            } else {
                showLoginError('Invalid code. Please try again.');
                document.getElementById('login2FACode').value = '';
                document.getElementById('login2FACode').focus();
            }
        }

        // Verify backup code during login
        function verifyBackupCodeLogin() {
            const backupCode = document.getElementById('loginBackupCode').value.trim().toUpperCase();

            if (!backupCode) {
                showLoginError('Please enter a backup code');
                return;
            }

            if (!pendingTwoFAUser) {
                showLoginError('Session expired. Please try again.');
                cancelTwoFALogin();
                return;
            }

            // Check if backup code is valid and not used
            const codeIndex = pendingTwoFAUser.backupCodes ?
                pendingTwoFAUser.backupCodes.findIndex(bc => bc.code === backupCode && !bc.used) : -1;

            if (codeIndex !== -1) {
                // Mark backup code as used
                const userIndex = users.findIndex(u => u.username.toLowerCase() === pendingTwoFAUser.username.toLowerCase());
                if (userIndex !== -1) {
                    users[userIndex].backupCodes[codeIndex].used = true;
                    saveUsers();
                    pendingTwoFAUser = users[userIndex];
                }
                completeLogin(pendingTwoFAUser);
            } else {
                showLoginError('Invalid or already used backup code');
                document.getElementById('loginBackupCode').value = '';
                document.getElementById('loginBackupCode').focus();
            }
        }

        // Show backup code input
        function showBackupCodeInput() {
            document.getElementById('backupCodeSection').style.display = 'block';
        }

        // Cancel 2FA login and go back
        function cancelTwoFALogin() {
            pendingTwoFAUser = null;
            document.getElementById('loginStep1').style.display = 'block';
            document.getElementById('loginStep2FA').style.display = 'none';
            document.getElementById('backupCodeSection').style.display = 'none';
            document.getElementById('login2FACode').value = '';
            document.getElementById('loginBackupCode').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.remove('show');
        }

        // ============================================
        // Google Drive Cloud Sync Integration
        // ============================================

        // Google Drive Configuration
        const GOOGLE_DRIVE_CONFIG = {
            // Google OAuth Client ID
            CLIENT_ID: '302497466088-0b619cqa9qno2c606k4rqp742lebc5o8.apps.googleusercontent.com',
            // Your Google Drive folder ID from the shared link
            FOLDER_ID: '1DCwR5ugP89_RYBZhcQIDHZW70CUH5WD4',
            // File name for backup
            BACKUP_FILE_NAME: 'CESTIS_MAIN_DASHBOARD_BACKUP.json',
            // API scopes needed - using 'drive' scope to allow access to shared files from any account
            SCOPES: 'https://www.googleapis.com/auth/drive'
        };

        // Cloud sync state
        let googleAccessToken = null;
        let isCloudConnected = false;
        let lastSyncTime = null;
        let cloudFileId = null;
        let lastSavedBy = null;
        let cloudFileTimestamp = null;

        // Google Token Client for OAuth
        let googleTokenClient = null;

        // Initialize cloud sync from localStorage
        function initializeCloudSync() {
            const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
            const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
            const savedLastSync = localStorage.getItem('schoolDashboardLastSyncTime');
            const savedFileId = localStorage.getItem('schoolDashboardCloudFileId');

            if (savedLastSync) {
                lastSyncTime = new Date(savedLastSync);
                updateLastSyncDisplay();
            }

            if (savedFileId) {
                cloudFileId = savedFileId;
            }

            // Check if token is still valid
            if (savedToken && savedExpiry) {
                const expiry = new Date(savedExpiry);
                if (expiry > new Date()) {
                    googleAccessToken = savedToken;
                    isCloudConnected = true;
                    updateCloudUI(true);
                    return;
                }
            }

            updateCloudUI(false);
        }

        // Update cloud UI based on connection status
        function updateCloudUI(connected) {
            const notConnectedDiv = document.getElementById('cloudNotConnected');
            const connectedDiv = document.getElementById('cloudConnected');
            const statusDot = document.getElementById('cloudStatusDot');
            const statusText = document.getElementById('cloudStatusText');

            if (connected) {
                notConnectedDiv.style.display = 'none';
                connectedDiv.style.display = 'block';
                statusDot.className = 'cloud-status-dot connected';
                statusText.textContent = 'Connected';
            } else {
                notConnectedDiv.style.display = 'block';
                connectedDiv.style.display = 'none';
                statusDot.className = 'cloud-status-dot';
                statusText.textContent = 'Not connected';
            }

            // Also update Cloud Storage tab state
            updateCloudStorageTabUI();
        }

        // Update syncing status
        function setCloudSyncing(syncing) {
            const statusDot = document.getElementById('cloudStatusDot');
            const statusText = document.getElementById('cloudStatusText');
            const menuIcon = document.getElementById('cloudMenuIcon');

            if (syncing) {
                statusDot.className = 'cloud-status-dot syncing';
                statusText.textContent = 'Merging...';
                menuIcon.innerHTML = '<span class="spinning"></span>';
            } else {
                statusDot.className = 'cloud-status-dot connected';
                statusText.textContent = 'Connected';
                menuIcon.textContent = '';
            }
        }

        // Toggle cloud dropdown menu
        function toggleCloudMenu() {
            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.toggle('show');

            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeCloudMenuOnClickOutside);
            }, 0);
        }

        function closeCloudMenuOnClickOutside(e) {
            const menu = document.getElementById('cloudDropdownMenu');
            const dropdown = document.querySelector('.cloud-dropdown');

            if (!dropdown.contains(e.target)) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeCloudMenuOnClickOutside);
            }
        }

        // Initialize Google Identity Services
        function initGoogleAuth() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                googleTokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
                    scope: GOOGLE_DRIVE_CONFIG.SCOPES,
                    callback: handleGoogleAuthCallback,
                    error_callback: handleGoogleAuthError
                });
            }
        }

        // Connect to Google Drive using OAuth
        async function connectToGoogleDrive() {
            // Always show the modal first - let user choose method
            showGoogleAuthModal();
        }

        // Show authentication modal with two options
        function showGoogleAuthModal() {
            const modalHTML = `
                <div id="googleAuthModal" class="google-auth-modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 560px;">
                        <div class="modal-header">
                            <h2> Connect to Google Drive</h2>
                            <button class="close-btn" onclick="closeGoogleAuthModal()"></button>
                        </div>
                        <div style="padding: var(--space-6);">
                            <p style="margin-bottom: var(--space-5); color: var(--text-secondary);">
                                Connect to Google Drive to save and sync your dashboard data across devices. Choose your preferred connection method:
                            </p>

                            <!-- Option 1: Direct Google Sign-In (Recommended) -->
                            <div style="background: var(--success-bg); border: 2px solid var(--success); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-4);">
                                <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                                    <span style="font-size: 1.5rem;"></span>
                                    <div>
                                        <strong style="color: var(--success); font-size: 1.1rem;">Direct Google Sign-In</strong>
                                        <span style="background: var(--success); color: white; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; margin-left: var(--space-2); font-weight: 600;">RECOMMENDED</span>
                                    </div>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-4);">
                                    A Google popup will appear for you to sign in with your Google account directly.
                                </p>
                                <button class="btn btn-success" onclick="triggerDirectGoogleSignIn()" style="width: 100%; padding: var(--space-3);">
                                    Sign in with Google
                                </button>
                            </div>

                            <!-- Option 2: Manual Token Method -->
                            <div id="manualTokenSection" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: var(--space-5);">
                                <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                                    <span style="font-size: 1.5rem;"></span>
                                    <strong style="color: var(--text-primary); font-size: 1.1rem;">Manual Token Method</strong>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-4);">
                                    If the popup doesn't work, you can still use the OAuth Playground to get a token manually.
                                </p>
                                <button class="btn btn-secondary" onclick="showManualTokenForm()" id="showManualTokenBtn" style="width: 100%;">
                                    Use Manual Method
                                </button>

                                <!-- Manual token form (hidden by default) -->
                                <div id="manualTokenForm" style="display: none; margin-top: var(--space-4);">
                                    <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
                                        <strong style="color: var(--info);">How to get your access token:</strong>
                                        <ol style="margin-top: var(--space-2); margin-left: var(--space-4); color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">
                                            <li>Click the link below to open Google OAuth Playground</li>
                                            <li>In Step 1, find and select <strong>"Drive API v3"</strong>  check <strong>"../auth/drive"</strong> (full access to shared files)</li>
                                            <li>Click <strong>"Authorize APIs"</strong> (blue button)</li>
                                            <li>Sign in with your Google account</li>
                                            <li>In Step 2, click <strong>"Exchange authorization code for tokens"</strong></li>
                                            <li>Copy the <strong>"Access token"</strong> value and paste below</li>
                                        </ol>
                                        <a href="https://developers.google.com/oauthplayground" target="_blank"
                                           style="display: inline-block; margin-top: var(--space-3); padding: var(--space-2) var(--space-4); background: var(--accent); color: white; border-radius: var(--radius-md); text-decoration: none; font-weight: 600; font-size: 0.875rem;">
                                             Open OAuth Playground
                                        </a>
                                    </div>

                                    <div class="form-group" style="margin-bottom: var(--space-4);">
                                        <label style="font-weight: 600;">Access Token</label>
                                        <textarea id="googleAccessTokenInput" rows="4" style="width: 100%; padding: var(--space-3); border: 2px solid var(--border-light); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; resize: vertical; margin-top: var(--space-2);" placeholder="Paste your access token here..."></textarea>
                                    </div>

                                    <button class="btn btn-success" onclick="submitGoogleToken()" style="width: 100%;">
                                         Connect with Token
                                    </button>
                                </div>
                            </div>

                            <div style="margin-top: var(--space-4); text-align: center;">
                                <button class="btn btn-secondary" onclick="closeGoogleAuthModal()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Trigger the direct Google Sign-In popup
        function triggerDirectGoogleSignIn() {
            closeGoogleAuthModal();
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken();
            } else {
                initGoogleAuth();
                setTimeout(() => {
                    if (googleTokenClient) {
                        googleTokenClient.requestAccessToken();
                    } else {
                        alert('Google Sign-In popup is not available. Please use the manual token method.');
                        showGoogleAuthModal();
                        // Auto-expand the manual form
                        setTimeout(() => showManualTokenForm(), 100);
                    }
                }, 500);
            }
        }

        // Show the manual token form
        function showManualTokenForm() {
            const form = document.getElementById('manualTokenForm');
            const btn = document.getElementById('showManualTokenBtn');
            if (form && btn) {
                form.style.display = 'block';
                btn.style.display = 'none';
            }
        }

        function closeGoogleAuthModal() {
            const modal = document.getElementById('googleAuthModal');
            if (modal) modal.remove();
        }

        async function submitGoogleToken() {
            const tokenInput = document.getElementById('googleAccessTokenInput');
            const token = tokenInput.value.trim();

            if (!token) {
                alert('Please enter an access token');
                return;
            }

            // Verify the token works by making a test API call
            try {
                const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Invalid token');
                }

                const data = await response.json();

                // Token is valid, save it
                googleAccessToken = token;
                isCloudConnected = true;

                // Save token with 1 hour expiry (typical for OAuth tokens)
                const expiry = new Date();
                expiry.setHours(expiry.getHours() + 1);
                localStorage.setItem('schoolDashboardGoogleAccessToken', token);
                localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

                closeGoogleAuthModal();
                updateCloudUI(true);

                alert(` Connected to Google Drive as ${data.user.displayName || data.user.emailAddress}`);

                // Try to find existing backup file
                await findExistingBackupFile();

            } catch (error) {
                console.error('Token verification failed:', error);
                alert(' Invalid access token. Please make sure you copied the correct token.');
            }
        }

        async function handleGoogleAuthCallback(tokenResponse) {
            googleAccessToken = tokenResponse.access_token;
            isCloudConnected = true;

            const expiry = new Date();
            expiry.setSeconds(expiry.getSeconds() + (tokenResponse.expires_in || 3600));
            localStorage.setItem('schoolDashboardGoogleAccessToken', googleAccessToken);
            localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

            updateCloudUI(true);

            // Check if this is a login page sync request
            if (isLoginPageSync) {
                // Handle login page sync flow
                await handleLoginPageSyncCallback();
                return;
            }

            // Try to find existing backup file
            await findExistingBackupFile();

            // Show forced sync modal after successful connection
            showForcedSyncAfterConnectModal();
        }

        // Show forced sync modal after successful Google Drive connection
        function showForcedSyncAfterConnectModal() {
            const existingModal = document.getElementById('forcedSyncModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Check if there's an existing backup to sync from
            const hasBackup = cloudFileId !== null;

            const modalHTML = `
                <div id="forcedSyncModal" class="google-auth-modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-header">
                            <h2> Connected to Google Drive!</h2>
                        </div>
                        <div style="padding: var(--space-5);">
                            <div style="text-align: center; margin-bottom: var(--space-5);">
                                <span style="font-size: 3rem;"></span>
                            </div>

                            ${hasBackup ? `
                                <p style="text-align: center; color: var(--text-secondary); margin-bottom: var(--space-5);">
                                    A cloud backup was found. Your data will be merged to ensure you have the latest information.
                                </p>

                                <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-5);">
                                    <strong style="color: var(--info);"> Safe merge:</strong>
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                        Cloud data will be merged with your local data. No local data will be lost.
                                    </span>
                                </div>

                                <button class="btn btn-primary" onclick="performForcedSyncAfterConnect()" style="width: 100%;">
                                     Merge Now
                                </button>
                            ` : `
                                <p style="text-align: center; color: var(--text-secondary); margin-bottom: var(--space-5);">
                                    No existing backup was found in the cloud. Would you like to save your current data to the cloud now?
                                </p>

                                <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-5);">
                                    <strong style="color: var(--info);"> Tip:</strong>
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                        Saving now will create a backup that other users can merge from.
                                    </span>
                                </div>

                                <div style="display: flex; gap: var(--space-3);">
                                    <button class="btn btn-secondary" onclick="closeForcedSyncModal(false)" style="flex: 1;">
                                        Skip for Now
                                    </button>
                                    <button class="btn btn-primary" onclick="performForcedSaveAfterConnect()" style="flex: 1;">
                                         Merge to Cloud
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Perform forced merge after connection (merges cloud into local, protecting local data)
        async function performForcedSyncAfterConnect() {
            const modal = document.getElementById('forcedSyncModal');

            // Update modal to show merging status
            if (modal) {
                const content = modal.querySelector('.modal-content > div:last-child');
                content.innerHTML = `
                    <div style="text-align: center; padding: var(--space-5);">
                        <div class="spinning" style="font-size: 3rem; margin-bottom: var(--space-4);"></div>
                        <p style="color: var(--text-secondary);">Merging data from cloud...</p>
                    </div>
                `;
            }

            setCloudSyncing(true);

            try {
                const backupData = await downloadCloudBackup();

                // Merge cloud data into local (protects local data)
                applyMergeFromCloud(backupData);

                // Update sync tracking
                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Update last saved by info
                lastSavedBy = backupData.savedBy || 'Unknown';
                cloudFileTimestamp = backupData.timestamp;
                updateLastSavedByDisplay();

                // Refresh UI
                loadSchoolSettings();
                renderQuickLinks();
                renderMainLinks();

                setCloudSyncing(false);
                sessionStorage.setItem('cloudSyncCompleted', 'true');
                closeForcedSyncModal(true);

                const savedByInfo = backupData.savedBy ? ` (saved by ${backupData.savedBy})` : '';
                showNotification(`Connected and merged from cloud${savedByInfo}`, 'success');

            } catch (error) {
                console.error('Error during forced merge:', error);
                setCloudSyncing(false);

                // Update modal to show error with retry option (no skip - sync is mandatory)
                if (modal) {
                    const content = modal.querySelector('.modal-content > div:last-child');
                    content.innerHTML = `
                        <div style="text-align: center; margin-bottom: var(--space-5);">
                            <span style="font-size: 3rem;"></span>
                        </div>
                        <p style="text-align: center; color: var(--danger); margin-bottom: var(--space-5);">
                            Merge failed: ${error.message}
                        </p>
                        <div style="display: flex; gap: var(--space-3);">
                            <button class="btn btn-primary" onclick="performForcedSyncAfterConnect()" style="flex: 1;">
                                 Retry Merge
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Perform save to cloud after connection (when no backup exists)
        async function performForcedSaveAfterConnect() {
            const modal = document.getElementById('forcedSyncModal');

            // Update modal to show saving status
            if (modal) {
                const content = modal.querySelector('.modal-content > div:last-child');
                content.innerHTML = `
                    <div style="text-align: center; padding: var(--space-5);">
                        <div class="spinning" style="font-size: 3rem; margin-bottom: var(--space-4);"></div>
                        <p style="color: var(--text-secondary);">Merging data to cloud...</p>
                    </div>
                `;
            }

            // Close modal and trigger save - mark sync as completed
            sessionStorage.setItem('cloudSyncCompleted', 'true');
            closeForcedSyncModal(false);
            await saveToCloud();
        }

        // Close forced sync modal
        function closeForcedSyncModal(syncSuccessful) {
            const modal = document.getElementById('forcedSyncModal');
            if (modal) {
                modal.remove();
            }
        }

        function handleGoogleAuthError(error) {
            console.error('Google auth error:', error);
            if (error.type === 'popup_closed') {
                // User closed the popup, don't show error
                // Reset login page sync flag if it was set
                if (isLoginPageSync) {
                    isLoginPageSync = false;
                    updateLoginSyncStatus('', false);
                }
                return;
            }
            // Reset login page sync flag on error
            if (isLoginPageSync) {
                isLoginPageSync = false;
                updateLoginSyncStatus('Connection failed. Please try again.', false, true);
                return;
            }
            alert('Failed to authenticate with Google. Please try the manual token method.');
            showGoogleAuthModal();
        }

        // =========================================
        // Login Page First-Time Sync Functions
        // =========================================

        let isLoginPageSync = false; // Flag to track if sync was initiated from login page

        // Initiate Google Sign-In from the login page
        function initiateLoginPageSync() {
            isLoginPageSync = true;

            // Update UI to show connecting status
            updateLoginSyncStatus('Connecting to Google...', true);

            // Disable the sync button
            const syncBtn = document.querySelector('.sync-prompt-btn');
            if (syncBtn) {
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<span></span> Connecting...';
            }

            // Trigger Google Sign-In
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken();
            } else {
                initGoogleAuth();
                setTimeout(() => {
                    if (googleTokenClient) {
                        googleTokenClient.requestAccessToken();
                    } else {
                        isLoginPageSync = false;
                        updateLoginSyncStatus('Google Sign-In not available. Please refresh and try again.', false, true);
                        resetLoginSyncButton();
                    }
                }, 500);
            }
        }

        // Handle the callback specifically for login page sync
        async function handleLoginPageSyncCallback() {
            updateLoginSyncStatus('Finding backup file...', true);

            try {
                // Find existing backup file
                await findExistingBackupFile();

                if (cloudFileId) {
                    updateLoginSyncStatus('Downloading user data...', true);

                    // Perform merge from cloud
                    const syncSuccess = await performLoginPageSync();

                    if (syncSuccess) {
                        updateLoginSyncStatus('Merge complete! You can now log in.', false, false, true);

                        // Hide the first-time prompt after successful sync
                        setTimeout(() => {
                            hideFirstTimeSyncPrompt();
                        }, 2000);
                    } else {
                        updateLoginSyncStatus('Merge failed. Please try again.', false, true);
                        resetLoginSyncButton();
                    }
                } else {
                    updateLoginSyncStatus('No backup found. Please contact your administrator.', false, true);
                    resetLoginSyncButton();
                }
            } catch (error) {
                console.error('Login page sync error:', error);
                updateLoginSyncStatus('Merge failed: ' + error.message, false, true);
                resetLoginSyncButton();
            }

            isLoginPageSync = false;
        }

        // Perform the actual sync for login page
        async function performLoginPageSync() {
            try {
                if (!cloudFileId || !googleAccessToken) {
                    return false;
                }

                const backup = await downloadCloudBackup();

                // Use centralized merge function for consistency
                applyMergeFromCloud(backup);
                console.log('Users merged from cloud:', users.length, 'users');

                // Update last sync info
                lastSyncTime = new Date();
                lastSavedBy = backup.savedBy || 'Unknown';
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());

                return true;
            } catch (error) {
                console.error('Perform login page sync error:', error);
                return false;
            }
        }

        // Update the sync status message on login page
        function updateLoginSyncStatus(message, isLoading, isError = false, isSuccess = false) {
            const statusDiv = document.getElementById('loginSyncStatus');
            const statusText = document.getElementById('loginSyncStatusText');
            const statusIcon = statusDiv ? statusDiv.querySelector('.sync-status-icon') : null;

            if (!statusDiv || !statusText) return;

            if (message) {
                statusDiv.style.display = 'flex';
                statusText.textContent = message;

                // Update icon and styling
                statusDiv.classList.remove('success', 'error');
                if (isSuccess) {
                    statusDiv.classList.add('success');
                    if (statusIcon) statusIcon.textContent = '';
                } else if (isError) {
                    statusDiv.classList.add('error');
                    if (statusIcon) statusIcon.textContent = '';
                } else {
                    if (statusIcon) statusIcon.textContent = '';
                }
            } else {
                statusDiv.style.display = 'none';
            }
        }

        // Reset the sync button to its original state
        function resetLoginSyncButton() {
            const syncBtn = document.querySelector('.sync-prompt-btn');
            if (syncBtn) {
                syncBtn.disabled = false;
                syncBtn.innerHTML = '<span></span> Connect & Sync with Google';
            }
        }

        // Dismiss the first-time sync prompt
        function dismissFirstTimePrompt() {
            hideFirstTimeSyncPrompt();
            // Store preference to not show the prompt again this session
            sessionStorage.setItem('firstTimeSyncDismissed', 'true');
        }

        // Hide the first-time sync prompt
        function hideFirstTimeSyncPrompt() {
            const prompt = document.getElementById('firstTimeSyncPrompt');
            if (prompt) {
                prompt.classList.add('hidden');
            }
        }

        // Show the first-time sync prompt
        function showFirstTimeSyncPrompt() {
            const prompt = document.getElementById('firstTimeSyncPrompt');
            if (prompt) {
                prompt.classList.remove('hidden');
            }
        }

        // Check if first-time sync prompt should be shown
        function checkFirstTimeSyncPrompt() {
            // Don't show if user is already logged in
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                hideFirstTimeSyncPrompt();
                return;
            }

            // Always show if only default users exist (no cloud data synced yet)
            const hasOnlyDefaultUsers = users.length === 1 &&
                users[0].username === 'Cestisadmin';

            if (hasOnlyDefaultUsers) {
                // Force show - cloud sync is essential for non-admin users
                showFirstTimeSyncPrompt();
                return;
            }

            // Don't show if already dismissed this session and users exist
            if (sessionStorage.getItem('firstTimeSyncDismissed') === 'true') {
                hideFirstTimeSyncPrompt();
                return;
            }

            // Show the prompt by default for login page
            showFirstTimeSyncPrompt();
        }

        // Disconnect from Google Drive
        function disconnectFromGoogleDrive() {
            if (confirm('Are you sure you want to disconnect from Google Drive? Your local data will remain intact.')) {
                googleAccessToken = null;
                isCloudConnected = false;
                cloudFileId = null;

                localStorage.removeItem('schoolDashboardGoogleAccessToken');
                localStorage.removeItem('schoolDashboardGoogleTokenExpiry');
                localStorage.removeItem('schoolDashboardCloudFileId');

                updateCloudUI(false);
                toggleCloudMenu();

                alert(' Disconnected from Google Drive');
            }
        }

        // Find existing backup file in the folder
        async function findExistingBackupFile() {
            try {
                const query = `name='${GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME}' and '${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime)`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    if (data.files && data.files.length > 0) {
                        cloudFileId = data.files[0].id;
                        localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
                        console.log('Found existing backup file:', cloudFileId);
                    }
                }
            } catch (error) {
                console.error('Error finding backup file:', error);
            }
        }

        // ========== MERGE UTILITY FUNCTIONS ==========
        // Merge users: uses timestamps for conflicts, preserves users unique to each side
        function mergeUsers(localUsers, cloudUsers) {
            if (!cloudUsers || !cloudUsers.length) return localUsers;
            if (!localUsers || !localUsers.length) return cloudUsers;

            const merged = [...localUsers];

            for (const cloudUser of cloudUsers) {
                const localIndex = merged.findIndex(u => u.username === cloudUser.username);
                if (localIndex >= 0) {
                    // Both sides have this user - use timestamp to determine which is newer
                    const localMod = merged[localIndex].lastModified || 0;
                    const cloudMod = cloudUser.lastModified || 0;
                    if (cloudMod > localMod) {
                        // Cloud user is newer - use it (preserve any local-only fields)
                        merged[localIndex] = { ...merged[localIndex], ...cloudUser };
                    } else if (localMod > cloudMod) {
                        // Local user is newer - keep it (but pick up any cloud-only fields)
                        merged[localIndex] = { ...cloudUser, ...merged[localIndex] };
                    }
                    // If equal timestamps (or both 0): keep local as-is (no overwrite)
                } else {
                    // New user from cloud - add it
                    merged.push(cloudUser);
                }
            }
            return merged;
        }

        // Merge arrays of links by name+url key: adds new items from both sides, uses timestamps for conflicts
        // deletedKeys (optional): array of keys that were explicitly deleted and should not be re-added
        function mergeArrayByKey(localArr, cloudArr, keyFn, deletedKeys) {
            const hasDeleted = deletedKeys && deletedKeys.length;

            if (!cloudArr || !cloudArr.length) {
                if (hasDeleted) return localArr.filter(item => !deletedKeys.includes(keyFn(item)));
                return localArr;
            }
            if (!localArr || !localArr.length) {
                if (hasDeleted) return cloudArr.filter(item => !deletedKeys.includes(keyFn(item)));
                return cloudArr;
            }

            // Filter both arrays against deleted keys before merging
            const filtered = hasDeleted ? localArr.filter(item => !deletedKeys.includes(keyFn(item))) : localArr;
            const merged = [...filtered];

            for (const cloudItem of cloudArr) {
                const key = keyFn(cloudItem);
                // Skip items that were explicitly deleted
                if (hasDeleted && deletedKeys.includes(key)) continue;

                const localIndex = merged.findIndex(item => keyFn(item) === key);
                if (localIndex >= 0) {
                    // Both sides have this item - use timestamp to determine which is newer
                    const localMod = merged[localIndex].lastModified || 0;
                    const cloudMod = cloudItem.lastModified || 0;
                    if (cloudMod > localMod) {
                        // Cloud item is newer - use it (preserve any local-only fields)
                        merged[localIndex] = { ...merged[localIndex], ...cloudItem };
                    } else if (localMod > cloudMod) {
                        // Local item is newer - keep it (but pick up any cloud-only fields)
                        merged[localIndex] = { ...cloudItem, ...merged[localIndex] };
                    }
                    // If equal timestamps (or both 0): keep local as-is (no overwrite)
                } else {
                    // New item from cloud - add it
                    merged.push(cloudItem);
                }
            }
            return merged;
        }

        // Key function for links: use name + url as unique identifier
        function linkKey(item) {
            return (item.name || '').toLowerCase() + '||' + (item.url || '').toLowerCase();
        }

        // Merge settings objects using timestamps: newer settings take priority
        function mergeSettings(settingsA, settingsB) {
            if (!settingsB) return settingsA;
            if (!settingsA) return settingsB;

            const modA = settingsA.lastModified || 0;
            const modB = settingsB.lastModified || 0;

            // Determine priority: newer settings win, equal keeps A (first param)
            let base, priority;
            if (modB > modA) {
                base = settingsA;
                priority = settingsB;
            } else {
                base = settingsB;
                priority = settingsA;
            }

            const merged = { ...base, ...priority };
            // For nested objects, deep merge them too
            for (const key in base) {
                if (base[key] && typeof base[key] === 'object' && !Array.isArray(base[key])) {
                    if (priority[key] && typeof priority[key] === 'object') {
                        merged[key] = { ...base[key], ...priority[key] };
                    }
                }
            }
            return merged;
        }

        // Merge approval maps: symmetric deep merge, second argument wins for conflicts
        // In applyMergeFromCloud: mergeApprovals(local, cloud)  cloud changes come through
        // In applyMergeToCloud: mergeApprovals(cloud, local)  local changes take priority
        function mergeApprovals(approvalsA, approvalsB) {
            if (!approvalsB) return approvalsA;
            if (!approvalsA) return approvalsB;

            const allUsernames = new Set([...Object.keys(approvalsA), ...Object.keys(approvalsB)]);
            const merged = {};

            for (const username of allUsernames) {
                const a = approvalsA[username];
                const b = approvalsB[username];

                if (a && b) {
                    // Both sides have entries for this user - B (second arg) wins for conflicts
                    merged[username] = { ...a, ...b };
                } else {
                    merged[username] = { ...(a || b) };
                }
            }
            return merged;
        }

        // Download current cloud backup data (reusable helper)
        async function downloadCloudBackup(fileId) {
            const response = await fetch(
                `https://www.googleapis.com/drive/v3/files/${fileId || cloudFileId}?alt=media`,
                {
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error('Failed to download backup');
            }

            const backupData = await response.json();

            if (!backupData.data || !backupData.version) {
                throw new Error('Invalid backup file format');
            }

            return backupData;
        }

        // Apply merge from cloud data into local data (reusable helper)
        function applyMergeFromCloud(backupData) {
            let mergedCounts = { users: 0, quickLinks: 0, mainLinks: 0, settings: false, approvals: false };

            // Merge deleted keys from cloud first (union with local)
            if (backupData.data.deletedQuickLinkKeys) {
                for (const key of backupData.data.deletedQuickLinkKeys) {
                    if (!deletedQuickLinkKeys.includes(key)) deletedQuickLinkKeys.push(key);
                }
                localStorage.setItem('deletedQuickLinkKeys', JSON.stringify(deletedQuickLinkKeys));
            }
            if (backupData.data.deletedMainLinkKeys) {
                for (const key of backupData.data.deletedMainLinkKeys) {
                    if (!deletedMainLinkKeys.includes(key)) deletedMainLinkKeys.push(key);
                }
                localStorage.setItem('deletedMainLinkKeys', JSON.stringify(deletedMainLinkKeys));
            }

            if (backupData.data.users) {
                const before = users.length;
                users = mergeUsers(users, backupData.data.users);
                mergedCounts.users = users.length - before;
                saveUsers();
            }

            if (backupData.data.quickLinks) {
                const before = quickLinks.length;
                quickLinks = mergeArrayByKey(quickLinks, backupData.data.quickLinks, linkKey, deletedQuickLinkKeys);
                mergedCounts.quickLinks = quickLinks.length - before;
                localStorage.setItem('quickLinks', JSON.stringify(quickLinks));
            }

            if (backupData.data.mainLinks) {
                const before = mainLinks.length;
                mainLinks = mergeArrayByKey(mainLinks, backupData.data.mainLinks, linkKey, deletedMainLinkKeys);
                mergedCounts.mainLinks = mainLinks.length - before;
                localStorage.setItem('mainLinks', JSON.stringify(mainLinks));
            }

            if (backupData.data.schoolSettings) {
                schoolSettings = mergeSettings(schoolSettings, backupData.data.schoolSettings);
                mergedCounts.settings = true;
                localStorage.setItem('schoolSettings', JSON.stringify(schoolSettings));
            }

            if (backupData.data.quickLinkApprovals) {
                quickLinkApprovals = mergeApprovals(quickLinkApprovals, backupData.data.quickLinkApprovals);
                mergedCounts.approvals = true;
                localStorage.setItem('quickLinkApprovals', JSON.stringify(quickLinkApprovals));
            }
            if (backupData.data.mainLinkApprovals) {
                mainLinkApprovals = mergeApprovals(mainLinkApprovals, backupData.data.mainLinkApprovals);
                mergedCounts.approvals = true;
                localStorage.setItem('mainLinkApprovals', JSON.stringify(mainLinkApprovals));
            }

            return mergedCounts;
        }

        // Apply merge to cloud: merges local data INTO cloud data (local takes priority, cloud-only items preserved)
        function applyMergeToCloud(cloudBackupData) {
            let mergedData = {};

            // Combine deleted keys from both local and cloud (union)
            let combinedDeletedQuick = [...deletedQuickLinkKeys];
            let combinedDeletedMain = [...deletedMainLinkKeys];
            if (cloudBackupData && cloudBackupData.data) {
                if (cloudBackupData.data.deletedQuickLinkKeys) {
                    for (const key of cloudBackupData.data.deletedQuickLinkKeys) {
                        if (!combinedDeletedQuick.includes(key)) combinedDeletedQuick.push(key);
                    }
                }
                if (cloudBackupData.data.deletedMainLinkKeys) {
                    for (const key of cloudBackupData.data.deletedMainLinkKeys) {
                        if (!combinedDeletedMain.includes(key)) combinedDeletedMain.push(key);
                    }
                }
            }

            if (cloudBackupData && cloudBackupData.data) {
                mergedData.users = mergeUsers(cloudBackupData.data.users, users);
                mergedData.quickLinks = mergeArrayByKey(cloudBackupData.data.quickLinks, quickLinks, linkKey, combinedDeletedQuick);
                mergedData.mainLinks = mergeArrayByKey(cloudBackupData.data.mainLinks, mainLinks, linkKey, combinedDeletedMain);
                mergedData.schoolSettings = mergeSettings(cloudBackupData.data.schoolSettings, schoolSettings);
                mergedData.quickLinkApprovals = mergeApprovals(cloudBackupData.data.quickLinkApprovals, quickLinkApprovals);
                mergedData.mainLinkApprovals = mergeApprovals(cloudBackupData.data.mainLinkApprovals, mainLinkApprovals);
            } else {
                mergedData = {
                    users: users,
                    quickLinks: quickLinks,
                    mainLinks: mainLinks,
                    schoolSettings: schoolSettings,
                    quickLinkApprovals: quickLinkApprovals,
                    mainLinkApprovals: mainLinkApprovals,
                    deletedQuickLinkKeys: deletedQuickLinkKeys,
                    deletedMainLinkKeys: deletedMainLinkKeys
                };
            }

            // Include deleted keys in the cloud backup
            mergedData.deletedQuickLinkKeys = combinedDeletedQuick;
            mergedData.deletedMainLinkKeys = combinedDeletedMain;

            return mergedData;
        }
        // ========== END MERGE UTILITY FUNCTIONS ==========

        // Check cloud file for changes before saving (multi-user conflict detection)
        async function checkCloudForChanges() {
            if (!cloudFileId || !googleAccessToken) return null;

            try {
                // Fetch the current cloud file to check who last saved and when
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const backupData = await response.json();
                    return {
                        savedBy: backupData.savedBy || 'Unknown',
                        timestamp: backupData.timestamp
                    };
                }
            } catch (error) {
                console.error('Error checking cloud for changes:', error);
            }
            return null;
        }

        // Merge data to Google Drive - merges local data into cloud instead of overwriting
        async function mergeToCloud() {
            if (!isCloudConnected || !googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.remove('show');

            // Check for changes by others before saving
            const cloudInfo = await checkCloudForChanges();

            let confirmMessage = ' MERGE TO CLOUD\n\n';
            confirmMessage += 'Your local data will be merged into the shared cloud backup.\n\n';

            if (cloudInfo && cloudInfo.savedBy) {
                const cloudTime = new Date(cloudInfo.timestamp);
                const timeSinceLastSave = getTimeAgo(cloudTime);
                confirmMessage += `Last saved by: ${cloudInfo.savedBy} (${timeSinceLastSave})\n\n`;
            }

            confirmMessage += ' Your local changes will be added to the cloud\n';
            confirmMessage += ' Existing cloud-only data will be preserved\n';
            confirmMessage += ' No data will be lost from either side\n\n';
            confirmMessage += 'Continue?';

            if (!confirm(confirmMessage)) {
                return;
            }

            setCloudSyncing(true);

            try {
                // Download existing cloud data first (if any) to merge with
                let existingCloudData = null;
                if (cloudFileId) {
                    try {
                        existingCloudData = await downloadCloudBackup();
                    } catch (e) {
                        console.log('No existing cloud data to merge with, will create fresh backup');
                    }
                }

                // Merge local data into cloud data (local takes priority, cloud-only items preserved)
                const mergedData = applyMergeToCloud(existingCloudData);

                // Prepare merged backup
                const backupData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    savedBy: currentUser ? currentUser.username : 'Unknown',
                    data: mergedData
                };

                const jsonContent = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });

                let response;

                if (cloudFileId) {
                    // Update existing file with merged data
                    response = await fetch(
                        `https://www.googleapis.com/upload/drive/v3/files/${cloudFileId}?uploadType=media`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: blob
                        }
                    );
                } else {
                    // Create new file with metadata
                    const metadata = {
                        name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,
                        parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
                        mimeType: 'application/json'
                    };

                    const formData = new FormData();
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    formData.append('file', blob);

                    response = await fetch(
                        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${googleAccessToken}`
                            },
                            body: formData
                        }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        cloudFileId = result.id;
                        localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
                    }
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Upload failed');
                }

                // Update last sync time
                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Update last saved by info
                lastSavedBy = currentUser ? currentUser.username : 'Unknown';
                cloudFileTimestamp = new Date().toISOString();
                updateLastSavedByDisplay();

                setCloudSyncing(false);
                alert(` Data merged to cloud successfully!\n\nMerged by: ${lastSavedBy}\n\n Both local and cloud data have been preserved.`);

            } catch (error) {
                console.error('Error merging to cloud:', error);
                setCloudSyncing(false);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    alert(' Your session has expired. Please reconnect to Google Drive.');
                    disconnectFromGoogleDrive();
                } else {
                    alert(` Failed to merge to cloud: ${error.message}`);
                }
            }
        }

        // Keep saveToCloud as alias for backward compatibility
        function saveToCloud() { return mergeToCloud(); }

        // Merge (download & merge) data from Google Drive - protects local data
        async function mergeFromCloud() {
            if (!isCloudConnected || !googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.remove('show');

            // First try to find the file if we don't have the ID
            if (!cloudFileId) {
                await findExistingBackupFile();
            }

            if (!cloudFileId) {
                alert(' No backup file found in Google Drive. Save your data first to create a backup.');
                return;
            }

            if (!confirm(' MERGE FROM CLOUD\n\nThis will merge cloud data into your local data.\n\n New items from cloud will be added\n Existing local items will be preserved\n No local data will be lost\n\nContinue?')) {
                return;
            }

            setCloudSyncing(true);

            try {
                const backupData = await downloadCloudBackup();

                // Merge cloud data into local data (local takes priority)
                const mergedCounts = applyMergeFromCloud(backupData);

                // Update last sync time
                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Refresh UI
                loadSchoolSettings();
                renderQuickLinks();
                renderMainLinks();

                setCloudSyncing(false);

                // Update last saved by info
                lastSavedBy = backupData.savedBy || 'Unknown';
                cloudFileTimestamp = backupData.timestamp;
                updateLastSavedByDisplay();

                const backupTime = new Date(backupData.timestamp).toLocaleString();
                const savedByInfo = backupData.savedBy ? `\nCloud backup by: ${backupData.savedBy}` : '';
                let summary = ` Data merged from cloud successfully!\n\nBackup was created: ${backupTime}${savedByInfo}`;
                if (mergedCounts.users > 0) summary += `\n ${mergedCounts.users} new user(s) added`;
                if (mergedCounts.quickLinks > 0) summary += `\n ${mergedCounts.quickLinks} new quick link(s) added`;
                if (mergedCounts.mainLinks > 0) summary += `\n ${mergedCounts.mainLinks} new main link(s) added`;
                summary += '\n\n Your local data has been preserved.';
                alert(summary);

            } catch (error) {
                console.error('Error merging from cloud:', error);
                setCloudSyncing(false);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    alert(' Your session has expired. Please reconnect to Google Drive.');
                    disconnectFromGoogleDrive();
                } else {
                    alert(` Failed to merge from cloud: ${error.message}`);
                }
            }
        }

        // Keep syncFromCloud as alias for backward compatibility
        function syncFromCloud() { return mergeFromCloud(); }

        // ============================================
        // CLOUD STORAGE TAB - Full Google Drive Storage
        // Admin-only feature
        // ============================================

        function isCurrentUserAdmin() {
            return currentUser && (currentUser.isAdmin === true || currentUser.role === 'Administrator');
        }

        // Auto-backup state
        let autoBackupTimer = null;
        let autoBackupEnabled = false;
        let autoBackupIntervalMinutes = 15;
        let lastAutoBackupTime = null;

        // Initialize Cloud Storage tab state
        function initCloudStorageTab() {
            // Load auto-backup preferences
            const savedAutoBackup = localStorage.getItem('schoolDashboardAutoBackup');
            if (savedAutoBackup) {
                try {
                    const prefs = JSON.parse(savedAutoBackup);
                    autoBackupEnabled = prefs.enabled || false;
                    autoBackupIntervalMinutes = prefs.interval || 15;
                } catch (e) {
                    console.warn('Failed to load auto-backup preferences');
                }
            }

            const savedLastAutoBackup = localStorage.getItem('schoolDashboardLastAutoBackup');
            if (savedLastAutoBackup) {
                lastAutoBackupTime = new Date(savedLastAutoBackup);
            }

            // Apply saved state to UI
            const toggle = document.getElementById('autoBackupEnabled');
            const intervalSelect = document.getElementById('autoBackupInterval');
            if (toggle) toggle.checked = autoBackupEnabled;
            if (intervalSelect) intervalSelect.value = autoBackupIntervalMinutes.toString();

            // Start auto-backup if enabled
            if (autoBackupEnabled && isCloudConnected) {
                startAutoBackup();
            }

            updateAutoBackupStatusDisplay();
        }

        // Update Cloud Storage tab UI based on connection state
        function updateCloudStorageTabUI() {
            const notConnected = document.getElementById('storageNotConnected');
            const connected = document.getElementById('storageConnected');

            if (!notConnected || !connected) return;

            if (isCloudConnected) {
                notConnected.style.display = 'none';
                connected.style.display = 'block';
            } else {
                notConnected.style.display = 'block';
                connected.style.display = 'none';
            }
        }

        // ==========================================
        // Storage Dashboard & Quota
        // ==========================================

        async function refreshStorageDashboard() {
            if (!isCloudConnected || !googleAccessToken) return;

            try {
                // Fetch Drive storage quota
                const aboutResponse = await fetch(
                    'https://www.googleapis.com/drive/v3/about?fields=storageQuota,user',
                    {
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                    }
                );

                if (aboutResponse.ok) {
                    const aboutData = await aboutResponse.json();
                    const quota = aboutData.storageQuota;

                    if (quota) {
                        const usedBytes = parseInt(quota.usage || 0);
                        const limitBytes = parseInt(quota.limit || 0);
                        const usedFormatted = formatFileSize(usedBytes);
                        const limitFormatted = limitBytes > 0 ? formatFileSize(limitBytes) : 'Unlimited';
                        const percentage = limitBytes > 0 ? Math.round((usedBytes / limitBytes) * 100) : 0;

                        document.getElementById('storageDriveQuota').textContent =
                            limitBytes > 0 ? `${percentage}%` : usedFormatted;

                        const quotaFill = document.getElementById('storageQuotaFill');
                        if (quotaFill) {
                            quotaFill.style.width = limitBytes > 0 ? `${Math.min(percentage, 100)}%` : '0%';
                        }

                        // Update tooltip-style info
                        const quotaCard = quotaFill ? quotaFill.closest('.storage-stat-card') : null;
                        if (quotaCard) {
                            const label = quotaCard.querySelector('.storage-stat-label');
                            if (label) label.textContent = `${usedFormatted} of ${limitFormatted}`;
                        }
                    }
                }

                // List files in the folder to get counts and sizes
                const query = `'${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
                const filesResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,size,modifiedTime,mimeType)&pageSize=1000`,
                    {
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                    }
                );

                if (filesResponse.ok) {
                    const filesData = await filesResponse.json();
                    const files = filesData.files || [];

                    // File count
                    document.getElementById('storageFileCount').textContent = files.length;

                    // Total size
                    const totalSize = files.reduce((sum, f) => sum + parseInt(f.size || 0), 0);
                    document.getElementById('storageTotalSize').textContent = formatFileSize(totalSize);

                    // Last backup time
                    const backupFiles = files.filter(f =>
                        f.name.startsWith('CESTIS_MAIN_DASHBOARD') && f.mimeType === 'application/json'
                    );

                    if (backupFiles.length > 0) {
                        backupFiles.sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));
                        const lastBackupTime = new Date(backupFiles[0].modifiedTime);
                        document.getElementById('storageLastBackup').textContent = getTimeAgo(lastBackupTime);
                    } else {
                        document.getElementById('storageLastBackup').textContent = 'Never';
                    }
                }

            } catch (error) {
                console.error('Error refreshing storage dashboard:', error);
            }
        }

        // ==========================================
        // Auto-Backup System
        // ==========================================

        function toggleAutoBackup() {
            const toggle = document.getElementById('autoBackupEnabled');
            autoBackupEnabled = toggle.checked;

            saveAutoBackupPreferences();

            if (autoBackupEnabled) {
                startAutoBackup();
                showNotification('Auto-backup enabled', 'success');
            } else {
                stopAutoBackup();
                showNotification('Auto-backup disabled');
            }

            updateAutoBackupStatusDisplay();
        }

        function updateAutoBackupInterval() {
            const select = document.getElementById('autoBackupInterval');
            autoBackupIntervalMinutes = parseInt(select.value);
            saveAutoBackupPreferences();

            if (autoBackupEnabled) {
                stopAutoBackup();
                startAutoBackup();
            }

            updateAutoBackupStatusDisplay();
        }

        function saveAutoBackupPreferences() {
            localStorage.setItem('schoolDashboardAutoBackup', JSON.stringify({
                enabled: autoBackupEnabled,
                interval: autoBackupIntervalMinutes
            }));
        }

        function startAutoBackup() {
            stopAutoBackup();
            if (!isCloudConnected || !autoBackupEnabled) return;

            const intervalMs = autoBackupIntervalMinutes * 60 * 1000;
            autoBackupTimer = setInterval(async () => {
                if (!isCloudConnected || !googleAccessToken) {
                    stopAutoBackup();
                    return;
                }

                console.log('Auto-backup triggered at', new Date().toLocaleTimeString());

                try {
                    await performSilentBackup();
                    lastAutoBackupTime = new Date();
                    localStorage.setItem('schoolDashboardLastAutoBackup', lastAutoBackupTime.toISOString());
                    updateAutoBackupStatusDisplay();
                    showNotification('Auto-backup saved to cloud', 'success');
                } catch (error) {
                    console.error('Auto-backup failed:', error);
                }
            }, intervalMs);

            console.log(`Auto-backup started: every ${autoBackupIntervalMinutes} minutes`);
        }

        function stopAutoBackup() {
            if (autoBackupTimer) {
                clearInterval(autoBackupTimer);
                autoBackupTimer = null;
            }
        }

        function updateAutoBackupStatusDisplay() {
            const statusEl = document.getElementById('autoBackupStatus');
            if (!statusEl) return;

            if (autoBackupEnabled) {
                let statusText = `Auto-backup is enabled (every ${autoBackupIntervalMinutes} min)`;
                if (lastAutoBackupTime) {
                    statusText += `  Last: ${getTimeAgo(lastAutoBackupTime)}`;
                }
                if (autoBackupTimer) {
                    statusText += '  Running';
                }
                statusEl.innerHTML = `<span style="color: var(--success);"></span> ${statusText}`;
            } else {
                statusEl.innerHTML = '<span style="color: var(--gray-500);"></span> Auto-backup is disabled';
            }
        }

        // Silent backup (no prompts/alerts) for auto-backup
        async function performSilentBackup() {
            let existingCloudData = null;
            if (cloudFileId) {
                try {
                    existingCloudData = await downloadCloudBackup();
                } catch (e) {
                    console.log('No existing cloud data for silent backup');
                }
            }

            const mergedData = applyMergeToCloud(existingCloudData);

            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                savedBy: currentUser ? currentUser.username : 'Auto-Backup',
                data: mergedData
            };

            const jsonContent = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });

            let response;

            if (cloudFileId) {
                response = await fetch(
                    `https://www.googleapis.com/upload/drive/v3/files/${cloudFileId}?uploadType=media`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: blob
                    }
                );
            } else {
                const metadata = {
                    name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,
                    parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
                    mimeType: 'application/json'
                };

                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', blob);

                response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` },
                        body: formData
                    }
                );

                if (response.ok) {
                    const result = await response.json();
                    cloudFileId = result.id;
                    localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
                }
            }

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Silent backup failed');
            }

            lastSyncTime = new Date();
            localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
            updateLastSyncDisplay();

            lastSavedBy = currentUser ? currentUser.username : 'Auto-Backup';
            cloudFileTimestamp = new Date().toISOString();
            updateLastSavedByDisplay();
        }

        // ==========================================
        // Backup Version History
        // ==========================================

        async function createVersionedBackup() {
            if (!isCurrentUserAdmin()) {
                showNotification('Only administrators can create backup snapshots', 'error');
                return;
            }
            if (!isCloudConnected || !googleAccessToken) {
                showNotification('Please connect to Google Drive first', 'error');
                return;
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const versionFileName = `CESTIS_BACKUP_${timestamp}.json`;

            if (!confirm(`Create a backup snapshot?\n\nFile: ${versionFileName}\n\nThis creates a timestamped copy of your current data in Google Drive.`)) {
                return;
            }

            setCloudSyncing(true);

            try {
                const backupData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    savedBy: currentUser ? currentUser.username : 'Unknown',
                    snapshotName: versionFileName,
                    data: {
                        users: users,
                        quickLinks: quickLinks,
                        mainLinks: mainLinks,
                        schoolSettings: schoolSettings,
                        quickLinkApprovals: quickLinkApprovals,
                        mainLinkApprovals: mainLinkApprovals,
                        deletedQuickLinkKeys: deletedQuickLinkKeys,
                        deletedMainLinkKeys: deletedMainLinkKeys
                    }
                };

                const jsonContent = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });

                const metadata = {
                    name: versionFileName,
                    parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
                    mimeType: 'application/json'
                };

                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', blob);

                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,modifiedTime',
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` },
                        body: formData
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Failed to create snapshot');
                }

                setCloudSyncing(false);
                showNotification(`Snapshot created: ${versionFileName}`, 'success');
                loadVersionHistory();

            } catch (error) {
                console.error('Error creating versioned backup:', error);
                setCloudSyncing(false);
                showNotification(`Failed to create snapshot: ${error.message}`, 'error');
            }
        }

        async function loadVersionHistory() {
            const container = document.getElementById('versionHistoryList');
            if (!container) return;

            if (!isCloudConnected || !googleAccessToken) {
                container.innerHTML = '<div class="storage-empty-state"><div class="empty-icon"></div><p>Connect to Google Drive to view history</p></div>';
                return;
            }

            container.innerHTML = '<div class="storage-empty-state"><div class="empty-icon spinning"></div><p>Loading version history...</p></div>';

            try {
                const query = `'${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and mimeType='application/json' and trashed=false`;
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime desc&pageSize=50`,
                    {
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to list files');

                const data = await response.json();
                const files = data.files || [];

                if (files.length === 0) {
                    container.innerHTML = '<div class="storage-empty-state"><div class="empty-icon"></div><p>No backup versions found. Create a snapshot to get started.</p></div>';
                    return;
                }

                // Fetch savedBy metadata for each file
                const filesWithMeta = await Promise.all(files.map(async (file) => {
                    try {
                        const contentResp = await fetch(
                            `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,
                            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
                        );
                        if (contentResp.ok) {
                            const content = await contentResp.json();
                            return {
                                ...file,
                                savedBy: content.savedBy || 'Unknown',
                                backupTimestamp: content.timestamp,
                                isValid: !!(content.version && content.data)
                            };
                        }
                    } catch (e) { /* ignore */ }
                    return { ...file, savedBy: 'Unknown', backupTimestamp: file.modifiedTime, isValid: false };
                }));

                let html = '';
                filesWithMeta.forEach(file => {
                    const modDate = new Date(file.modifiedTime);
                    const dateStr = modDate.toLocaleDateString() + ' ' + modDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const sizeStr = formatFileSize(parseInt(file.size || 0));
                    const isMainBackup = file.name === GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME;
                    const icon = isMainBackup ? '' : '';
                    const badge = isMainBackup
                        ? '<span style="background: var(--primary); color: white; padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">Active</span>'
                        : (file.isValid ? '' : '<span style="background: var(--warning); color: white; padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">Unknown</span>');

                    html += `
                        <div class="version-item">
                            <span class="version-item-icon">${icon}</span>
                            <div class="version-item-info">
                                <div class="version-item-name">${escapeHtml(file.name)}${badge}</div>
                                <div class="version-item-meta">${dateStr}  ${sizeStr}  by ${escapeHtml(file.savedBy)}</div>
                            </div>
                            <div class="version-item-actions">
                                <button class="version-action-btn" onclick="restoreVersion('${file.id}', '${escapeHtml(file.name).replace(/'/g, "\\'")}')">
                                     Restore
                                </button>
                                <button class="version-action-btn" onclick="downloadVersionFile('${file.id}', '${escapeHtml(file.name).replace(/'/g, "\\'")}')">
                                     Download
                                </button>
                                ${!isMainBackup ? `<button class="version-action-btn danger" onclick="deleteVersionFile('${file.id}', '${escapeHtml(file.name).replace(/'/g, "\\'")}')"></button>` : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading version history:', error);
                container.innerHTML = `<div class="storage-empty-state"><div class="empty-icon"></div><p>Failed to load: ${error.message}</p></div>`;
            }
        }

        async function restoreVersion(fileId, fileName) {
            if (!isCurrentUserAdmin()) {
                showNotification('Only administrators can restore backups', 'error');
                return;
            }
            if (!confirm(` Restore from "${fileName}"?\n\nCloud data will be merged into your local data.\nNo local data will be lost.`)) {
                return;
            }

            setCloudSyncing(true);

            try {
                const backupData = await downloadCloudBackup(fileId);
                applyMergeFromCloud(backupData);

                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                lastSavedBy = backupData.savedBy || 'Unknown';
                cloudFileTimestamp = backupData.timestamp;
                updateLastSavedByDisplay();

                loadSchoolSettings();
                renderQuickLinks();
                renderMainLinks();

                setCloudSyncing(false);
                showNotification(`Restored from: ${fileName}`, 'success');

            } catch (error) {
                console.error('Error restoring version:', error);
                setCloudSyncing(false);
                showNotification(`Failed to restore: ${error.message}`, 'error');
            }
        }

        async function downloadVersionFile(fileId, fileName) {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
                );

                if (!response.ok) throw new Error('Download failed');

                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification(`Downloaded: ${fileName}`, 'success');
            } catch (error) {
                console.error('Error downloading version:', error);
                showNotification(`Download failed: ${error.message}`, 'error');
            }
        }

        async function deleteVersionFile(fileId, fileName) {
            if (!isCurrentUserAdmin()) {
                showNotification('Only administrators can delete backup files', 'error');
                return;
            }
            if (!confirm(` Delete "${fileName}"?\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                    }
                );

                if (!response.ok && response.status !== 204) {
                    throw new Error('Delete failed');
                }

                showNotification(`Deleted: ${fileName}`, 'success');
                loadVersionHistory();
                refreshStorageDashboard();

            } catch (error) {
                console.error('Error deleting version:', error);
                showNotification(`Delete failed: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // File Upload to Google Drive
        // ==========================================

        // Drag and drop support
        function initFileUploadZone() {
            const zone = document.getElementById('fileUploadZone');
            if (!zone) return;

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    uploadFilesToDrive(e.dataTransfer.files);
                }
            });
        }

        function handleDriveFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                uploadFilesToDrive(files);
            }
            event.target.value = '';
        }

        async function uploadFilesToDrive(files) {
            if (!isCurrentUserAdmin()) {
                showNotification('Only administrators can upload files to Drive', 'error');
                return;
            }
            if (!isCloudConnected || !googleAccessToken) {
                showNotification('Please connect to Google Drive first', 'error');
                return;
            }

            const maxSize = 10 * 1024 * 1024; // 10MB
            const progressArea = document.getElementById('uploadProgressArea');
            const progressText = document.getElementById('uploadProgressText');
            const progressFill = document.getElementById('uploadProgressFill');

            progressArea.style.display = 'block';

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                if (file.size > maxSize) {
                    showNotification(`${file.name} exceeds 10MB limit`, 'error');
                    failCount++;
                    continue;
                }

                progressText.textContent = `Uploading ${file.name} (${i + 1}/${files.length})...`;
                progressFill.style.width = `${((i) / files.length) * 100}%`;

                try {
                    const metadata = {
                        name: file.name,
                        parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID]
                    };

                    const formData = new FormData();
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    formData.append('file', file);

                    const response = await fetch(
                        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
                        {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${googleAccessToken}` },
                            body: formData
                        }
                    );

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'Upload failed');
                    }

                    successCount++;
                } catch (error) {
                    console.error(`Failed to upload ${file.name}:`, error);
                    failCount++;
                }
            }

            progressFill.style.width = '100%';
            progressText.textContent = 'Upload complete!';

            setTimeout(() => {
                progressArea.style.display = 'none';
                progressFill.style.width = '0%';
            }, 2000);

            if (successCount > 0) {
                showNotification(`Uploaded ${successCount} file(s) successfully`, 'success');
                loadUploadedFiles();
                refreshStorageDashboard();
            }
            if (failCount > 0) {
                showNotification(`${failCount} file(s) failed to upload`, 'error');
            }
        }

        // ==========================================
        // File Manager  Browse, Download, Delete
        // ==========================================

        async function loadUploadedFiles() {
            const container = document.getElementById('uploadedFilesList');
            if (!container) return;

            if (!isCloudConnected || !googleAccessToken) {
                container.innerHTML = '<div class="storage-empty-state"><div class="empty-icon"></div><p>Connect to Google Drive to view files</p></div>';
                return;
            }

            container.innerHTML = '<div class="storage-empty-state"><div class="empty-icon spinning"></div><p>Loading files...</p></div>';

            try {
                const query = `'${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,mimeType,size,modifiedTime,webViewLink,webContentLink)&orderBy=modifiedTime desc&pageSize=100`,
                    {
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                    }
                );

                if (!response.ok) throw new Error('Failed to list files');

                const data = await response.json();
                const files = data.files || [];

                if (files.length === 0) {
                    container.innerHTML = '<div class="storage-empty-state"><div class="empty-icon"></div><p>No files found. Upload some documents to get started.</p></div>';
                    return;
                }

                let html = '';
                files.forEach(file => {
                    const icon = getFileTypeIcon(file.mimeType, file.name);
                    const iconClass = getFileTypeClass(file.mimeType, file.name);
                    const modDate = new Date(file.modifiedTime);
                    const dateStr = modDate.toLocaleDateString() + ' ' + modDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const sizeStr = formatFileSize(parseInt(file.size || 0));
                    const isBackupFile = file.name.startsWith('CESTIS_') && file.mimeType === 'application/json';

                    html += `
                        <div class="uploaded-file-item">
                            <div class="file-type-icon ${iconClass}">${icon}</div>
                            <div class="file-item-info">
                                <div class="file-item-name">${escapeHtml(file.name)}</div>
                                <div class="file-item-meta">${dateStr}  ${sizeStr}</div>
                            </div>
                            <div class="file-item-actions">
                                ${file.webViewLink ? `<button class="version-action-btn" onclick="window.open('${file.webViewLink}', '_blank')" title="View in Drive"></button>` : ''}
                                <button class="version-action-btn" onclick="downloadDriveFile('${file.id}', '${escapeHtml(file.name).replace(/'/g, "\\'")}', '${file.mimeType}')" title="Download"></button>
                                <button class="version-action-btn" onclick="copyDriveShareLink('${file.id}')" title="Copy share link"></button>
                                ${!isBackupFile ? `<button class="version-action-btn danger" onclick="deleteDriveFile('${file.id}', '${escapeHtml(file.name).replace(/'/g, "\\'")}')" title="Delete"></button>` : ''}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading uploaded files:', error);
                container.innerHTML = `<div class="storage-empty-state"><div class="empty-icon"></div><p>Failed to load files: ${error.message}</p></div>`;
            }
        }

        async function downloadDriveFile(fileId, fileName, mimeType) {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
                );

                if (!response.ok) throw new Error('Download failed');

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification(`Downloaded: ${fileName}`, 'success');
            } catch (error) {
                console.error('Error downloading file:', error);
                showNotification(`Download failed: ${error.message}`, 'error');
            }
        }

        async function copyDriveShareLink(fileId) {
            try {
                // Get the webViewLink for the file
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?fields=webViewLink,webContentLink`,
                    { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
                );

                if (!response.ok) throw new Error('Failed to get share link');

                const fileData = await response.json();
                const link = fileData.webViewLink || fileData.webContentLink;

                if (link) {
                    await navigator.clipboard.writeText(link);
                    showNotification('Share link copied to clipboard!', 'success');
                } else {
                    showNotification('No share link available for this file', 'error');
                }
            } catch (error) {
                console.error('Error copying share link:', error);
                showNotification(`Failed to copy link: ${error.message}`, 'error');
            }
        }

        async function deleteDriveFile(fileId, fileName) {
            if (!isCurrentUserAdmin()) {
                showNotification('Only administrators can delete files from Drive', 'error');
                return;
            }
            if (!confirm(` Delete "${fileName}" from Google Drive?\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                    }
                );

                if (!response.ok && response.status !== 204) {
                    throw new Error('Delete failed');
                }

                showNotification(`Deleted: ${fileName}`, 'success');
                loadUploadedFiles();
                refreshStorageDashboard();

            } catch (error) {
                console.error('Error deleting file:', error);
                showNotification(`Delete failed: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // Utility Functions for Cloud Storage
        // ==========================================

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getFileTypeIcon(mimeType, fileName) {
            if (!mimeType) return '';

            if (mimeType.startsWith('image/')) return '';
            if (mimeType === 'application/pdf') return '';
            if (mimeType.includes('spreadsheet') || mimeType.includes('excel') || fileName.match(/\.(xlsx?|csv)$/i)) return '';
            if (mimeType.includes('presentation') || mimeType.includes('powerpoint') || fileName.match(/\.(pptx?)$/i)) return '';
            if (mimeType.includes('document') || mimeType.includes('word') || fileName.match(/\.(docx?)$/i)) return '';
            if (mimeType === 'application/json') return '';
            if (mimeType.startsWith('video/')) return '';
            if (mimeType.startsWith('audio/')) return '';
            if (mimeType.includes('zip') || mimeType.includes('compressed') || mimeType.includes('archive')) return '';
            return '';
        }

        function getFileTypeClass(mimeType, fileName) {
            if (!mimeType) return 'other';

            if (mimeType.startsWith('image/')) return 'img';
            if (mimeType === 'application/pdf') return 'pdf';
            if (mimeType.includes('spreadsheet') || mimeType.includes('excel') || (fileName && fileName.match(/\.(xlsx?|csv)$/i))) return 'sheet';
            if (mimeType.includes('document') || mimeType.includes('word') || mimeType === 'application/json' || (fileName && fileName.match(/\.(docx?)$/i))) return 'doc';
            return 'other';
        }

        // Load Cloud Storage tab data when tab is switched to (admin only)
        function onCloudStorageTabActivated() {
            if (!isCurrentUserAdmin()) {
                showNotification('Cloud Storage is only available to administrators', 'error');
                return;
            }
            updateCloudStorageTabUI();
            if (isCloudConnected) {
                refreshStorageDashboard();
                loadVersionHistory();
                loadUploadedFiles();
                initFileUploadZone();
            }
        }

        // Update last sync display
        function updateLastSyncDisplay() {
            const lastSyncInfo = document.getElementById('lastSyncInfo');
            if (lastSyncTime) {
                const timeAgo = getTimeAgo(lastSyncTime);
                lastSyncInfo.textContent = `Last merge: ${timeAgo}`;
            } else {
                lastSyncInfo.textContent = 'Last merge: Never';
            }
        }

        // Update last saved by display
        function updateLastSavedByDisplay() {
            const lastSavedByInfo = document.getElementById('lastSavedByInfo');
            if (lastSavedByInfo) {
                if (lastSavedBy && cloudFileTimestamp) {
                    const timeAgo = getTimeAgo(new Date(cloudFileTimestamp));
                    lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy} (${timeAgo})`;
                } else if (lastSavedBy) {
                    lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy}`;
                } else {
                    lastSavedByInfo.textContent = 'Last saved by: --';
                }
            }
        }

        // Get human-readable time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }

        // ============================================
        // FILE BROWSER & SELECTIVE SYNC FUNCTIONALITY
        // ============================================

        // Browse all backup files in the shared folder
        async function browseBackupFiles() {
            if (!isCloudConnected || !googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            const menu = document.getElementById('cloudDropdownMenu');
            menu.classList.remove('show');

            setCloudSyncing(true);

            try {
                const files = await listBackupFilesInFolder();
                setCloudSyncing(false);

                if (files.length === 0) {
                    alert(' No backup files found in the shared folder.\n\nMake sure the folder is shared with your account and contains JSON backup files.');
                    return;
                }

                showFileBrowserModal(files);
            } catch (error) {
                console.error('Error browsing backup files:', error);
                setCloudSyncing(false);

                if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
                    alert(' Your session has expired. Please reconnect to Google Drive.');
                    disconnectFromGoogleDrive();
                } else {
                    alert(` Failed to browse files: ${error.message}`);
                }
            }
        }

        // List all JSON backup files in the shared folder
        async function listBackupFilesInFolder() {
            // Search for all JSON files in the shared folder
            const query = `'${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and mimeType='application/json' and trashed=false`;

            const response = await fetch(
                `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime,size,owners,sharingUser)&orderBy=modifiedTime desc`,
                {
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    }
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Failed to list files');
            }

            const data = await response.json();

            // For each file, try to get additional metadata (savedBy info)
            const filesWithMetadata = await Promise.all(
                data.files.map(async (file) => {
                    try {
                        const contentResponse = await fetch(
                            `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,
                            {
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken}`
                                }
                            }
                        );

                        if (contentResponse.ok) {
                            const content = await contentResponse.json();
                            return {
                                ...file,
                                savedBy: content.savedBy || 'Unknown',
                                backupTimestamp: content.timestamp,
                                hasValidFormat: content.version && content.data
                            };
                        }
                    } catch (e) {
                        console.warn('Could not read metadata for file:', file.name);
                    }

                    return {
                        ...file,
                        savedBy: 'Unknown',
                        backupTimestamp: file.modifiedTime,
                        hasValidFormat: false
                    };
                })
            );

            return filesWithMetadata;
        }

        // Show file browser modal
        function showFileBrowserModal(files) {
            const existingModal = document.getElementById('fileBrowserModal');
            if (existingModal) {
                existingModal.remove();
            }

            const fileListHTML = files.map(file => {
                const modifiedDate = new Date(file.modifiedTime);
                const timeAgo = getTimeAgo(modifiedDate);
                const dateFormatted = modifiedDate.toLocaleDateString() + ' ' + modifiedDate.toLocaleTimeString();
                const validBadge = file.hasValidFormat
                    ? '<span style="background: var(--success); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;">Valid</span>'
                    : '<span style="background: var(--warning); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px;">Unknown Format</span>';

                return `
                    <div class="backup-file-item" onclick="selectBackupFile('${file.id}', '${file.name.replace(/'/g, "\\'")}')">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary);">
                                    ${file.name}${validBadge}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                                    <span> ${dateFormatted}</span>
                                    <span style="margin-left: 16px;"> Saved by: ${file.savedBy}</span>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 2px;">
                                    Modified ${timeAgo}
                                </div>
                            </div>
                            <span style="color: var(--accent); font-size: 1.2rem;"></span>
                        </div>
                    </div>
                `;
            }).join('');

            const modalHTML = `
                <div id="fileBrowserModal" class="google-auth-modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
                        <div class="modal-header">
                            <h2> Browse Backup Files</h2>
                            <button class="close-btn" onclick="closeFileBrowserModal()"></button>
                        </div>
                        <div style="padding: var(--space-4);">
                            <p style="margin-bottom: var(--space-4); color: var(--text-secondary);">
                                Select a backup file to sync from. Files are sorted by most recent first.
                            </p>
                            <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-4);">
                                <strong style="color: var(--info);"> Tip:</strong>
                                <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Files shared with your account from other users will appear here. You can sync data from any shared backup.
                                </span>
                            </div>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-light); border-radius: var(--radius-md);">
                                ${fileListHTML}
                            </div>
                            <div style="margin-top: var(--space-4); text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                                Found ${files.length} backup file${files.length !== 1 ? 's' : ''} in shared folder
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    .backup-file-item {
                        padding: var(--space-4);
                        border-bottom: 1px solid var(--border-light);
                        cursor: pointer;
                        transition: background-color 0.2s;
                    }
                    .backup-file-item:hover {
                        background-color: var(--bg-hover);
                    }
                    .backup-file-item:last-child {
                        border-bottom: none;
                    }
                </style>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close file browser modal
        function closeFileBrowserModal() {
            const modal = document.getElementById('fileBrowserModal');
            if (modal) {
                modal.remove();
            }
        }

        // Select a backup file and show selective sync options
        async function selectBackupFile(fileId, fileName) {
            closeFileBrowserModal();
            setCloudSyncing(true);

            try {
                // Download the file content
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                    {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to download backup file');
                }

                const backupData = await response.json();
                setCloudSyncing(false);

                // Validate backup format
                if (!backupData.data || !backupData.version) {
                    alert(' Invalid backup file format. This file does not contain valid dashboard backup data.');
                    return;
                }

                // Show selective sync modal
                showSelectiveSyncModal(backupData, fileId, fileName);

            } catch (error) {
                console.error('Error loading backup file:', error);
                setCloudSyncing(false);
                alert(` Failed to load backup file: ${error.message}`);
            }
        }

        // Show selective sync modal
        function showSelectiveSyncModal(backupData, fileId, fileName) {
            const existingModal = document.getElementById('selectiveSyncModal');
            if (existingModal) {
                existingModal.remove();
            }

            const backupTime = new Date(backupData.timestamp).toLocaleString();
            const savedBy = backupData.savedBy || 'Unknown';

            // Count items in each category
            const userCount = backupData.data.users ? backupData.data.users.length : 0;
            const quickLinksCount = backupData.data.quickLinks ? backupData.data.quickLinks.length : 0;
            const mainLinksCount = backupData.data.mainLinks ? backupData.data.mainLinks.length : 0;
            const hasSettings = backupData.data.schoolSettings ? true : false;

            const modalHTML = `
                <div id="selectiveSyncModal" class="google-auth-modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 550px;">
                        <div class="modal-header">
                            <h2> Selective Merge</h2>
                            <button class="close-btn" onclick="closeSelectiveSyncModal()"></button>
                        </div>
                        <div style="padding: var(--space-5);">
                            <div style="background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-5);">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-2);">
                                     ${fileName}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    <span> ${backupTime}</span>
                                    <span style="margin-left: 16px;"> Saved by: ${savedBy}</span>
                                </div>
                            </div>

                            <p style="margin-bottom: var(--space-4); color: var(--text-secondary);">
                                Choose which data you want to merge from this backup:
                            </p>

                            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                                <label class="sync-option-item" style="${userCount === 0 ? 'opacity: 0.5;' : ''}">
                                    <input type="checkbox" id="syncUsers" ${userCount > 0 ? 'checked' : 'disabled'}>
                                    <span class="sync-option-label">
                                        <span style="font-size: 1.2rem;"></span>
                                        <span>
                                            <strong>Users</strong>
                                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 8px;">(${userCount} user${userCount !== 1 ? 's' : ''})</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="sync-option-item" style="${quickLinksCount === 0 ? 'opacity: 0.5;' : ''}">
                                    <input type="checkbox" id="syncQuickLinks" ${quickLinksCount > 0 ? 'checked' : 'disabled'}>
                                    <span class="sync-option-label">
                                        <span style="font-size: 1.2rem;"></span>
                                        <span>
                                            <strong>Quick Links</strong>
                                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 8px;">(${quickLinksCount} link${quickLinksCount !== 1 ? 's' : ''})</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="sync-option-item" style="${mainLinksCount === 0 ? 'opacity: 0.5;' : ''}">
                                    <input type="checkbox" id="syncMainLinks" ${mainLinksCount > 0 ? 'checked' : 'disabled'}>
                                    <span class="sync-option-label">
                                        <span style="font-size: 1.2rem;"></span>
                                        <span>
                                            <strong>Main Links</strong>
                                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 8px;">(${mainLinksCount} link${mainLinksCount !== 1 ? 's' : ''})</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="sync-option-item" style="${!hasSettings ? 'opacity: 0.5;' : ''}">
                                    <input type="checkbox" id="syncSettings" ${hasSettings ? 'checked' : 'disabled'}>
                                    <span class="sync-option-label">
                                        <span style="font-size: 1.2rem;"></span>
                                        <span>
                                            <strong>School Settings</strong>
                                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 8px;">(name, logo, theme)</span>
                                        </span>
                                    </span>
                                </label>
                            </div>

                            <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-3); margin-top: var(--space-5); margin-bottom: var(--space-4);">
                                <strong style="color: var(--info);"> Safe merge:</strong>
                                <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Selected cloud data will be <strong>merged</strong> with your local data. No local data will be lost.
                                </span>
                            </div>

                            <div style="display: flex; gap: var(--space-3);">
                                <button class="btn btn-secondary" onclick="closeSelectiveSyncModal()" style="flex: 1;">
                                    Cancel
                                </button>
                                <button class="btn btn-success" onclick="performSelectiveSync('${fileId}')" style="flex: 1;">
                                     Merge Selected Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    .sync-option-item {
                        display: flex;
                        align-items: center;
                        gap: var(--space-3);
                        padding: var(--space-3);
                        background: var(--bg-secondary);
                        border: 1px solid var(--border-light);
                        border-radius: var(--radius-md);
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .sync-option-item:hover {
                        border-color: var(--accent);
                        background: var(--bg-hover);
                    }
                    .sync-option-item input[type="checkbox"] {
                        width: 20px;
                        height: 20px;
                        accent-color: var(--accent);
                    }
                    .sync-option-label {
                        display: flex;
                        align-items: center;
                        gap: var(--space-2);
                    }
                </style>
            `;

            // Store backup data for later use
            window.pendingBackupData = backupData;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close selective sync modal
        function closeSelectiveSyncModal() {
            const modal = document.getElementById('selectiveSyncModal');
            if (modal) {
                modal.remove();
            }
            window.pendingBackupData = null;
        }

        // Perform selective merge based on user selections
        async function performSelectiveSync(fileId) {
            const backupData = window.pendingBackupData;
            if (!backupData) {
                alert(' Backup data not found. Please try again.');
                closeSelectiveSyncModal();
                return;
            }

            const syncUsers = document.getElementById('syncUsers').checked;
            const syncQuickLinks = document.getElementById('syncQuickLinks').checked;
            const syncMainLinks = document.getElementById('syncMainLinks').checked;
            const syncSettings = document.getElementById('syncSettings').checked;

            if (!syncUsers && !syncQuickLinks && !syncMainLinks && !syncSettings) {
                alert('Please select at least one data type to merge.');
                return;
            }

            // Build confirmation message
            let selectedItems = [];
            if (syncUsers) selectedItems.push('Users');
            if (syncQuickLinks) selectedItems.push('Quick Links');
            if (syncMainLinks) selectedItems.push('Main Links');
            if (syncSettings) selectedItems.push('School Settings');

            if (!confirm(` You are about to merge the following data from cloud:\n\n ${selectedItems.join('\n ')}\n\nNew items will be added. Your existing local data will be preserved.\n\nContinue?`)) {
                return;
            }

            closeSelectiveSyncModal();
            setCloudSyncing(true);

            try {
                // Perform selective merge (local data preserved, cloud items added)
                if (syncUsers && backupData.data.users) {
                    users = mergeUsers(users, backupData.data.users);
                    saveUsers();
                }

                // Merge deleted keys from backup
                if (backupData.data.deletedQuickLinkKeys) {
                    for (const key of backupData.data.deletedQuickLinkKeys) {
                        if (!deletedQuickLinkKeys.includes(key)) deletedQuickLinkKeys.push(key);
                    }
                    localStorage.setItem('deletedQuickLinkKeys', JSON.stringify(deletedQuickLinkKeys));
                }
                if (backupData.data.deletedMainLinkKeys) {
                    for (const key of backupData.data.deletedMainLinkKeys) {
                        if (!deletedMainLinkKeys.includes(key)) deletedMainLinkKeys.push(key);
                    }
                    localStorage.setItem('deletedMainLinkKeys', JSON.stringify(deletedMainLinkKeys));
                }

                if (syncQuickLinks && backupData.data.quickLinks) {
                    quickLinks = mergeArrayByKey(quickLinks, backupData.data.quickLinks, linkKey, deletedQuickLinkKeys);
                    localStorage.setItem('quickLinks', JSON.stringify(quickLinks));
                    // Also merge quick link approvals with quick links
                    if (backupData.data.quickLinkApprovals) {
                        quickLinkApprovals = mergeApprovals(quickLinkApprovals, backupData.data.quickLinkApprovals);
                        localStorage.setItem('quickLinkApprovals', JSON.stringify(quickLinkApprovals));
                    }
                }

                if (syncMainLinks && backupData.data.mainLinks) {
                    mainLinks = mergeArrayByKey(mainLinks, backupData.data.mainLinks, linkKey, deletedMainLinkKeys);
                    localStorage.setItem('mainLinks', JSON.stringify(mainLinks));
                    // Also merge main link approvals with main links
                    if (backupData.data.mainLinkApprovals) {
                        mainLinkApprovals = mergeApprovals(mainLinkApprovals, backupData.data.mainLinkApprovals);
                        localStorage.setItem('mainLinkApprovals', JSON.stringify(mainLinkApprovals));
                    }
                }

                if (syncSettings && backupData.data.schoolSettings) {
                    schoolSettings = mergeSettings(schoolSettings, backupData.data.schoolSettings);
                    localStorage.setItem('schoolSettings', JSON.stringify(schoolSettings));
                }

                // Update sync tracking
                lastSyncTime = new Date();
                localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
                updateLastSyncDisplay();

                // Update last saved by info
                lastSavedBy = backupData.savedBy || 'Unknown';
                cloudFileTimestamp = backupData.timestamp;
                updateLastSavedByDisplay();

                // Cache the file ID if this becomes our primary sync file
                cloudFileId = fileId;
                localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);

                // Refresh UI
                loadSchoolSettings();
                renderQuickLinks();
                renderMainLinks();

                setCloudSyncing(false);

                const mergedItems = selectedItems.join(', ');
                alert(` Selective merge completed!\n\nMerged: ${mergedItems}\n\nFrom backup saved by: ${lastSavedBy}\n\n Your local data has been preserved.`);

            } catch (error) {
                console.error('Error performing selective merge:', error);
                setCloudSyncing(false);
                alert(` Failed to merge data: ${error.message}`);
            }
        }
    </script>
</body>
</html>
